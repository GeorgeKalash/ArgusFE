"use strict";exports.id=58806,exports.ids=[58806],exports.modules={58806:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.d(r,{Z:()=>J});var n=t(20997),s=t(99155),d=t.n(s),o=t(16689),l=t(75609),i=t(80582),c=t(86201),u=t(29352),m=t(38509),h=t(6416),p=t(44619),y=t(18611),I=t(23385),C=t(95965),f=t(79660),x=t(71278),v=t(27736),k=t(79390),b=t(91184),w=t(68728),g=t(86794),j=t(60520),N=t(54242),F=t(15051),q=t(59636),W=t(42020),S=t(65980),O=t(61274),V=t(70305),R=t(677),Q=t(66559),Z=t(96119),A=t(38782),D=e([i,c,u,m,x,g,j,F,O,V,R,Q,A]);function J({recordId:e,window:r}){let{stack:t}=(0,R.zY)(),{platformLabels:a}=(0,o.useContext)(j.l),{getRequest:s,postRequest:D}=(0,o.useContext)(u.$),J=(0,o.useRef)([]),{stack:$}=(0,V.V)(),[_,U]=(0,o.useState)([]),[L,M]=(0,o.useState)(!1),{labels:P,access:T}=(0,A.Z)({datasetId:h.i.WorkCenterConsumptions,editMode:!!e});(0,Z.Z)({title:P.workCenterConsumption,window:r});let{documentType:z,maxAccess:E,changeDT:G}=(0,g.H)({functionId:w.J.WorkCenterConsumption,access:T,enabled:!e,objectName:"header"}),H=(0,m.E)({endpointId:q.u.WorkCenterConsumption.page});function K(e){return("qty"===e?l.number().nullable().max(999999999.999," "):l.mixed()).test(function(e){let{sku:r,qty:t,itemName:a}=this.parent;return!r&&!t&&!a||!!e})}let Y=l.object({itemName:K("itemName"),sku:K("sku"),qty:K("qty")}),{formik:B}=(0,C.c)({documentType:{key:"header.dtId",value:z?.dtId,reference:z?.reference},initialValues:{recordId:e,header:{recordId:null,reference:"",dtId:null,date:new Date,plantId:null,siteId:null,workCenterId:null,WcRef:"",WcName:"",weight:0,totalQty:0,description:"",status:1,wip:1},items:[{id:1,seqNo:1,itemId:null,consumptionId:e,qty:0,unitCost:0,muId:null,msId:null,itemName:"",totalCost:0,baseQty:null}]},maxAccess:E,validateOnChange:!0,validationSchema:l.object({header:l.object({date:l.date().required(),workCenterId:l.number().required()}),items:l.array().of(Y)}),onSubmit:async e=>{let{items:r,header:t}=e,n=r?.filter(e=>e.sku)?.map((r,t)=>({...r,seqNo:t+1,consumptionId:e.recordId||0})),s=await D({extension:q.u.WorkCenterConsumption.set2,record:JSON.stringify({header:t,items:n})}),d=e.recordId?a.Edited:a.Added;c.default.success(d),eu(s.recordId),H()}}),X=!!B.values?.recordId,ee=B?.values?.header?.status===3,er=B?.values?.header?.wip===2,et=B.values.items.reduce((e,r)=>e+(Number(r?.totalCost)||0),0),ea=L?B.values.items.reduce((e,r)=>e+(Number(r?.qty)||0),0):B.values?.header.totalQty||0;async function en(e,r){if(!e)return;let t=_?.filter(e=>e.msId==r)||[];J.current=t}let es=async e=>{if(!e)return;let r=await s({extension:q.u.WorkCenterConsumption.get,parameters:`_recordId=${e}`});return{...r?.record,date:(0,k.a1)(r?.record.date)}},ed=async e=>{if(!e)return;let r=await s({extension:q.u.ConsumptionItemView.qry,parameters:`_consumptionId=${e}`});return r?.list?.length>0?r.list.map((e,r)=>({...e,id:r+1,seqNo:r+1})):B.values.items},eo=async()=>{await D({extension:q.u.WorkCenterConsumption.post,record:JSON.stringify(B.values.header)}),c.default.success(a.Posted),H(),r.close()},el=async()=>{await D({extension:q.u.WorkCenterConsumption.unpost,record:JSON.stringify(B.values.header)}),eu(B.values.recordId),c.default.success(a.Unposted),H()},ei=async()=>{await D({extension:q.u.WorkCenterConsumption.close,record:JSON.stringify(B.values.header)}),c.default.success(a.Closed),eu(B.values.recordId),H()},ec=async()=>{await D({extension:q.u.WorkCenterConsumption.reopen,record:JSON.stringify(B.values.header)}),c.default.success(a.Reopened),eu(B.values.recordId),H()};async function eu(e){let r=await es(e),t=await ed(e);B.setValues({...B.values,recordId:r.recordId,header:{...B.values.header,...r},items:t})}let em=async e=>{let r=await s({extension:N.$.CurrentCost.get,parameters:`_itemId=${e}`});return r?.record?.currentCost},eh=[{component:"resourcelookup",label:P.sku,name:"sku",props:{endpointId:N.$.Item.snapshot,valueField:"sku",displayField:"sku",mandatory:!0,readOnly:er,displayFieldWidth:3,mapping:[{from:"recordId",to:"itemId"},{from:"msId",to:"msId"},{from:"sku",to:"sku"},{from:"name",to:"itemName"}],columnsInDropDown:[{key:"sku",value:"SKU"},{key:"name",value:"Name"}]},async onChange({row:{update:e,newRow:r}}){if(!r?.itemId){J.current=[],e({muRef:null,muId:null,baseQty:0,muQty:0,qty:0,totalCost:0});return}if(r.isInactive){e({...B.initialValues.items[0],id:r.id}),$({message:P.inactiveItem});return}if(r?.itemId){en(r?.itemId,r.msId);let t=r?.itemId?await em(r?.itemId):0;e({unitCost:t||0,muRef:J?.current?.[0]?.reference||null,muId:J?.current?.[0]?.recordId||null,muQty:J?.current?.[0]?.qty||0,baseQty:J?.current?.[0]?.qty||r?.qty,qty:r?.qty||0})}}},{component:"textfield",label:P.itemName,name:"itemName",flex:2,props:{readOnly:!0}},{component:"resourcecombobox",label:P.MU,name:"muRef",props:{store:J?.current,displayField:"reference",valueField:"recordId",readOnly:er,mapping:[{from:"reference",to:"muRef"},{from:"name",to:"muName"},{from:"qty",to:"muQty"},{from:"recordId",to:"muId"}]},async onChange({row:{update:e,newRow:r}}){M(!0),r&&(r.muId?e({baseQty:r?.qty?r?.qty*r?.muQty:r?.muQty}):e({baseQty:0}))},propsReducer:({row:e,props:r})=>({...r,store:J?.current})},{component:"numberfield",name:"qty",label:P.qty,async onChange({row:{update:e,newRow:r}}){M(!0),e({totalCost:parseFloat(r?.unitCost*r?.qty).toFixed(2),baseQty:r?.muQty?r?.muQty*r?.qty:r?.qty})},props:{decimalScale:2,readOnly:er}},{component:"numberfield",name:"unitCost",label:P.unitCost,props:{decimalScale:2,readOnly:!0}},{component:"numberfield",name:"totalCost",label:P.totalCost,props:{decimalScale:2,readOnly:!0}}];async function ep(){t({Component:Q.Z,props:{resourceId:h.i.WCConsumptionImport,access:E,onSuccess:async e=>{if(B?.values?.recordId){let e=await es(B?.values.recordId),r=await ed(B?.values.recordId);B.setValues({...B.values,recordId:e.recordId,header:{...B.values.header,...e},items:r}),H()}}}})}let ey=[{key:"Locked",condition:ee,onClick:"onUnpostConfirmation",onSuccess:el,disabled:!er},{key:"Unlocked",condition:!ee,onClick:eo,disabled:!er},{key:"Close",condition:!er,onClick:ei,disabled:er||!X},{key:"Reopen",condition:er,onClick:ec,disabled:!er||ee},{key:"GL",condition:!0,onClick:"onClickGL",valuesPath:{...B.values.header,notes:B.values.header.description},datasetId:h.i.WorkCenterConsumptions,disabled:!X},{key:"Import",condition:!0,onClick:ep,disabled:!X||B.values.items.some(e=>e.itemId)||er}];return n.jsx(i.Z,{form:B,resourceId:h.i.WorkCenterConsumptions,functionId:w.J.WorkCenterConsumption,maxAccess:E,actions:ey,editMode:X,previewReport:X,disabledSubmit:er,children:(0,n.jsxs)(y.R,{children:[n.jsx(W.g,{children:(0,n.jsxs)(d(),{container:!0,spacing:2,xs:12,children:[n.jsx(d(),{item:!0,xs:6,children:(0,n.jsxs)(d(),{container:!0,spacing:2,children:[n.jsx(d(),{item:!0,xs:12,children:n.jsx(x.Z,{endpointId:f.r.DocumentType.qry,parameters:`_startAt=0&_pageSize=1000&_dgId=${w.J.WorkCenterConsumption}`,name:"header.dtId",label:P.docType,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:X,valueField:"recordId",displayField:["reference","name"],values:B.values.header,maxAccess:E,onChange:(e,r)=>{B.setFieldValue("header.dtId",r?.recordId||null),G(r)},error:B.touched.header?.dtId&&!!B.errors.header?.dtId})}),n.jsx(d(),{item:!0,xs:12,children:n.jsx(p.Z,{name:"header.reference",label:P.reference,value:B?.values?.header?.reference,maxAccess:!X&&E,readOnly:X,onChange:B.handleChange,onClear:()=>B.setFieldValue("header.reference",""),error:B.touched.header?.reference&&!!B.errors.header?.reference})}),n.jsx(d(),{item:!0,xs:12,children:n.jsx(v.Z,{name:"header.date",required:!0,readOnly:er,label:P.date,value:B?.values?.header?.date,maxAccess:E,onChange:B.setFieldValue,onClear:()=>B.setFieldValue("header.date",null),error:B.touched?.header?.date&&!!B.errors?.header?.date})}),n.jsx(d(),{item:!0,xs:12,children:n.jsx(x.Z,{endpointId:f.r.Plant.qry,name:"header.plantId",readOnly:er,label:P.plant,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:B.values.header,maxAccess:E,onChange:(e,r)=>{B.setFieldValue("header.plantId",r?.recordId||null)},error:B.touched.header?.plantId&&!!B.errors.header?.plantId})})]})}),n.jsx(d(),{item:!0,xs:6,children:(0,n.jsxs)(d(),{container:!0,spacing:2,children:[n.jsx(d(),{item:!0,xs:12,children:n.jsx(O.U,{endpointId:q.u.WorkCenter.snapshot,valueField:"reference",displayField:"name",name:"header.workCenterId",secondFieldLabel:P.name,label:P.workCenter,valueShow:"WcRef",secondValueShow:"WcName",maxAccess:E,formObject:B.values.header,form:B,displayFieldWidth:2,required:!0,readOnly:er,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"},{key:"siteName",value:"Site Name"}],onSecondValueChange:(e,r)=>{B.setFieldValue("header.WcName",r)},onChange:(e,r)=>{B.setFieldValue("header.WcRef",r?.isInactive?"":r?.reference),B.setFieldValue("header.WcName",r?.isInactive?"":r?.name),B.setFieldValue("header.siteId",r?.isInactive?null:r?.siteId),B.setFieldValue("header.siteRef",r?.isInactive?"":r?.siteRef),B.setFieldValue("header.siteName",r?.isInactive?"":r?.siteName),B.setFieldValue("header.workCenterId",r?.isInactive?null:r?.recordId),r?.isInactive&&$({message:P.inactiveWorkCenter})},error:B.touched.header?.workCenterId&&!!B.errors.header?.workCenterId})}),n.jsx(d(),{item:!0,xs:6,children:n.jsx(p.Z,{name:"header.siteRef",label:P.siteRef,value:B.values.header?.siteRef,readOnly:!0})}),n.jsx(d(),{item:!0,xs:6,children:n.jsx(p.Z,{name:"header.reference",label:P.siteName,value:B.values.header?.siteName,readOnly:!0,maxAccess:E,error:B.touched.header?.siteName&&!!B.errors.header?.siteName})}),n.jsx(d(),{item:!0,xs:12,children:n.jsx(S.Z,{name:"header.description",label:P.description,value:B.values.header.description,rows:2.5,readOnly:er,maxAccess:E,onChange:e=>B.setFieldValue("header.description",e.target.value),onClear:()=>B.setFieldValue("header.description",""),error:B.touched.header?.description&&!!B.errors.header?.description})})]})})]})}),n.jsx(I.Q,{children:n.jsx(F._,{onChange:(e,r)=>{B.setFieldValue("items",e),"delete"===r&&M(!0)},onSelectionChange:(e,r,t)=>{"muRef"==t&&en(e?.itemId,e?.msId)},value:B.values.items,error:B.errors.items,allowDelete:!er,name:"items",columns:eh,maxAccess:E})}),n.jsx(W.g,{children:n.jsx(d(),{container:!0,spacing:2,xs:12,children:n.jsx(d(),{item:!0,xs:4,children:(0,n.jsxs)(d(),{container:!0,spacing:2,children:[n.jsx(d(),{item:!0,xs:12,children:n.jsx(b.Z,{name:"totalQty",maxAccess:E,label:P.totalQty,value:ea,decimalScale:2,readOnly:!0})}),n.jsx(d(),{item:!0,xs:12,children:n.jsx(b.Z,{name:"totalCost",maxAccess:E,label:P.totalCost,value:et,decimalScale:2,readOnly:!0})})]})})})})]})})}[i,c,u,m,x,g,j,F,O,V,R,Q,A]=D.then?(await D)():D,J.width=1200,J.height=700,a()}catch(e){a(e)}})}};