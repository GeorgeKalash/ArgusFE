"use strict";exports.id=60105,exports.ids=[60105],exports.modules={60105:(e,a,t)=>{t.a(e,async(e,n)=>{try{t.d(a,{Z:()=>$});var r=t(20997),s=t(99155),o=t.n(s),l=t(16689),d=t(75609),c=t(80582),u=t(86201),i=t(15051),m=t(29352),p=t(38509),y=t(6416),h=t(44619),x=t(95965),v=t(60520),I=t(18611),f=t(27736),b=t(71278),C=t(79660),k=t(68728),g=t(97969),F=t(66198),A=t(61932),V=t(65980),j=t(86794),N=t(79390),w=t(70638),O=t(677),q=t(93484),P=t(78630),R=t(4902),M=t(19138),S=t(43991),Z=t(42020),T=t(91184),D=t(38782),_=t(96119),H=t(70755),E=e([c,u,i,m,p,v,b,j,w,O,q,P,D]);function $({recordId:e,plantId:a,window:n}){let{getRequest:s,postRequest:E}=(0,l.useContext)(m.$),{platformLabels:$,defaultsData:J,userDefaultsData:L}=(0,l.useContext)(v.l),{stack:G}=(0,O.zY)(),U=parseInt(J?.list?.find(e=>"currencyId"===e.key)?.value),B=parseInt(L?.list?.find(e=>"cashAccountId"===e.key)?.value),{labels:z,access:W}=(0,D.Z)({datasetId:y.i.PaymentVoucherExpenses,editMode:!!e}),{documentType:Y,maxAccess:K,changeDT:Q}=(0,j.H)({functionId:k.J.PaymentVoucher,access:W,enabled:!e});(0,_.Z)({title:z.paymentVoucherExpenses,window:n});let X={recordId:null,reference:"",accountId:"",accountType:3,currencyId:parseInt(U),currencyName:"",paymentMethod:"",date:new Date,glId:null,amount:null,checkNo:"",checkbookId:null,decimals:null,notes:"",exRate:1,rateCalcMethod:1,baseAmount:null,cashAccountId:parseInt(B)||null,dtId:null,status:1,releaseStatus:null,plantId:parseInt(a),contactId:null,isVerified:!1,expenses:[{id:1,pvId:e||0,seqNo:1,etId:"",subtotal:null,vatAmount:null,amount:null,supplierName:"",taxRef:"",notes:"",isVAT:!1,hasCostCenters:!1,costCenters:[]}]},ee=(0,p.E)({endpointId:F.H.PaymentVouchers.page2}),{formik:ea}=(0,x.c)({initialValues:X,maxAccess:K,validateOnChange:!0,documentType:{key:"dtId",value:Y?.dtId},validationSchema:d.object({accountType:d.string().required(),currencyId:d.number().required(),date:d.string().required(),paymentMethod:d.string().required(),cashAccountId:d.string().required(),expenses:d.array().of(d.object().shape({etId:d.number().required(),amount:d.number().required()})).required()}),onSubmit:async a=>{let t=et(a),n=await E({extension:F.H.PaymentVouchers.set2,record:JSON.stringify(t)});e?u.default.success($.Edited):u.default.success($.Added);let r=await ed(n.recordId);r.record.date=(0,N.a1)(r.record.date),await ef(r.record),ee()}}),et=e=>{let a=(0,S.fB)({amount:en,exRate:e?.exRate,baseAmount:0,rateCalcMethod:e?.rateCalcMethod,dirtyField:S.ss}),t={...e};delete t.expenses,t.date=(0,N.ku)(t.date),t.amount=en,t.baseAmount=a?.baseAmount||0;let n=[],r=ea.values.expenses.map((e,a)=>{let{costCenters:t,...r}=e;return t&&n.push(...t),{...r,seqNo:a+1,pvId:ea.values.recordId||0}});return{header:t,items:r,costCenters:n}},en=ea.values?.expenses?.reduce((e,a)=>{let t=parseFloat(a.amount?.toString().replace(/,/g,""))||0;return e+t},0),er=3===ea.values.status,es=-1===ea.values.status,eo=!!ea.values.recordId,el=ea.values.isVerified;async function ed(e){return await s({extension:F.H.PaymentVouchers.get,parameters:`_recordId=${e}`})}let ec=async()=>{try{let e=await E({extension:F.H.PaymentVouchers.post,record:JSON.stringify(ea.values)});u.default.success($.Posted),ee();let a=await ed(e.recordId);a.record.date=(0,N.a1)(a.record.date),await ef(a.record)}catch(e){}};async function eu(){let e=await s({extension:C.r.Defaults.get,parameters:"_filter=&_key=vatPct"}),a=parseInt(e.record.value);ea.setFieldValue("vatPct",a)}let ei=async()=>{G({Component:w.Z,props:{functionId:k.J.PaymentVoucher,recordId:ea.values.recordId}})},em=async()=>{try{let e=await E({extension:F.H.PaymentVouchers.cancel,record:JSON.stringify(ea.values)});u.default.success($.Cancelled),ee();let a=await ed(e.recordId);a.record.date=(0,N.a1)(a.record.date),await ef(a.record)}catch(e){}},ep=async()=>{await E({extension:F.H.PaymentVouchers.verify,record:JSON.stringify(ea.values)})&&(u.default.success(el?$.Unverfied:$.Verified),ee(),n.close())},ey=async()=>{let e=await E({extension:F.H.PaymentVouchers.unpost,record:JSON.stringify(ea.values)});if(e?.recordId){u.default.success($.Unposted),ee();let a=await ed(e.recordId);a.record.date=(0,N.a1)(a.record.date),await ef(a.record)}},eh=async()=>{eu();let e=et(ea.values);await E({extension:F.H.ResetGL_PV.reset,record:JSON.stringify(e)})},ex=[{key:"Locked",condition:er,onClick:"onUnpostConfirmation",onSuccess:ey,disabled:!eo||es||el},{key:"Unlocked",condition:!er,onClick:ec,disabled:!eo||es},{key:"Cancel",condition:!0,onClick:em,disabled:!eo||er||es},{key:"FI Trx",condition:!0,onClick:"onClickIT",disabled:!eo},{key:"GL",condition:!0,onClick:"onClickGL",datasetId:y.i.GLPaymentVoucherExpenses,onReset:eh,disabled:!eo},{key:"RecordRemarks",condition:!0,onClick:"onRecordRemarks",disabled:!eo},{key:"WorkFlow",condition:!0,onClick:ei,disabled:!eo},{key:"Verify",condition:!el,onClick:ep,disabled:!er},{key:"Unverify",condition:el,onClick:ep,disabled:!er}],ev=[{component:"resourcelookup",label:z.expenseType,name:"reference",props:{valueField:"reference",displayField:"reference",displayFieldWidth:4,endpointId:F.H.ExpenseTypes.snapshot,mapping:[{from:"recordId",to:"etId"},{from:"name",to:"etName"},{from:"reference",to:"etRef"}],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:er||es}},{component:"textfield",label:z.expenseName,name:"etName",props:{readOnly:!0}},{component:"checkbox",label:z.isVAT,name:"isVAT",props:{disabled:er||es},async onChange({row:{update:e,newRow:a}}){if(a.isVAT&&a.amount){let t=a.amount*(100/(100+ea.values.vatPct));e({subtotal:t.toFixed(2),vatAmount:(a.amount-t).toFixed(2)})}else e({subtotal:a.amount,vatAmount:0})}},{component:"numberfield",label:z.amount,name:"amount",props:{readOnly:er||es},async onChange({row:{update:e,newRow:a}}){if(a.isVAT){let t=a.amount*(100/(100+ea.values.vatPct));e({subtotal:t.toFixed(2),vatAmount:(a.amount-t).toFixed(2)})}else e({subtotal:a.amount,vatAmount:0})}},{component:"numberfield",label:z.vat,name:"vatAmount",props:{readOnly:!0}},{component:"numberfield",label:z.subtotal,name:"subtotal",props:{readOnly:!0}},{component:"textfield",label:z.vendorName,name:"supplierName",props:{readOnly:er||es}},{component:"numberfield",label:z.vatNo,name:"taxRef",props:{readOnly:er||es}},{component:"textfield",label:z.notes,name:"notes",props:{readOnly:er||es}},{component:"button",name:"hasCostCenters",props:{imgSrc:t(54471).default.src},label:z.costCenter,onClick:(a,t,n,r)=>{G({Component:q.Z,props:{maxAccess:K,labels:z,recordId:e,row:t,updateRow:r,readOnly:er||es}})}}],eI=async(e,a)=>(await s({extension:F.H.PaymentVoucherCostCenters.qry,parameters:`_pvId=${e}&_seqNo=${a}`})).list.map(e=>({...e,id:e.ccSeqNo})),ef=async e=>{let a=await s({extension:F.H.PaymentVoucherExpenses.qry,parameters:`_pvId=${e.recordId}`}),t=await Promise.all(a.list.map(async a=>{let t=await eI(e.recordId,a.seqNo);return{...a,id:a.seqNo,isVAT:0!=a.vatAmount,hasCostCenters:!1,costCenters:t}}));ea.setValues({...e,expenses:t})},eb=ea.values?.expenses?.reduce((e,a)=>{let t=parseFloat(a.subtotal?.toString().replace(/,/g,""))||0;return e+t},0),eC=ea.values?.expenses?.reduce((e,a)=>{let t=parseFloat(a.vatAmount?.toString().replace(/,/g,""))||0;return e+t},0),ek=ea.values?.expenses?.reduce((e,a)=>{let t=parseFloat(a.amount?.toString().replace(/,/g,""))||0;return e+t},0);async function eg(e,a,t,n){if(e&&a&&t){let r=await s({extension:R.q.Currency.get,parameters:`_currencyId=${e}&_date=${(0,N.Uf)(a)}&_rateDivision=${t}`}),o=(0,S.fB)({amount:0===n?0:n??ea.values.amount,exRate:r.record?.exRate,baseAmount:0,rateCalcMethod:r.record?.rateCalcMethod,dirtyField:S.ss});ea.setFieldValue("baseAmount",parseFloat(o?.baseAmount).toFixed(2)||0),r.record?.exRate&&ea.setFieldValue("exRate",r.record?.exRate),r.record?.rateCalcMethod&&ea.setFieldValue("rateCalcMethod",r.record?.rateCalcMethod)}}return r.jsx(c.Z,{resourceId:y.i.PaymentVoucherExpenses,form:ea,maxAccess:K,editMode:eo,previewReport:eo,actions:ex,functionId:k.J.PaymentVoucher,disabledSubmit:er||es,children:(0,r.jsxs)(I.R,{children:[r.jsx(Z.g,{children:(0,r.jsxs)(o(),{container:!0,spacing:2,children:[r.jsx(o(),{item:!0,xs:6,children:(0,r.jsxs)(o(),{container:!0,spacing:2,children:[r.jsx(o(),{item:!0,xs:12,children:r.jsx(b.Z,{endpointId:C.r.DocumentType.qry,parameters:`_dgId=${k.J.PaymentVoucher}&_startAt=0&_pageSize=50`,filter:eo?void 0:e=>1===e.activeStatus,name:"dtId",label:z.documentType,readOnly:eo,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ea.values,onChange:async(e,a)=>{ea.setFieldValue("dtId",a?.recordId||null),Q(a)},error:ea.touched.dtId&&!!ea.errors.dtId,maxAccess:K})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(h.Z,{name:"reference",label:z.reference,value:ea.values.reference,readOnly:eo,maxAccess:!eo&&K,maxLength:"15",onChange:ea.handleChange,onClear:()=>ea.setFieldValue("reference",""),error:ea.touched.reference&&!!ea.errors.reference})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(f.Z,{name:"date",label:z.date,value:ea.values?.date,required:!0,onChange:async(e,a)=>{ea.setFieldValue("date",a),await eg(ea.values.currencyId,a,M.B.FINANCIALS)},onClear:()=>ea.setFieldValue("date",null),readOnly:er||es,error:ea.touched.date&&!!ea.errors.date,maxAccess:K})}),r.jsx(o(),{item:!0,xs:12,children:r.jsx(b.Z,{endpointId:C.r.Plant.qry,name:"plantId",label:z.plant,valueField:"recordId",readOnly:er||es,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ea.values,onChange:(e,a)=>{ea.setFieldValue("plantId",a?a?.recordId:"")},error:ea.touched.plantId&&!!ea.errors.plantId})}),r.jsx(o(),{item:!0,xs:12,children:r.jsx(b.Z,{endpointId:A.G.CashAccount.qry,parameters:"_type=0",name:"cashAccountId",readOnly:es||er,required:!0,label:z.cashAccount,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ea.values,maxAccess:K,onChange:async(e,a)=>{ea.setFieldValue("cashAccountId",a?.recordId||null)},error:ea.touched.cashAccountId&&!!ea.errors.cashAccountId})}),r.jsx(o(),{item:!0,xs:6,children:(0,r.jsxs)(o(),{container:!0,spacing:1,alignItems:"center",children:[r.jsx(o(),{item:!0,xs:8,children:r.jsx(b.Z,{endpointId:C.r.Currency.qry,name:"currencyId",label:z.currency,valueField:"recordId",required:!0,filter:e=>1===e.currencyType,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:er||es,values:ea.values,onChange:async(e,a)=>{await eg(a?.recordId,ea.values.date,M.B.FINANCIALS),ea.setFieldValue("currencyId",a?a?.recordId:null),ea.setFieldValue("currencyName",a?.name)},error:ea.touched.currencyId&&!!ea.errors.currencyId})}),r.jsx(o(),{item:!0,xs:4,children:r.jsx(H.Z,{onClick:()=>{var e;return e=ea.values,void G({Component:P.Z,props:{DatasetIdAccess:y.i.MCRPaymentVoucherExpenses,data:{...e,amount:ek},onOk:e=>{ea.setValues(a=>({...a,...e}))}}})},image:"popup.png",tooltipText:$.add,disabled:!ea.values.currencyId||ea.values.currencyId===U})})]})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(b.Z,{neverPopulate:!0,endpointId:F.H.DescriptionTemplate.qry,name:"templateId",label:z.descriptionTemplate,readOnly:er||es,valueField:"recordId",displayField:"name",values:ea.values,onChange:(e,a)=>{let t=ea.values.notes||"";a?.name&&ea.setFieldValue("notes",""===t?a.name:`${t}
${a.name}`),ea.setFieldValue("templateId",a?.recordId||null)},error:ea.touched.templateId&&!!ea.errors.templateId,maxAccess:K})})]})}),r.jsx(o(),{item:!0,xs:6,children:(0,r.jsxs)(o(),{container:!0,spacing:2,children:[r.jsx(o(),{item:!0,xs:6,children:r.jsx(b.Z,{datasetId:g.v.PAYMENT_METHOD,name:"paymentMethod",label:z.paymentMethod,valueField:"key",displayField:"value",values:ea.values,required:!0,readOnly:er||es,maxAccess:K,onChange:(e,a)=>{ea.setFieldValue("paymentMethod",a?a.key:null)},error:ea.touched.paymentMethod&&!!ea.errors.paymentMethod})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(T.Z,{name:"subtotal",label:z.subtotal,value:eb,readOnly:!0,maxAccess:K,onChange:ea.handleChange,onClear:()=>ea.setFieldValue("subtotal",""),error:ea.touched.subtotal&&!!ea.errors.subtotal})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(h.Z,{name:"checkNo",label:z.checkNo,value:ea.values.checkNo,maxAccess:K,onChange:ea.handleChange,onClear:()=>ea.setFieldValue("checkNo",""),error:ea.touched.checkNo&&!!ea.errors.checkNo,disabled:3!=ea.values.paymentMethod,required:3==ea.values.paymentMethod})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(T.Z,{name:"vatAmount",label:z.vat,value:eC,readOnly:!0,maxAccess:K,onChange:ea.handleChange,onClear:()=>ea.setFieldValue("vatAmount",""),error:ea.touched.vatAmount&&!!ea.errors.vatAmount})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(b.Z,{endpointId:A.G.CACheckbook.qry,name:"checkbookId",label:z.checkbook,valueField:"recordId",displayField:"firstCheckNo",values:ea.values,onChange:(e,a)=>{ea.setFieldValue("checkbookId",a?a?.recordId:"")},error:ea.touched.checkbookId&&!!ea.errors.checkbookId,disabled:3!=ea.values.paymentMethod})}),r.jsx(o(),{item:!0,xs:6,children:r.jsx(T.Z,{name:"amount",label:z.amount,value:ek,readOnly:!0,maxAccess:K,thousandSeparator:!1,onChange:async e=>{let a=(0,S.fB)({amount:e.target.value??0,exRate:ea.values?.exRate,baseAmount:0,rateCalcMethod:ea.values?.rateCalcMethod,dirtyField:S.ss});ea.setFieldValue("baseAmount",parseFloat(a?.baseAmount).toFixed(2)||0),ea.setFieldValue("amount",e.target.value)},onClear:async()=>{ea.setFieldValue("amount",0)},error:ea.touched.amount&&!!ea.errors.amount})}),r.jsx(o(),{item:!0,xs:12,children:r.jsx(V.Z,{name:"notes",type:"text",label:z.notes,value:ea.values.notes,readOnly:er||es,rows:3,maxAccess:K,onChange:e=>ea.setFieldValue("notes",e.target.value),onClear:()=>ea.setFieldValue("notes",""),error:ea.touched.notes&&!!ea.errors.notes})})]})})]})}),r.jsx(i._,{onChange:e=>{ea.setFieldValue("expenses",e)},value:ea?.values?.expenses,error:ea?.errors?.expenses,initialValues:ea?.initialValues?.expenses[0],columns:ev,allowDelete:!er&&!es,allowAddNewLine:!er&&!es})]})})}[c,u,i,m,p,v,b,j,w,O,q,P,D]=E.then?(await E)():E,$.width=1300,$.height=700,n()}catch(e){n(e)}})}};