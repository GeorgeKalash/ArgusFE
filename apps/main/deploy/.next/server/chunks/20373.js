"use strict";exports.id=20373,exports.ids=[20373],exports.modules={20373:(e,r,a)=>{a.a(e,async(e,t)=>{try{a.d(r,{Z:()=>X});var n=a(20997),l=a(27736),d=a(79390),s=a(99155),o=a.n(s),c=a(17581),i=a.n(c),u=a(47501),y=a.n(u),m=a(68931),p=a.n(m),x=a(16689),f=a(70305),v=a(75609),I=a(80582),C=a(86201),h=a(29352),g=a(38509),F=a(6416),R=a(44619),w=a(65980),b=a(71278),O=a(79660),j=a(68728),_=a(74548),V=a(48395),$=a(8995),k=a(61274),A=a(677),S=a(29608),q=a(38782),D=a(99912),M=a(95965),N=a(16774),J=a(70638),Z=a(15051),T=a(18611),P=a(42020),E=a(23385),W=a(60520),U=a(86794),B=a(1315),L=a(15105),z=a(96119),G=a(93105),H=a(91184),Q=a(75281),Y=e([f,I,C,h,g,b,k,A,S,q,D,J,Z,W,U,B,L]);[f,I,C,h,g,b,k,A,S,q,D,J,Z,W,U,B,L]=Y.then?(await Y)():Y;let K=({recordId:e,window:r})=>{let{platformLabels:a,userDefaultsData:t}=(0,x.useContext)(W.l),{getRequest:s,postRequest:c}=(0,x.useContext)(h.$),{stack:u}=(0,f.V)(),[m,Y]=(0,x.useState)(j.J.CurrencyCreditOrderPurchase),[K,X]=(0,x.useState)(null),{stack:ee}=(0,A.zY)(),er=(0,Q.m)("userData").userId,ea=parseInt(t?.list?.find(({key:e})=>"plantId"===e)?.value),{labels:et,access:en}=(0,q.Z)({datasetId:F.i.CreditOrder,editMode:!!e});(0,z.Z)({title:et.creditOrder,window:r});let{maxAccess:el}=(0,U.H)({functionId:m,access:en,enabled:!e,hasDT:!1}),ed=(0,g.E)({endpointId:V.s.CreditOrder.page}),{schema:es,requiredFields:eo}=(0,G.m)({currencyRef:e=>e?.currencyRef,currencyName:e=>e?.currencyName,qty:e=>e?.qty,exRate:e=>e?.exRate,amount:e=>e?.amount},!0,el,"rows"),{formik:ec}=(0,M.c)({maxAccess:el,initialValues:{recordId:e,currencyId:null,currencyRef:"",date:new Date,functionId:j.J.CurrencyCreditOrderPurchase,deliveryDate:new Date,reference:"",dtId:null,plantId:parseInt(ea),corId:null,corRef:"",corName:"",wip:1,status:1,releaseStatus:"",notes:"",amount:0,baseAmount:0,exRate:1,rateCalcMethod:"",rateType:"",isTFRClicked:!1,rows:[{id:1,orderId:e||null,seqNo:"",currencyId:null,qty:"",rateCalcMethod:"",exRate:"",minRate:"",maxRate:"",defaultRate:"",amount:"",baseAmount:"",notes:"",goc:!1}]},validateOnChange:!0,validationSchema:v.object({date:v.string().required(),plantId:v.string().required(),corId:v.string().required(),rows:v.array().of(es)}),onSubmit:async e=>{let r={...e,date:(0,d.ku)(e.date),deliveryDate:(0,d.ku)(e.deliveryDate),amount:ef,baseAmount:ev};delete r.rows;let t=ec.values.rows.filter(e=>Object.values(eo)?.every(r=>r(e)))?.map((e,r)=>({...e,seqNo:r+1,orderId:ec.values.recordId||0})),n=await c({extension:V.s.CreditOrder.set,record:JSON.stringify({header:r,items:t})}),l=e.recordId?a.Edited:a.Added;C.default.success(l),await eV(n?.recordId),ed()}}),ei=2==ec.values.wip,eu=3===ec.values.releaseStatus&&3!==ec.values.status,ey=!!ec.values.recordId,em=async()=>{let e=await c({extension:V.s.CreditOrder.close,record:JSON.stringify(ec.values)});C.default.success(a.Closed),ed(),eV(e?.recordId)},ep=async()=>{let e=await c({extension:V.s.CreditOrder.reopen,record:JSON.stringify(ec.values)});C.default.success(a.Closed),ed(),eV(e?.recordId)},ex=async()=>{let e=await c({extension:V.s.CreditOrder.tfr,record:JSON.stringify(ec.values)});C.default.success(a.Generated),ed(),await eV(ec.values.recordId),r.close(),ee({Component:S.Z,props:{recordId:e?.recordId}})},ef=ec?.values?.rows?.length?ec.values.rows.reduce((e,r)=>{let a=parseFloat(r.amount?.toString().replace(/,/g,""))||0;return e+a},0):0,ev=ec?.values?.rows?.length?ec.values.rows.reduce((e,r)=>{let a=parseFloat(r.baseAmount?.toString().replace(/,/g,""))||0;return e+a},0):0,eI=async(e,r,a)=>{if(!e)return;let t=await s({extension:_.d.Correspondent.get,parameters:`_recordId=${e}`});ec.setFieldValue("currencyId",t?.record?.currencyId||null),ec.setFieldValue("currencyRef",t?.record?.currencyRef||"");let n=await s({extension:$.u.Defaults.get,parameters:"_key=ct_credit_eval_ratetype_id"});eh(a,t?.record?.currencyId,r,n?.record?.value)},eC=async e=>{let r=await s({extension:O.r.UserFunction.get,parameters:`_userId=${er}&_functionId=${e}`});ec.setFieldValue("dtId",r?.record?.dtId)};async function eh(e,r,a,t){if(!e||!r||!t||!a){e||u({message:et.emptyPlant}),r||(ec.setFieldValue("corId",null),ec.setFieldValue("corRef",""),ec.setFieldValue("corName",""),u({message:et.emptyToCurrency})),t||u({message:et.emptyRate}),a||u({message:et.emptyFromCurrency});return}let n=await s({extension:$.u.ExchangeMap.get,parameters:`_plantId=${e}&_currencyId=${r}&_raCurrencyId=${a}&_rateTypeId=${t}`});if(!n?.record?.rate){u({message:et.undefinedCorRate});return}ec.setFieldValue("currencyId",r),ec.setFieldValue("exRate",n?.record?.rate),ec.setFieldValue("rateCalcMethod",n?.record?.rateCalcMethod),ec.setFieldValue("minRate",n?.record?.minRate),ec.setFieldValue("maxRate",n?.record?.maxRate)}async function eg(e){for(let r in e)if(!e[r]){u({message:`${r} ${et.empty}`});return}let r=await s({extension:$.u.ExchangeMap.get,parameters:`_plantId=${e.plantId}&_currencyId=${e.fromCurrency}&_raCurrencyId=${e.toCurrency}&_rateTypeId=${e.rateType}`});return r?.record}let eF=[{component:"resourcecombobox",label:et.currency,name:"currencyRef",flex:2,props:{endpointId:O.r.Currency.qry,displayField:"reference",valueField:"recordId",mapping:[{from:"recordId",to:"currencyId"},{from:"reference",to:"currencyRef"},{from:"name",to:"currencyName"}],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],displayFieldWidth:3},async onChange({row:{update:e,oldRow:r,newRow:a}}){if(!a?.currencyId)return;let t=await eg({plantId:ea||ec.values.plantId,toCurrency:ec?.values?.currencyId,fromCurrency:a?.currencyId,rateType:ec?.values?.rateType});if(!t?.rate){e({exRate:0,defaultRate:0,amount:0,baseAmount:0}),u({message:`${et.undefinedRate} ${a?.currencyRef}.`});return}let n=0,l=0;if(a?.qty){let e=parseFloat(a?.qty?.toString().replace(/,/g,""))||0,r=1===t.rateCalcMethod?e*t.rate:2===t.rateCalcMethod?e/t.rate:0;n=parseFloat(r).toFixed(2);let d=1===ec.values.rateCalcMethod?r*ec.values.exRate:2===ec.values.rateCalcMethod?r/ec.values.exRate:0;l=parseFloat(d).toFixed(2)}let d=await eR(a?.currencyId);e({currencyId:t.currencyId,currencyName:t.currencyName,exRate:t.rate.toFixed(7),defaultRate:t.rate.toFixed(7),rateCalcMethod:t.rateCalcMethod,minRate:t.minRate,maxRate:t.maxRate,goc:d?.goc||!1,amount:n,baseAmount:l})}},{component:"textfield",label:et.name,name:"currencyName",props:{readOnly:!0},flex:3},{component:"numberfield",label:et.quantity,name:"qty",flex:2,updateOn:"blur",async onChange({row:{update:e,newRow:r}}){let a=r.rateCalcMethod,t=1===a?parseFloat(r?.qty?.toString().replace(/,/g,""))*r?.exRate:2===a?parseFloat(r?.qty?.toString().replace(/,/g,""))/r?.exRate:0,n=1===ec.values.rateCalcMethod?parseFloat(t)*ec.values.exRate:2===a?parseFloat(t)/ec.values.exRate:0;e({amount:parseFloat(t).toFixed(2),baseAmount:parseFloat(n).toFixed(2),qty:parseFloat(r?.qty).toFixed(2)})}},{component:"numberfield",label:et.defaultRate,name:"defaultRate",props:{readOnly:!0},flex:2},{component:"numberfield",label:et.exRate,name:"exRate",props:{decimalScale:7},flex:2,updateOn:"blur",async onChange({row:{update:e,newRow:r}}){if(!r.currencyId||!r.exRate){e({exRate:"",defaultRate:"",amount:0,baseAmount:0});return}let a=e=>parseFloat(e?.toString().replace(/,/g,""))||0,t=a(r.exRate);if(t>0){let n=a(r.minRate),l=a(r.maxRate);if(t>=n&&t<=l){let n=a(r.qty),l=r.rateCalcMethod,d=1===l?n*t:2===l?n/t:0,s=1===ec.values.rateCalcMethod?d*ec.values.exRate:2===ec.values.rateCalcMethod?d/ec.values.exRate:0;e({exRate:t.toFixed(7),amount:d.toFixed(2),baseAmount:s.toFixed(2)})}else u({message:`${t} ${et.invalidRange} [${n}-${l}]`}),e({exRate:"",amount:0,baseAmount:0})}}},{component:"numberfield",label:`${et.total} ${ec.values.currencyRef||""}`,name:"amount",props:{readOnly:!0},flex:2}];async function eR(e){if(!e)return;let r=await s({extension:_.d.CorrespondentCurrency.get,parameters:`_corId=${ec.values.corId}&_currencyId=${e}`});return r?.record}let ew=async e=>{let r=await s({extension:V.s.CreditOrderItem.qry,parameters:`_orderId=${e}`});return r?.list?.length>0?r.list.map((e,r)=>({...e,id:r+1,qty:parseFloat(e?.qty).toFixed(2),amount:parseFloat(e?.amount).toFixed(2),baseAmount:parseFloat(e?.baseAmount).toFixed(2),exRate:parseFloat(e?.exRate).toFixed(7),defaultRate:parseFloat(e?.defaultRate).toFixed(7)})):ec.initialValues.rows};async function eb(e){if(e==j.J.CurrencyCreditOrderPurchase||e==j.J.CurrencyCreditOrderSale){let r=await s({extension:$.u.Defaults.get,parameters:e==j.J.CurrencyCreditOrderPurchase?"_key=ct_credit_purchase_ratetype_id":e==j.J.CurrencyCreditOrderSale?"_key=ct_credit_sales_ratetype_id":""});ec.setFieldValue("rateType",r?.record?.value),ec.setFieldValue("functionId",e)}}async function eO(){let e=await s({extension:O.r.Defaults.get,parameters:"_key=baseCurrencyId"});return await ej(e?.record?.value),e?.record?.value}let ej=async e=>{s({extension:O.r.Currency.get,parameters:`_recordId=${e}`}).then(e=>{X(e?.record?.reference)})};async function e_(e){return await await s({extension:V.s.CreditOrder.get,parameters:`_recordId=${e}`})}async function eV(e){let r=await e_(e),a=await ew(e);ec.setValues(e=>({...e,...r.record,date:(0,d.a1)(r.record.date),deliveryDate:r?.record?.deliveryDate?(0,d.a1)(r.record.deliveryDate):null,rows:a})),await eb(r.record.functionId)}let e$=async()=>{ee({Component:J.Z,props:{functionId:ec.values.functionId,recordId:ec.values.recordId}})},ek=[{key:"Close",condition:!ei,onClick:em,disabled:ei||!ey},{key:"Reopen",condition:ei,onClick:ep,disabled:!ei||!ey||3===ec.values.releaseStatus&&3===ec.values.status},{key:"Approval",condition:!0,onClick:"onApproval",disabled:!ei},{key:"Invoice",condition:ex,onClick:()=>{ee({Component:D.Z,props:{DialogText:et.transferMessage,fullScreen:!1,okButtonAction:ex},width:400,height:150,title:""})},disabled:!eu},{key:"WorkFlow",condition:!0,onClick:e$,disabled:!ey},{key:"Shipment",condition:!0,onClick:()=>{ee({Component:L.u,props:{recordId:ec.values.recordId,functionId:ec.values.functionId,editMode:1!=ec.values.status,totalBaseAmount:ev}})},disabled:!ey},{key:"Transportation",condition:!0,onClick:()=>{ee({Component:B.R,props:{recordId:ec.values.recordId,functionId:ec.values.functionId,editMode:1!=ec.values.status}})},disabled:!ey}];return(0,x.useEffect)(()=>{!async function(){e?(await eV(e),await eO()):(await eb(j.J.CurrencyCreditOrderPurchase),await eC(j.J.CurrencyCreditOrderPurchase))}()},[]),n.jsx(I.Z,{resourceId:F.i.CreditOrder,form:ec,maxAccess:el,editMode:ey,actions:ek,previewReport:ey,disabledSubmit:ei,children:(0,n.jsxs)(T.R,{children:[n.jsx(P.g,{children:(0,n.jsxs)(o(),{container:!0,xs:12,spacing:2,children:[n.jsx(N.Z,{hideonempty:!0,item:!0,xs:4,children:n.jsx(l.Z,{name:"date",required:!0,readOnly:ei,label:et.date,value:ec?.values?.date,onChange:ec.setFieldValue,maxAccess:el,onClear:()=>ec.setFieldValue("date",null),error:ec.touched.date&&!!ec.errors.date})}),n.jsx(o(),{item:!0,xs:4,children:n.jsx(b.Z,{endpointId:O.r.Plant.qry,name:"plantId",label:et.plant,readOnly:!0,values:ec.values,valueField:"recordId",displayField:["reference","name"],required:!0,maxAccess:el,onChange:(e,r)=>{ec.setFieldValue("plantId",r?.recordId||null)},error:ec.touched.plantId&&!!ec.errors.plantId})}),n.jsx(o(),{item:!0,xs:4,children:n.jsx(R.Z,{name:"reference",label:et.reference,value:ec?.values?.reference,maxAccess:el,maxLength:"30",readOnly:ey,onChange:ec.handleChange,onClear:()=>ec.setFieldValue("reference",""),error:ec.touched.reference&&!!ec.errors.reference})}),n.jsx(o(),{item:!0,xs:8,children:n.jsx(k.U,{endpointId:_.d.Correspondent.snapshot,valueField:"reference",displayField:"name",name:"corId",label:et.correspondent,form:ec,required:!0,firstFieldWidth:4,displayFieldWidth:3,valueShow:"corRef",secondValueShow:"corName",readOnly:ei||ec?.values?.rows?.some(e=>!!e.currencyId),maxAccess:el,onChange:async(e,r)=>{if(r){let e=await eO();eI(r?.recordId,e,ec.values.plantId)}ec.setFieldValue("corName",r?r.name:""),ec.setFieldValue("corRef",r?r.reference:""),ec.setFieldValue("corId",r?r.recordId:null)},errorCheck:"corId"})}),n.jsx(o(),{item:!0,xs:4,children:n.jsx(l.Z,{name:"deliveryDate",readOnly:ei,label:et.deliveryDate,value:ec?.values?.deliveryDate,onChange:ec.setFieldValue,maxAccess:el,disabledRangeDate:{date:ec.values.date,day:30},onClear:()=>ec.setFieldValue("deliveryDate",null),error:ec.touched.deliveryDate&&!!ec.errors.deliveryDate})}),n.jsx(o(),{item:!0,xs:6,children:(0,n.jsxs)(i(),{row:!0,value:ec.values.functionId,defaultValue:j.J.CurrencyCreditOrderPurchase,onChange:async e=>{await eb(e.target.value),await eC(e.target.value),Y(e.target.value),ec.setFieldValue("reference","")},children:[n.jsx(y(),{value:j.J.CurrencyCreditOrderPurchase,control:n.jsx(p(),{}),label:et.purchase,disabled:ec?.values?.rows?.some(e=>!!e.currencyId)}),n.jsx(y(),{value:j.J.CurrencyCreditOrderSale,control:n.jsx(p(),{}),label:et.sale,disabled:ec?.values?.rows?.some(e=>!!e.currencyId)})]})})]})}),n.jsx(E.Q,{children:n.jsx(Z._,{onChange:e=>ec.setFieldValue("rows",e),disabled:!ec.values.corId||ei,value:ec.values.rows,name:"rows",error:ec.errors.rows,columns:eF,allowAddNewLine:!ei,maxAccess:el,allowDelete:!ei,bg:ec.values.functionId&&(ec.values.functionId!=j.J.CurrencyCreditOrderPurchase?"#C7F6C7":"rgb(245, 194, 193)")})}),n.jsx(P.g,{children:(0,n.jsxs)(o(),{container:!0,spacing:2,xs:12,children:[n.jsx(N.Z,{item:!0,xs:8,children:n.jsx(w.Z,{name:"notes",label:et.notes,value:ec.values.notes,rows:3,maxAccess:el,readOnly:ei,onChange:e=>ec.setFieldValue("notes",e.target.value),onClear:()=>ec.setFieldValue("notes",""),error:ec.touched.notes&&!!ec.errors.notes})}),n.jsx(o(),{item:!0,xs:4,children:(0,n.jsxs)(o(),{container:!0,spacing:2,children:[n.jsx(o(),{item:!0,xs:12,children:n.jsx(H.Z,{name:"totalCUR",label:`${et.total} ${ec.values.currencyRef||""}`,value:ef,readOnly:!0,align:"right"})}),n.jsx(o(),{item:!0,xs:12,children:n.jsx(H.Z,{name:"baseAmount",label:`${et.total} ${K||""}`,value:ev,readOnly:!0,align:"right"})})]})})]})})]})})};K.width=1e3,K.height=650;let X=K;t()}catch(e){t(e)}})}};