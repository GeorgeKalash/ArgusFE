"use strict";exports.id=51157,exports.ids=[51157],exports.modules={26245:(e,a,t)=>{t.a(e,async(e,l)=>{try{t.d(a,{Z:()=>V});var s=t(20997),d=t(27736),n=t(79390),r=t(99155),i=t.n(r),o=t(16689),u=t(75609),c=t(86201),m=t(29352),y=t(65980),h=t(71278),v=t(79660),x=t(54242),I=t(61274),p=t(18611),C=t(42020),f=t(91184),j=t(95965),F=t(60520),g=t(13567),D=t(70305),q=t(18687),b=e([c,m,h,I,F,D,q]);function V({recordId:e,maxSeqNo:a,seqNo:t,labels:l,maxAccess:r,readOnlyField:b,refetchTable:V,window:k}){let{getRequest:P,postRequest:w}=(0,o.useContext)(m.$),{platformLabels:N}=(0,o.useContext)(F.l),{stack:R}=(0,D.V)(),{formik:O}=(0,j.c)({maxAccess:r,initialValues:{details:{trxId:e,sku:"",seqNo:null,itemId:null,itemName:"",siteId:null,muId:null,muQty:null,qty:null,baseQty:null,deliveryDate:new Date,status:1,onhand:null,lastPurchaseDate:null,lastPurchaseCurrencyId:null,lastPurchaseUnitPrice:null,unitCost:null,totalCost:null,justification:""}},validateOnChange:!0,validationSchema:u.object({details:u.object({itemId:u.number().required(),qty:u.number().required()})}),onSubmit:async t=>{(t=t.details).seqNo||t.recordId||(t.seqNo=a+1),await w({extension:g.y.RequisitionDetail.set,record:JSON.stringify({...t,deliveryDate:t?.deliveryDate?(0,n.ku)(t?.deliveryDate):null,baseQty:t.muQty?t.muQty*t.qty:t.qty})}),V(e),c.default.success(t.trxId?N.Edited:N.Added),k.close()}}),A=!!O.values.details.recordId;async function Z(e){if(!e){O.setFieldValue("details.onhand",0);return}let a=await P({extension:x.$.Availability.get,parameters:`_itemId=${e}&_seqNo=0`});O.setFieldValue("details.onhand",a?.record?.onhand||0)}async function S(e){if(!e){O.setFieldValue("details.lastPurchaseUnitPrice",0),O.setFieldValue("details.lastPurchaseDate",null),O.setFieldValue("details.lastPurchaseCurrencyId",null);return}let a=await P({extension:g.y.ItemLastPurchaseInfo.last,parameters:`_itemId=${e}&_vendorId=${O?.values?.vendorId||0}`});O.setFieldValue("details.lastPurchaseUnitPrice",a?.record?.invoiceItem?.unitPrice||0),O.setFieldValue("details.lastPurchaseDate",a?.record?.invoice?.date?(0,n.a1)(a?.record?.invoice?.date):null),O.setFieldValue("details.lastPurchaseCurrencyId",a?.record?.invoice?.currencyId)}async function _(e){if(!e){O.setFieldValue("details.unitCost",0);return}let a=await P({extension:x.$.CurrentCost.get,parameters:`_itemId=${e}`});O.setFieldValue("details.unitCost",a?.record?.currentCost||0)}return s.jsx(q.Z,{onSave:O.handleSubmit,maxAccess:r,editMode:!0,disabledSubmit:b,children:s.jsx(p.R,{children:s.jsx(C.g,{children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:6,children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:12,children:s.jsx(I.U,{endpointId:x.$.Item.snapshot,valueField:"reference",displayField:"name",name:"details.itemId",label:l.item,form:O,readOnly:b,displayFieldWidth:3,valueShow:"sku",secondValueShow:"itemName",maxAccess:r,required:!0,formObject:O.values.details,columnsInDropDown:[{key:"sku",value:"SKU"},{key:"name",value:"Name"}],onChange:async(e,a)=>{if(a?.isInactive){R({message:l.inactiveItem}),O.resetForm(),O.setFieldValue("details.sku",null);return}await Z(a?.recordId),await S(a?.recordId),await _(a?.recordId),O.setFieldValue("details.msId",a?.msId||null),O.setFieldValue("details.muId",null),O.setFieldValue("details.totalCost",O.values.details.qty||0*O.values.details.unitCost||0),O.setFieldValue("details.itemName",a?.name||""),O.setFieldValue("details.sku",a?.sku||""),O.setFieldValue("details.itemId",a?.recordId||null)},errorCheck:"details.itemId"})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(h.Z,{endpointId:x.$.Site.qry,name:"details.siteId",readOnly:b,label:l.site,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:O.values.details,valueField:"recordId",displayField:["reference","name"],maxAccess:r,onChange:(e,a)=>{O.setFieldValue("details.siteId",a?.recordId||null)},error:O?.touched.details?.siteId&&!!O?.errors.details?.siteId})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(h.Z,{endpointId:O.values.details.msId&&x.$.MeasurementUnit.qry,parameters:`_msId=${O.values.details.msId}`,name:"details.muId",readOnly:A||b,label:l.measurement,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:O.values.details,valueField:"recordId",displayField:["reference","name"],maxAccess:r,onChange:(e,a)=>{O.setFieldValue("details.muId",a?.recordId||""),O.setFieldValue("details.muQty",a?.qty)},error:O?.touched.details?.muId&&!!O?.errors.details?.muId})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(f.Z,{name:"details.qty",label:l.qty,value:O.values.details.qty,onChange:e=>{let a=Number(e.target.value.replace(/,/g,""));O.setFieldValue("details.totalCost",(a||0)*(O.values.details.unitCost||0)),O.setFieldValue("details.qty",a)},onClear:()=>O.setFieldValue("details.qty",null),readOnly:b,maxAccess:r,required:!0,error:O?.touched.details?.qty&&!!O?.errors.details?.qty})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(f.Z,{name:"details.unitCost",label:l.unitCost,value:O.values.details.unitCost,onChange:O.handleChange,onClear:()=>O.setFieldValue("details.unitCost",""),readOnly:!0,maxAccess:r,error:O?.touched.details?.unitCost&&!!O?.errors.details?.unitCost})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(f.Z,{name:"details.totalCost",label:l.totalCost,value:O.values.details.totalCost,onChange:O.handleChange,onClear:()=>O.setFieldValue("details.totalCost",0),readOnly:!0,maxAccess:r,error:O?.touched.details?.totalCost&&!!O?.errors.details?.totalCost})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(f.Z,{name:"details.onhand",label:l.onHand,value:O.values.details.onhand,onChange:O.handleChange,onClear:()=>O.setFieldValue("details.onhand",0),readOnly:!0,maxAccess:r,error:O?.touched.details?.onhand&&!!O?.errors.details?.onhand})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(I.U,{endpointId:g.y.Vendor.snapshot,valueField:"reference",displayField:"name",name:"details.vendorId",label:l.vendor,form:O,readOnly:b,displayFieldWidth:3,valueShow:"vendorRef",secondValueShow:"vendorName",maxAccess:r,formObject:O.values.details,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],onChange:async(e,a)=>{O.setFieldValue("details.vendorName",a?.name||""),O.setFieldValue("details.vendorRef",a?.reference||""),O.setFieldValue("details.vendorId",a?.recordId||null)},errorCheck:"details.vendorId"})})]})}),s.jsx(i(),{item:!0,xs:6,children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:12,children:s.jsx(d.Z,{name:"details.deliveryDate",label:l.deliveryDate,readOnly:b,value:O?.values?.details.deliveryDate,onChange:O.setFieldValue,maxAccess:r,onClear:()=>O.setFieldValue("details.deliveryDate",null),error:O?.touched.details?.deliveryDate&&!!O?.errors.details?.deliveryDate})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(f.Z,{name:"details.lastPurchaseUnitPrice",label:l.lastPurchaseUnitPrice,value:O.values.details.lastPurchaseUnitPrice,onChange:O.handleChange,onClear:()=>O.setFieldValue("details.lastPurchaseUnitPrice",""),readOnly:!0,maxAccess:r,error:O?.touched.details?.lastPurchaseUnitPrice&&!!O?.errors.details?.lastPurchaseUnitPrice})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(h.Z,{endpointId:v.r.Currency.qry,name:"details.lastPurchaseCurrencyId",label:l.lastPurchaseCurrency,valueField:"recordId",displayField:"name",readOnly:!0,values:O.values.details,onChange:(e,a)=>{O.setFieldValue("details.lastPurchaseCurrencyId",a?.recordId||null)},error:O?.touched.details?.lastPurchaseCurrencyId&&!!O?.errors.details?.lastPurchaseCurrencyId,maxAccess:r})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(d.Z,{name:"details.lastPurchaseDate",label:l.lastPurchaseDate,readOnly:!0,value:O?.values?.details.lastPurchaseDate,onChange:O.setFieldValue,maxAccess:r,onClear:()=>O.setFieldValue("details.lastPurchaseDate",null),error:O?.touched.details?.lastPurchaseDate&&!!O?.errors.details?.lastPurchaseDate})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(y.Z,{name:"details.justification",label:l.justification,value:O?.values?.details.justification,rows:2.5,readOnly:b,maxAccess:r,onChange:O.handleChange,onClear:()=>O.setFieldValue("details.justification",""),error:O?.touched.details?.justification&&!!O?.errors.details?.justification})})]})})]})})})})}[c,m,h,I,F,D,q]=b.then?(await b)():b,l()}catch(e){l(e)}})},51157:(e,a,t)=>{t.a(e,async(e,l)=>{try{t.d(a,{Z:()=>J});var s=t(20997),d=t(27736),n=t(79390),r=t(99155),i=t.n(r),o=t(40711),u=t(16689),c=t(75609),m=t(80582),y=t(86201),h=t(29352),v=t(38509),x=t(6416),I=t(44619),p=t(65980),C=t(71278),f=t(79660),j=t(54242),F=t(68728),g=t(61274),D=t(23385),q=t(18611),b=t(42020),V=t(95965),k=t(70638),P=t(677),w=t(60520),N=t(86794),R=t(97969),O=t(96611),A=t(13567),Z=t(70755),S=t(26245),_=t(75281),$=t(91184),U=t(96119),T=t(38782);t(8297);var Q=e([o,m,y,h,v,C,g,k,P,w,N,S,T]);function J({recordId:e,window:a}){let{getRequest:t,postRequest:l}=(0,u.useContext)(h.$),{stack:r}=(0,P.zY)(),{platformLabels:Q,userDefaultsData:J}=(0,u.useContext)(w.l),[E,M]=(0,u.useState)(1),W=parseInt(J?.list?.find(e=>"plantId"===e.key)?.value);(0,_.m)("userData").userId;let{labels:z,access:H}=(0,T.Z)({datasetId:x.i.PurchaseRequisition});(0,U.Z)({title:z?.purchaseRequisition,window:a});let{documentType:K,maxAccess:Y,changeDT:B}=(0,N.H)({functionId:F.J.PurchaseRequisition,access:H,enabled:!e}),L=(0,v.E)({endpointId:A.y.PurchaseRequisition.page}),{formik:G}=(0,V.c)({maxAccess:Y,documentType:{key:"dtId",value:K?.dtId},initialValues:{recordId:e,dtId:null,dgId:null,reference:"",status:1,date:new Date,procurementType:null,siteId:null,deliveryDate:null,notes:"",vendorId:null,plantId:W,departmentId:null,releaseStatus:null,wip:1,totalCost:0,totalQty:0,items:{}},validateOnChange:!0,validationSchema:c.object({date:c.date().required(),procurementType:c.string().required()}),onSubmit:async e=>{let a={...e};delete a.items;let t=await l({extension:A.y.PurchaseRequisition.set,record:JSON.stringify({...a,date:a?.date?(0,n.ku)(a?.date):null,deliveryDate:a?.deliveryDate?(0,n.OZ)(new Date(a.deliveryDate)):null})});L(),y.default.success(a.recordId?Q.Edited:Q.Added),await ei(t?.recordId)}}),X=!!G.values.recordId,ee=2==G.values.wip,ea=-1==G.values.status,et=async()=>{r({Component:k.Z,props:{functionId:F.J.PurchaseRequisition,recordId:G.values.recordId}})};async function el(){let e=await l({extension:A.y.PurchaseRequisition.close,record:JSON.stringify(G.values)});y.default.success(Q.Closed),L(),ei(e?.recordId)}async function es(){let e=await l({extension:A.y.PurchaseRequisition.reopen,record:JSON.stringify(G.values)});y.default.success(Q.Reopened),L(),ei(e?.recordId)}async function ed(){let e=await l({extension:A.y.PurchaseRequisition.cancel,record:JSON.stringify(G.values)});y.default.success(Q.Cancelled),L(),ei(e?.recordId)}let en=[{key:"Attachment",condition:!0,onClick:"onClickAttachment",disabled:!X},{key:"WorkFlow",condition:!0,onClick:et,disabled:!X},{key:"RecordRemarks",condition:!0,onClick:"onRecordRemarks",disabled:!X},{key:"Close",condition:!ee,onClick:el,disabled:ee||!X||ea},{key:"Reopen",condition:ee,onClick:es,disabled:!ee||ea},{key:"Approval",condition:!0,onClick:"onApproval",disabled:!ee||ea},{key:"Cancel",condition:!0,onClick:ed,disabled:!X||ea}],er=[{field:"sku",headerName:z.sku,flex:1},{field:"itemName",headerName:z.name,flex:1},{field:"siteName",headerName:z.site,flex:1},{field:"muName",headerName:z.measurement,flex:1},{field:"qty",headerName:z.qty,flex:1,type:"number"},{field:"deliveryDate",headerName:z.deliveryDate,flex:1,type:"date"},{field:"vendorName",headerName:z.vendor,flex:1},{field:"unitCost",headerName:z.unitCost,flex:1,type:"number"},{field:"totalCost",headerName:z.totalCost,flex:1,type:"number"}];async function ei(e){let a=await eo(e),t=await eu(e);(function(e,a){let t=0,l=0,s=a?.list?.map(e=>(t+=e?.unitCost*e?.qty,l+=e?.qty||0,e?.seqNo>E&&M(e?.seqNo),{...e,totalCost:(e?.unitCost*e?.qty||0).toFixed(2),unitCost:(e?.unitCost||0).toFixed(2),qty:(e?.qty||0).toFixed(2)}));G.setValues({...e,date:(0,n.a1)(e?.date),deliveryDate:(0,n.a1)(e?.deliveryDate),totalCost:t.toFixed(2),totalQty:l.toFixed(2),items:{list:s}})})(a,t)}async function eo(e){if(!e)return;let a=await t({extension:A.y.PurchaseRequisition.get,parameters:`_recordId=${e}`});return a?.record}async function eu(e){if(e)return await t({extension:A.y.RequisitionDetail.qry,parameters:`_trxId=${e}`})}let ec=a=>{r({Component:S.Z,props:{recordId:e,labels:z,maxAccess:Y,readOnlyField:ee||ea,maxSeqNo:E,seqNo:a?.seqNo,refetchTable:ei},width:800,height:450,title:z.purchaseDetails})},em=async a=>{await l({extension:A.y.RequisitionDetail.del,record:JSON.stringify(a)}),ei(e),y.default.success(Q.Deleted)};return s.jsx(m.Z,{resourceId:x.i.PurchaseRequisition,functionId:F.J.PurchaseRequisition,form:G,maxAccess:Y,editMode:X,actions:en,previewReport:X,disabledSubmit:ee||ea,children:(0,s.jsxs)(q.R,{children:[s.jsx(b.g,{children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:6,children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:12,children:s.jsx(C.Z,{endpointId:f.r.DocumentType.qry,parameters:`_startAt=0&_pageSize=1000&_dgId=${F.J.PurchaseRequisition}`,filter:X?void 0:e=>1===e.activeStatus,name:"dtId",label:z.docType,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:ee||ea,valueField:"recordId",displayField:["reference","name"],values:G.values,maxAccess:!X&&Y,onChange:async(e,a)=>{await B(a),G.setFieldValue("dtId",a?.recordId||null)},error:G.touched.dtId&&!!G.errors.dtId})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(I.Z,{name:"reference",label:z.reference,value:G?.values?.reference,maxAccess:!X&&Y,readOnly:X,onChange:G.handleChange,onClear:()=>G.setFieldValue("reference",""),error:G.touched.reference&&!!G.errors.reference})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(d.Z,{name:"date",label:z.date,readOnly:ee||ea,value:G?.values?.date,onChange:G.setFieldValue,required:!0,maxAccess:Y,onClear:()=>G.setFieldValue("date",null),error:G.touched.date&&!!G.errors.date})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(C.Z,{datasetId:R.v.PROCUREMENT_TYPE,name:"procurementType",label:z.procurementType,readOnly:ee||ea,values:G.values,valueField:"key",displayField:"value",required:!0,maxAccess:Y,onChange:(e,a)=>{G.setFieldValue("procurementType",a?.key||null)},error:G.touched.procurementType&&!!G.errors.procurementType})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(g.U,{endpointId:A.y.Vendor.snapshot,valueField:"reference",displayField:"name",name:"vendorId",label:z.vendor,form:G,readOnly:ee||ea,displayFieldWidth:2,valueShow:"vendorRef",secondValueShow:"vendorName",maxAccess:Y,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],onChange:async(e,a)=>{G.setFieldValue("vendorName",a?.name||""),G.setFieldValue("vendorRef",a?.reference||""),G.setFieldValue("vendorId",a?.recordId||null)},errorCheck:"vendorId"})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(C.Z,{endpointId:O.K.DepartmentFilters.qry,parameters:"_filter=&_size=1000&_startAt=0&_type=0&_activeStatus=0&_sortBy=recordId",name:"departmentId",readOnly:ee||ea,label:z.department,values:G.values,columnsInDropDown:[{key:"departmentRef",value:"Reference"},{key:"name",value:"Name"}],displayField:["departmentRef","name"],maxAccess:Y,onChange:(e,a)=>{G.setFieldValue("departmentId",a?.recordId||null)},error:G.touched.departmentId&&!!G.errors.departmentId})}),s.jsx(i(),{item:!0,xs:2,children:s.jsx(Z.Z,{onClick:ec,style:{border:"1px solid #4eb558"},color:"transparent",image:"add.png",disabled:!X||ee})})]})}),s.jsx(i(),{item:!0,xs:6,children:(0,s.jsxs)(i(),{container:!0,spacing:2,children:[s.jsx(i(),{item:!0,xs:12,children:s.jsx(C.Z,{endpointId:j.$.Site.qry,name:"siteId",readOnly:ee||ea,label:z.site,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:G.values,valueField:"recordId",displayField:["reference","name"],maxAccess:Y,onChange:(e,a)=>{G.setFieldValue("siteId",a?.recordId||null)},error:G.touched.siteId&&!!G.errors.siteId})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(d.Z,{name:"deliveryDate",label:z.deliveryDate,readOnly:ee||ea,value:G?.values?.deliveryDate,onChange:G.setFieldValue,maxAccess:Y,onClear:()=>G.setFieldValue("deliveryDate",null),error:G.touched.deliveryDate&&!!G.errors.deliveryDate})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(C.Z,{endpointId:f.r.Plant.qry,name:"plantId",label:z.plant,readOnly:ee||ea,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:G.values,valueField:"recordId",displayField:["reference","name"],maxAccess:Y,onChange:(e,a)=>{G.setFieldValue("plantId",a?.recordId||null)},error:G.touched.plantId&&!!G.errors.plantId})}),s.jsx(i(),{item:!0,xs:12,children:s.jsx(p.Z,{name:"notes",label:z.notes,value:G?.values?.notes,rows:2.5,readOnly:ee||ea,maxAccess:Y,onChange:G.handleChange,onClear:()=>G.setFieldValue("notes",""),error:G.touched.notes&&!!G.errors.notes})})]})})]})}),s.jsx(D.Q,{children:s.jsx(o.Z,{name:"itemTable",columns:er,gridData:G.values.items,rowId:["recordId"],onEdit:ec,onDelete:ee||ea?void 0:em,maxAccess:Y,pagination:!1})}),s.jsx(b.g,{children:(0,s.jsxs)(i(),{container:!0,justifyContent:"flex-end",spacing:2,children:[s.jsx(i(),{item:!0,children:s.jsx($.Z,{name:"totalQty",label:z.totalQty,value:G.values.totalQty,readOnly:!0})}),s.jsx(i(),{item:!0,children:s.jsx($.Z,{name:"totalCost",label:z.totalCost,value:G.values.totalCost,readOnly:!0})})]})})]})})}[o,m,y,h,v,C,g,k,P,w,N,S,T]=Q.then?(await Q)():Q,J.width=1100,J.height=700,l()}catch(e){l(e)}})}};