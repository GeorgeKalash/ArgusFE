"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[47441],{47441:function(e,r,a){var t=a(52322),l=a(89330),n=a(39812),d=a(60218),o=a(95453),i=a(37691),u=a(6640),c=a(2784),s=a(96026),v=a(48601),y=a(82737),m=a(62202),p=a(65950),x=a(71987),f=a(26612),C=a(5088),I=a(21581),h=a(8661),g=a(38449),F=a(7121),R=a(53621),w=a(17627),b=a(24074),O=a(27423),_=a(61802),Z=a(58974),j=a(50023),V=a(23361),k=a(80983),A=a(30390),P=a(39704),S=a(76399),q=a(31389),D=a(33625),M=a(62362),N=a(19473),J=a(98345),T=a(96333),E=a(91088),W=a(21326),U=a(67920),B=a(91406),L=a(1685);let z=e=>{var r,a,z,G,H,Q,X,Y,$,K,ee,er,ea,et,el;let{recordId:en,window:ed}=e,{platformLabels:eo,userDefaultsData:ei}=(0,c.useContext)(N.l),{getRequest:eu,postRequest:ec}=(0,c.useContext)(p.$),{stack:es}=(0,s.V)(),[ev,ey]=(0,c.useState)(F.J.CurrencyCreditOrderPurchase),[em,ep]=(0,c.useState)(null),{stack:ex}=(0,_.zY)(),ef=(0,L.m)("userData").userId,eC=parseInt(null==ei?void 0:null===(a=ei.list)||void 0===a?void 0:null===(r=a.find(e=>{let{key:r}=e;return"plantId"===r}))||void 0===r?void 0:r.value),{labels:eI,access:eh}=(0,j.Z)({datasetId:f.i.CreditOrder,editMode:!!en});(0,W.Z)({title:eI.creditOrder,window:ed});let{maxAccess:eg}=(0,J.H)({functionId:ev,access:eh,enabled:!en,hasDT:!1}),eF=(0,x.E)({endpointId:w.s.CreditOrder.page}),{schema:eR,requiredFields:ew}=(0,U.m)({currencyRef:e=>null==e?void 0:e.currencyRef,currencyName:e=>null==e?void 0:e.currencyName,qty:e=>null==e?void 0:e.qty,exRate:e=>null==e?void 0:e.exRate,amount:e=>null==e?void 0:e.amount},!0,eg,"rows"),{formik:eb}=(0,k.c)({maxAccess:eg,initialValues:{recordId:en,currencyId:null,currencyRef:"",date:new Date,functionId:F.J.CurrencyCreditOrderPurchase,deliveryDate:new Date,reference:"",dtId:null,plantId:parseInt(eC),corId:null,corRef:"",corName:"",wip:1,status:1,releaseStatus:"",notes:"",amount:0,baseAmount:0,exRate:1,rateCalcMethod:"",rateType:"",isTFRClicked:!1,rows:[{id:1,orderId:en||null,seqNo:"",currencyId:null,qty:"",rateCalcMethod:"",exRate:"",minRate:"",maxRate:"",defaultRate:"",amount:"",baseAmount:"",notes:"",goc:!1}]},validateOnChange:!0,validationSchema:v.Ry({date:v.Z_().required(),plantId:v.Z_().required(),corId:v.Z_().required(),rows:v.IX().of(eR)}),onSubmit:async e=>{var r;let a={...e,date:(0,n.ku)(e.date),deliveryDate:(0,n.ku)(e.deliveryDate),amount:eA,baseAmount:eP};delete a.rows;let t=null===(r=eb.values.rows.filter(e=>{var r;return null===(r=Object.values(ew))||void 0===r?void 0:r.every(r=>r(e))}))||void 0===r?void 0:r.map((e,r)=>({...e,seqNo:r+1,orderId:eb.values.recordId||0})),l=await ec({extension:w.s.CreditOrder.set,record:JSON.stringify({header:a,items:t})}),d=e.recordId?eo.Edited:eo.Added;m.ZP.success(d),await eL(null==l?void 0:l.recordId),eF()}}),eO=2==eb.values.wip,e_=3===eb.values.releaseStatus&&3!==eb.values.status,eZ=!!eb.values.recordId,ej=async()=>{let e=await ec({extension:w.s.CreditOrder.close,record:JSON.stringify(eb.values)});m.ZP.success(eo.Closed),eF(),eL(null==e?void 0:e.recordId)},eV=async()=>{let e=await ec({extension:w.s.CreditOrder.reopen,record:JSON.stringify(eb.values)});m.ZP.success(eo.Closed),eF(),eL(null==e?void 0:e.recordId)},ek=async()=>{let e=await ec({extension:w.s.CreditOrder.tfr,record:JSON.stringify(eb.values)});m.ZP.success(eo.Generated),eF(),await eL(eb.values.recordId),ed.close(),ex({Component:Z.Z,props:{recordId:null==e?void 0:e.recordId}})},eA=(null==eb?void 0:null===(G=eb.values)||void 0===G?void 0:null===(z=G.rows)||void 0===z?void 0:z.length)?eb.values.rows.reduce((e,r)=>{var a;return e+(parseFloat(null===(a=r.amount)||void 0===a?void 0:a.toString().replace(/,/g,""))||0)},0):0,eP=(null==eb?void 0:null===(Q=eb.values)||void 0===Q?void 0:null===(H=Q.rows)||void 0===H?void 0:H.length)?eb.values.rows.reduce((e,r)=>{var a;return e+(parseFloat(null===(a=r.baseAmount)||void 0===a?void 0:a.toString().replace(/,/g,""))||0)},0):0,eS=async(e,r,a)=>{var t,l,n,d;if(!e)return;let o=await eu({extension:R.d.Correspondent.get,parameters:"_recordId=".concat(e)});eb.setFieldValue("currencyId",(null==o?void 0:null===(t=o.record)||void 0===t?void 0:t.currencyId)||null),eb.setFieldValue("currencyRef",(null==o?void 0:null===(l=o.record)||void 0===l?void 0:l.currencyRef)||"");let i=await eu({extension:b.u.Defaults.get,parameters:"_key=ct_credit_eval_ratetype_id"});eD(a,null==o?void 0:null===(n=o.record)||void 0===n?void 0:n.currencyId,r,null==i?void 0:null===(d=i.record)||void 0===d?void 0:d.value)},eq=async e=>{var r;let a=await eu({extension:g.r.UserFunction.get,parameters:"_userId=".concat(ef,"&_functionId=").concat(e)});eb.setFieldValue("dtId",null==a?void 0:null===(r=a.record)||void 0===r?void 0:r.dtId)};async function eD(e,r,a,t){var l,n,d,o,i;if(!e||!r||!t||!a){e||es({message:eI.emptyPlant}),r||(eb.setFieldValue("corId",null),eb.setFieldValue("corRef",""),eb.setFieldValue("corName",""),es({message:eI.emptyToCurrency})),t||es({message:eI.emptyRate}),a||es({message:eI.emptyFromCurrency});return}let u=await eu({extension:b.u.ExchangeMap.get,parameters:"_plantId=".concat(e,"&_currencyId=").concat(r,"&_raCurrencyId=").concat(a,"&_rateTypeId=").concat(t)});if(!(null==u?void 0:null===(l=u.record)||void 0===l?void 0:l.rate)){es({message:eI.undefinedCorRate});return}eb.setFieldValue("currencyId",r),eb.setFieldValue("exRate",null==u?void 0:null===(n=u.record)||void 0===n?void 0:n.rate),eb.setFieldValue("rateCalcMethod",null==u?void 0:null===(d=u.record)||void 0===d?void 0:d.rateCalcMethod),eb.setFieldValue("minRate",null==u?void 0:null===(o=u.record)||void 0===o?void 0:o.minRate),eb.setFieldValue("maxRate",null==u?void 0:null===(i=u.record)||void 0===i?void 0:i.maxRate)}async function eM(e){for(let r in e)if(!e[r]){es({message:"".concat(r," ").concat(eI.empty)});return}let r=await eu({extension:b.u.ExchangeMap.get,parameters:"_plantId=".concat(e.plantId,"&_currencyId=").concat(e.fromCurrency,"&_raCurrencyId=").concat(e.toCurrency,"&_rateTypeId=").concat(e.rateType)});return null==r?void 0:r.record}let eN=[{component:"resourcecombobox",label:eI.currency,name:"currencyRef",flex:2,props:{endpointId:g.r.Currency.qry,displayField:"reference",valueField:"recordId",mapping:[{from:"recordId",to:"currencyId"},{from:"reference",to:"currencyRef"},{from:"name",to:"currencyName"}],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],displayFieldWidth:3},async onChange(e){var r,a,t;let{row:{update:l,oldRow:n,newRow:d}}=e;if(!(null==d?void 0:d.currencyId))return;let o=await eM({plantId:eC||eb.values.plantId,toCurrency:null==eb?void 0:null===(r=eb.values)||void 0===r?void 0:r.currencyId,fromCurrency:null==d?void 0:d.currencyId,rateType:null==eb?void 0:null===(a=eb.values)||void 0===a?void 0:a.rateType});if(!(null==o?void 0:o.rate)){l({exRate:0,defaultRate:0,amount:0,baseAmount:0}),es({message:"".concat(eI.undefinedRate," ").concat(null==d?void 0:d.currencyRef,".")});return}let i=0,u=0;if(null==d?void 0:d.qty){let e=parseFloat(null==d?void 0:null===(t=d.qty)||void 0===t?void 0:t.toString().replace(/,/g,""))||0,r=1===o.rateCalcMethod?e*o.rate:2===o.rateCalcMethod?e/o.rate:0;i=parseFloat(r).toFixed(2),u=parseFloat(1===eb.values.rateCalcMethod?r*eb.values.exRate:2===eb.values.rateCalcMethod?r/eb.values.exRate:0).toFixed(2)}let c=await eJ(null==d?void 0:d.currencyId);l({currencyId:o.currencyId,currencyName:o.currencyName,exRate:o.rate.toFixed(7),defaultRate:o.rate.toFixed(7),rateCalcMethod:o.rateCalcMethod,minRate:o.minRate,maxRate:o.maxRate,goc:(null==c?void 0:c.goc)||!1,amount:i,baseAmount:u})}},{component:"textfield",label:eI.name,name:"currencyName",props:{readOnly:!0},flex:3},{component:"numberfield",label:eI.quantity,name:"qty",flex:2,updateOn:"blur",async onChange(e){var r,a;let{row:{update:t,newRow:l}}=e,n=l.rateCalcMethod,d=1===n?parseFloat(null==l?void 0:null===(r=l.qty)||void 0===r?void 0:r.toString().replace(/,/g,""))*(null==l?void 0:l.exRate):2===n?parseFloat(null==l?void 0:null===(a=l.qty)||void 0===a?void 0:a.toString().replace(/,/g,""))/(null==l?void 0:l.exRate):0,o=1===eb.values.rateCalcMethod?parseFloat(d)*eb.values.exRate:2===n?parseFloat(d)/eb.values.exRate:0;t({amount:parseFloat(d).toFixed(2),baseAmount:parseFloat(o).toFixed(2),qty:parseFloat(null==l?void 0:l.qty).toFixed(2)})}},{component:"numberfield",label:eI.defaultRate,name:"defaultRate",props:{readOnly:!0},flex:2},{component:"numberfield",label:eI.exRate,name:"exRate",props:{decimalScale:7},flex:2,updateOn:"blur",async onChange(e){let{row:{update:r,newRow:a}}=e;if(!a.currencyId||!a.exRate){r({exRate:"",defaultRate:"",amount:0,baseAmount:0});return}let t=e=>parseFloat(null==e?void 0:e.toString().replace(/,/g,""))||0,l=t(a.exRate);if(l>0){let e=t(a.minRate),n=t(a.maxRate);if(l>=e&&l<=n){let e=t(a.qty),n=a.rateCalcMethod,d=1===n?e*l:2===n?e/l:0,o=1===eb.values.rateCalcMethod?d*eb.values.exRate:2===eb.values.rateCalcMethod?d/eb.values.exRate:0;r({exRate:l.toFixed(7),amount:d.toFixed(2),baseAmount:o.toFixed(2)})}else es({message:"".concat(l," ").concat(eI.invalidRange," [").concat(e,"-").concat(n,"]")}),r({exRate:"",amount:0,baseAmount:0})}}},{component:"numberfield",label:"".concat(eI.total," ").concat(eb.values.currencyRef||""),name:"amount",props:{readOnly:!0},flex:2}];async function eJ(e){if(!e)return;let r=await eu({extension:R.d.CorrespondentCurrency.get,parameters:"_corId=".concat(eb.values.corId,"&_currencyId=").concat(e)});return null==r?void 0:r.record}let eT=async e=>{var r;let a=await eu({extension:w.s.CreditOrderItem.qry,parameters:"_orderId=".concat(e)});return(null==a?void 0:null===(r=a.list)||void 0===r?void 0:r.length)>0?a.list.map((e,r)=>({...e,id:r+1,qty:parseFloat(null==e?void 0:e.qty).toFixed(2),amount:parseFloat(null==e?void 0:e.amount).toFixed(2),baseAmount:parseFloat(null==e?void 0:e.baseAmount).toFixed(2),exRate:parseFloat(null==e?void 0:e.exRate).toFixed(7),defaultRate:parseFloat(null==e?void 0:e.defaultRate).toFixed(7)})):eb.initialValues.rows};async function eE(e){if(e==F.J.CurrencyCreditOrderPurchase||e==F.J.CurrencyCreditOrderSale){var r;let a=await eu({extension:b.u.Defaults.get,parameters:e==F.J.CurrencyCreditOrderPurchase?"_key=ct_credit_purchase_ratetype_id":e==F.J.CurrencyCreditOrderSale?"_key=ct_credit_sales_ratetype_id":""});eb.setFieldValue("rateType",null==a?void 0:null===(r=a.record)||void 0===r?void 0:r.value),eb.setFieldValue("functionId",e)}}async function eW(){var e,r;let a=await eu({extension:g.r.Defaults.get,parameters:"_key=baseCurrencyId"});return await eU(null==a?void 0:null===(e=a.record)||void 0===e?void 0:e.value),null==a?void 0:null===(r=a.record)||void 0===r?void 0:r.value}let eU=async e=>{eu({extension:g.r.Currency.get,parameters:"_recordId=".concat(e)}).then(e=>{var r;ep(null==e?void 0:null===(r=e.record)||void 0===r?void 0:r.reference)})};async function eB(e){return await await eu({extension:w.s.CreditOrder.get,parameters:"_recordId=".concat(e)})}async function eL(e){let r=await eB(e),a=await eT(e);eb.setValues(e=>{var t;return{...e,...r.record,date:(0,n.a1)(r.record.date),deliveryDate:(null==r?void 0:null===(t=r.record)||void 0===t?void 0:t.deliveryDate)?(0,n.a1)(r.record.deliveryDate):null,rows:a}}),await eE(r.record.functionId)}let ez=async()=>{ex({Component:P.Z,props:{functionId:eb.values.functionId,recordId:eb.values.recordId}})},eG=[{key:"Close",condition:!eO,onClick:ej,disabled:eO||!eZ},{key:"Reopen",condition:eO,onClick:eV,disabled:!eO||!eZ||3===eb.values.releaseStatus&&3===eb.values.status},{key:"Approval",condition:!0,onClick:"onApproval",disabled:!eO},{key:"Invoice",condition:ek,onClick:()=>{ex({Component:V.Z,props:{DialogText:eI.transferMessage,fullScreen:!1,okButtonAction:ek},width:400,height:150,title:""})},disabled:!e_},{key:"WorkFlow",condition:!0,onClick:ez,disabled:!eZ},{key:"Shipment",condition:!0,onClick:()=>{ex({Component:E.u,props:{recordId:eb.values.recordId,functionId:eb.values.functionId,editMode:1!=eb.values.status,totalBaseAmount:eP}})},disabled:!eZ},{key:"Transportation",condition:!0,onClick:()=>{ex({Component:T.R,props:{recordId:eb.values.recordId,functionId:eb.values.functionId,editMode:1!=eb.values.status}})},disabled:!eZ}];return(0,c.useEffect)(()=>{!async function(){en?(await eL(en),await eW()):(await eE(F.J.CurrencyCreditOrderPurchase),await eq(F.J.CurrencyCreditOrderPurchase))}()},[]),(0,t.jsx)(y.Z,{resourceId:f.i.CreditOrder,form:eb,maxAccess:eg,editMode:eZ,actions:eG,previewReport:eZ,disabledSubmit:eO,children:(0,t.jsxs)(q.R,{children:[(0,t.jsx)(D.g,{children:(0,t.jsxs)(d.ZP,{container:!0,xs:12,spacing:2,children:[(0,t.jsx)(A.Z,{hideonempty:!0,item:!0,xs:4,children:(0,t.jsx)(l.Z,{name:"date",required:!0,readOnly:eO,label:eI.date,value:null==eb?void 0:null===(X=eb.values)||void 0===X?void 0:X.date,onChange:eb.setFieldValue,maxAccess:eg,onClear:()=>eb.setFieldValue("date",null),error:eb.touched.date&&!!eb.errors.date})}),(0,t.jsx)(d.ZP,{item:!0,xs:4,children:(0,t.jsx)(h.Z,{endpointId:g.r.Plant.qry,name:"plantId",label:eI.plant,readOnly:!0,values:eb.values,valueField:"recordId",displayField:["reference","name"],required:!0,maxAccess:eg,onChange:(e,r)=>{eb.setFieldValue("plantId",(null==r?void 0:r.recordId)||null)},error:eb.touched.plantId&&!!eb.errors.plantId})}),(0,t.jsx)(d.ZP,{item:!0,xs:4,children:(0,t.jsx)(C.Z,{name:"reference",label:eI.reference,value:null==eb?void 0:null===(Y=eb.values)||void 0===Y?void 0:Y.reference,maxAccess:eg,maxLength:"30",readOnly:eZ,onChange:eb.handleChange,onClear:()=>eb.setFieldValue("reference",""),error:eb.touched.reference&&!!eb.errors.reference})}),(0,t.jsx)(d.ZP,{item:!0,xs:8,children:(0,t.jsx)(O.U,{endpointId:R.d.Correspondent.snapshot,valueField:"reference",displayField:"name",name:"corId",label:eI.correspondent,form:eb,required:!0,firstFieldWidth:4,displayFieldWidth:3,valueShow:"corRef",secondValueShow:"corName",readOnly:eO||(null==eb?void 0:null===(K=eb.values)||void 0===K?void 0:null===($=K.rows)||void 0===$?void 0:$.some(e=>!!e.currencyId)),maxAccess:eg,onChange:async(e,r)=>{if(r){let e=await eW();eS(null==r?void 0:r.recordId,e,eb.values.plantId)}eb.setFieldValue("corName",r?r.name:""),eb.setFieldValue("corRef",r?r.reference:""),eb.setFieldValue("corId",r?r.recordId:null)},errorCheck:"corId"})}),(0,t.jsx)(d.ZP,{item:!0,xs:4,children:(0,t.jsx)(l.Z,{name:"deliveryDate",readOnly:eO,label:eI.deliveryDate,value:null==eb?void 0:null===(ee=eb.values)||void 0===ee?void 0:ee.deliveryDate,onChange:eb.setFieldValue,maxAccess:eg,disabledRangeDate:{date:eb.values.date,day:30},onClear:()=>eb.setFieldValue("deliveryDate",null),error:eb.touched.deliveryDate&&!!eb.errors.deliveryDate})}),(0,t.jsx)(d.ZP,{item:!0,xs:6,children:(0,t.jsxs)(o.Z,{row:!0,value:eb.values.functionId,defaultValue:F.J.CurrencyCreditOrderPurchase,onChange:async e=>{await eE(e.target.value),await eq(e.target.value),ey(e.target.value),eb.setFieldValue("reference","")},children:[(0,t.jsx)(i.Z,{value:F.J.CurrencyCreditOrderPurchase,control:(0,t.jsx)(u.Z,{}),label:eI.purchase,disabled:null==eb?void 0:null===(ea=eb.values)||void 0===ea?void 0:null===(er=ea.rows)||void 0===er?void 0:er.some(e=>!!e.currencyId)}),(0,t.jsx)(i.Z,{value:F.J.CurrencyCreditOrderSale,control:(0,t.jsx)(u.Z,{}),label:eI.sale,disabled:null==eb?void 0:null===(el=eb.values)||void 0===el?void 0:null===(et=el.rows)||void 0===et?void 0:et.some(e=>!!e.currencyId)})]})})]})}),(0,t.jsx)(M.Q,{children:(0,t.jsx)(S._,{onChange:e=>eb.setFieldValue("rows",e),disabled:!eb.values.corId||eO,value:eb.values.rows,name:"rows",error:eb.errors.rows,columns:eN,allowAddNewLine:!eO,maxAccess:eg,allowDelete:!eO,bg:eb.values.functionId&&(eb.values.functionId!=F.J.CurrencyCreditOrderPurchase?"#C7F6C7":"rgb(245, 194, 193)")})}),(0,t.jsx)(D.g,{children:(0,t.jsxs)(d.ZP,{container:!0,spacing:2,xs:12,children:[(0,t.jsx)(A.Z,{item:!0,xs:8,children:(0,t.jsx)(I.Z,{name:"notes",label:eI.notes,value:eb.values.notes,rows:3,maxAccess:eg,readOnly:eO,onChange:e=>eb.setFieldValue("notes",e.target.value),onClear:()=>eb.setFieldValue("notes",""),error:eb.touched.notes&&!!eb.errors.notes})}),(0,t.jsx)(d.ZP,{item:!0,xs:4,children:(0,t.jsxs)(d.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(d.ZP,{item:!0,xs:12,children:(0,t.jsx)(B.Z,{name:"totalCUR",label:"".concat(eI.total," ").concat(eb.values.currencyRef||""),value:eA,readOnly:!0,align:"right"})}),(0,t.jsx)(d.ZP,{item:!0,xs:12,children:(0,t.jsx)(B.Z,{name:"baseAmount",label:"".concat(eI.total," ").concat(em||""),value:eP,readOnly:!0,align:"right"})})]})})]})})]})})};z.width=1e3,z.height=650,r.Z=z}}]);