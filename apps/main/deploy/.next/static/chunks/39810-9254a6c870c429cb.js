"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[39810],{39810:function(e,n,a){a.d(n,{Z:function(){return _}});var l=a(52322),t=a(60218),r=a(2784),o=a(48601),d=a(82737),s=a(62202),i=a(65950),u=a(71987),c=a(26612),m=a(5088),v=a(80983),p=a(19473),y=a(31389),x=a(89330),h=a(8661),I=a(38449),f=a(7121),C=a(84100),F=a(25870),b=a(91406),A=a(2119),g=a(21581),k=a(98345),P=a(39812),O=a(39704),Z=a(61802),T=a(30657),w=a(33625),V=a(76399),j=a(14027),R=a(23361),N=a(50023),q=a(21326);function _(e){var n,_,D,M,S,E,H,J,B,G,L,W,Y,z;let{recordId:U,window:X}=e,{getRequest:$,postRequest:K}=(0,r.useContext)(i.$),{platformLabels:Q,defaultsData:ee,userDefaultsData:en}=(0,r.useContext)(p.l),{stack:ea}=(0,Z.zY)(),{labels:el,access:et}=(0,N.Z)({datasetId:c.i.PaymentOrderExpenses,editMode:!!U}),{documentType:er,maxAccess:eo,changeDT:ed}=(0,k.H)({functionId:f.J.PaymentOrder,access:et,enabled:!U});(0,q.Z)({title:el.PaymentOrderExpenses,window:X});let es=(0,u.E)({endpointId:F.H.PaymentOrders.page3}),ei=parseInt(null==en?void 0:null===(_=en.list)||void 0===_?void 0:null===(n=_.find(e=>"plantId"===e.key))||void 0===n?void 0:n.value),eu=parseInt(null==ee?void 0:null===(M=ee.list)||void 0===M?void 0:null===(D=M.find(e=>"currencyId"===e.key))||void 0===D?void 0:D.value),ec=parseInt(null==en?void 0:null===(E=en.list)||void 0===E?void 0:null===(S=E.find(e=>"cashAccountId"===e.key))||void 0===S?void 0:S.value),{formik:em}=(0,v.c)({documentType:{key:"dtId",value:null==er?void 0:er.dtId,reference:null==er?void 0:er.reference},initialValues:{recordId:null,reference:"",accountType:3,currencyId:parseInt(eu),paymentMethod:null,date:new Date,amount:null,notes:"",subTotal:null,exRate:1,rateCalcMethod:1,baseAmount:null,dtId:null,status:1,releaseStatus:null,cashAccountId:parseInt(ec),plantId:parseInt(ei),expenses:[{id:1,pvId:U||0,seqNo:1,etId:"",subTotal:null,vatAmount:null,amount:null,supplierName:"",taxRef:"",notes:"",isVAT:!1,hasCostCenters:!1,costCenters:[]}]},maxAccess:eo,validateOnChange:!0,validationSchema:o.Ry({accountType:o.Rx().required(),currencyId:o.Rx().required(),date:o.hT().required(),paymentMethod:o.Rx().required(),expenses:o.IX().of(o.Ry().shape({etId:o.Rx().required(),amount:o.Rx().required()})).required()}),onSubmit:async e=>{let n=[],a=em.values.expenses.map((e,a)=>{let{costCenters:l,...t}=e;return l&&n.push(...l),{...t,seqNo:a+1,pvId:em.values.recordId||0}}),l={header:{...e,date:(0,P.ku)(e.date),amount:ev,baseAmount:ev},items:a,costCenters:n},t=await K({extension:F.H.PaymentOrders.set2,record:JSON.stringify(l)});e.recordId?s.ZP.success(Q.Edited):s.ZP.success(Q.Added),eI(t.recordId),es()}}),ev=null===(J=em.values)||void 0===J?void 0:null===(H=J.expenses)||void 0===H?void 0:H.reduce((e,n)=>{var a;return e+(parseFloat(null===(a=n.amount)||void 0===a?void 0:a.toString().replace(/,/g,""))||0)},0),ep=async e=>{if(!e)return null;{let{record:n}=await $({extension:A.G.CbBankAccounts.get,parameters:"_recordId=".concat(e)});return em.setFieldValue("cashAccountId",(null==n?void 0:n.recordId)||null),em.setFieldValue("cashAccountRef",n.reference||""),em.setFieldValue("cashAccountName",n.name||""),n.paymentMethod}},ey=-1===em.values.status,ex=2==em.values.wip,eh=!!em.values.recordId;async function eI(e){var n;let a=await $({extension:F.H.PaymentOrders.get,parameters:"_recordId=".concat(e)}),l=await $({extension:F.H.PaymentOrdersExpenses.qry2,parameters:"_poId=".concat(e)}),t=await Promise.all(null==l?void 0:null===(n=l.list)||void 0===n?void 0:n.map(async n=>{let a=await eg(e,n.seqNo);return{...n,id:n.seqNo,isVAT:0!=n.vatAmount,hasCostCenters:!1,costCenters:a}}));return em.setValues({...a.record,date:(0,P.a1)(a.record.date),expenses:t}),a.record}async function ef(e){if(e){var n,a,l;let t=await $({extension:F.H.FIDocTypeDefaults.get,parameters:"_dtId=".concat(e)});em.setFieldValue("plantId",(null==t?void 0:null===(n=t.record)||void 0===n?void 0:n.plantId)||ei||null);let r=await ep((null==t?void 0:null===(a=t.record)||void 0===a?void 0:a.cashAccountId)||ec);em.setFieldValue("paymentMethod",(null==t?void 0:null===(l=t.record)||void 0===l?void 0:l.paymentMethod)||r||null)}}(0,r.useEffect)(()=>{var e,n;(null===(e=em.values)||void 0===e?void 0:e.dtId)&&!U&&ef(null===(n=em.values)||void 0===n?void 0:n.dtId)},[null===(B=em.values)||void 0===B?void 0:B.dtId]),(0,r.useEffect)(()=>{!async function(){await eO(),U?await eI(U):ep(ec)}()},[]);let eC=async()=>{ea({Component:O.Z,props:{functionId:f.J.PaymentOrder,recordId:em.values.recordId},width:950,title:el.WorkFlow})},eF=async()=>{let e=await K({extension:F.H.PaymentOrders.cancel,record:JSON.stringify(em.values)});s.ZP.success(Q.Cancelled),es(),eI(e.recordId)},eb=async()=>{let e=await K({extension:F.H.PaymentOrders.close,record:JSON.stringify(em.values)});s.ZP.success(Q.Closed),es(),eI(e.recordId)},eA=null===(L=em.values)||void 0===L?void 0:null===(G=L.expenses)||void 0===G?void 0:G.reduce((e,n)=>{var a;return e+(parseFloat(null===(a=n.subTotal)||void 0===a?void 0:a.toString().replace(/,/g,""))||0)},0),eg=async(e,n)=>{var a;let l=await $({extension:F.H.PaymentOrdersCostCenters.qry,parameters:"_poId=".concat(e,"&_seqNo=").concat(n)});return null==l?void 0:null===(a=l.list)||void 0===a?void 0:a.map(e=>({...e,id:e.ccSeqNo}))},ek=[{key:"Cancel",condition:!0,onClick:function(){ea({Component:R.Z,props:{DialogText:Q.CancelConf,okButtonAction:eF,fullScreen:!1,close:!0},width:400,height:150,title:Q.Confirmation})},disabled:!eh||ey||ex},{key:"RecordRemarks",condition:!0,onClick:"onRecordRemarks",disabled:!eh},{key:"WorkFlow",condition:!0,onClick:eC,disabled:!eh},{key:"Attachment",condition:!0,onClick:"onClickAttachment",disabled:!eh},{key:"Close",condition:!ex,onClick:eb,disabled:ex||!eh||ey},{key:"Reopen",condition:ex,onClick:async()=>{let e=await K({extension:F.H.PaymentOrders.reopen,record:JSON.stringify(em.values)});s.ZP.success(Q.Reopened),es(),eI(e.recordId)},disabled:!ex||ey},{key:"Approval",condition:!0,onClick:"onApproval",disabled:!ex}],eP=null==em?void 0:null===(Y=em.values)||void 0===Y?void 0:null===(W=Y.expenses)||void 0===W?void 0:W.reduce((e,n)=>{var a;return e+(parseFloat(null===(a=n.vatAmount)||void 0===a?void 0:a.toString().replace(/,/g,""))||0)},0);async function eO(){var e,n;let a=await $({extension:I.r.Defaults.get,parameters:"_filter=&_key=vatPct"});return em.setFieldValue("vatPct",null!==(e=parseInt(a.record.value))&&void 0!==e?e:0),null!==(n=parseInt(a.record.value))&&void 0!==n?n:0}let eZ=[{component:"resourcelookup",label:el.expenseType,name:"reference",props:{valueField:"reference",displayField:"reference",displayFieldWidth:4,endpointId:F.H.ExpenseTypes.snapshot,mapping:[{from:"recordId",to:"etId"},{from:"name",to:"etName"},{from:"reference",to:"etRef"}],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:ey||ex}},{component:"textfield",label:el.expenseName,name:"etName",props:{readOnly:!0}},{component:"checkbox",label:el.isVAT,name:"isVAT",props:{disabled:ey||ex},async onChange(e){let{row:{update:n,newRow:a}}=e;if(a.isVAT){let e=await eO();if(!a.amount)return;let l=((null==a?void 0:a.amount)||0)*(100/(100+(e||0)))||0;n({subTotal:parseFloat(l||0).toFixed(2),vatAmount:(parseFloat((null==a?void 0:a.amount)||0)-parseFloat(l||0)).toFixed(2)})}else n({subTotal:parseFloat(a.amount||0),vatAmount:0})}},{component:"numberfield",label:el.amount,name:"amount",props:{readOnly:ey},async onChange(e){let{row:{update:n,newRow:a}}=e;if(a.isVAT){let e=parseFloat(a.amount||0)*(100/(100+em.values.vatPct||0));n({subTotal:parseFloat(e||0).toFixed(2),vatAmount:(parseFloat(a.amount||0)-parseFloat(e||0)).toFixed(2)})}else n({subTotal:parseFloat(a.amount||0),vatAmount:0})}},{component:"numberfield",label:el.vat,name:"vatAmount",props:{readOnly:!0}},{component:"numberfield",label:el.subtotal,name:"subTotal",props:{readOnly:!0}},{component:"textfield",label:el.vendorName,name:"supplierName",props:{readOnly:ey}},{component:"numberfield",label:el.vatNo,name:"taxRef",props:{readOnly:ey}},{component:"textfield",label:el.notes,name:"notes",props:{readOnly:ey}},{component:"button",name:"hasCostCenters",props:{imgSrc:a(9130).default.src},label:el.costCenter,onClick:(e,n,a,l)=>{ea({Component:j.Z,props:{maxAccess:eo,labels:el,recordId:U,row:n,updateRow:l,readOnly:ey||ex},width:700,height:600,title:el.costCenter})}}];return(0,l.jsx)(d.Z,{resourceId:c.i.PaymentOrderExpenses,form:em,maxAccess:eo,editMode:eh,previewReport:eh,actions:ek,functionId:f.J.PaymentOrder,disabledSubmit:ey||ex,children:(0,l.jsxs)(y.R,{children:[(0,l.jsx)(w.g,{children:(0,l.jsxs)(t.ZP,{container:!0,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsxs)(t.ZP,{container:!0,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(h.Z,{endpointId:I.r.DocumentType.qry,parameters:"_dgId=".concat(f.J.PaymentOrder,"&_startAt=",0,"&_pageSize=",50),filter:eh?void 0:e=>1===e.activeStatus,name:"dtId",label:el.documentType,readOnly:eh,valueField:"recordId",displayField:"name",values:em.values,onChange:async(e,n)=>{await ed(n),em.setFieldValue("dtId",(null==n?void 0:n.recordId)||null)},error:em.touched.dtId&&!!em.errors.dtId,maxAccess:eo})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(h.Z,{endpointId:I.r.Currency.qry,name:"currencyId",label:el.currency,filter:e=>1===e.currencyType,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],required:!0,readOnly:ex||ey,values:em.values,onChange:(e,n)=>{em.setFieldValue("currencyId",(null==n?void 0:n.recordId)||null)},error:em.touched.currencyId&&!!em.errors.currencyId})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(h.Z,{datasetId:C.v.FI_PV_GROUP_TYPE,name:"accountType",filter:e=>3==e.key,label:el.accountType,valueField:"key",displayField:"value",values:em.values,required:!0,readOnly:!0,maxAccess:eo,onChange:(e,n)=>{em.setFieldValue("accountType",(null==n?void 0:n.key)||null)},error:em.touched.accountType&&!!em.errors.accountType})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(x.Z,{name:"date",label:el.date,value:em.values.date,required:!0,onChange:(e,n)=>{em.setFieldValue("date",n)},onClear:()=>em.setFieldValue("date",null),readOnly:ex||ey,error:em.touched.date&&!!em.errors.date,maxAccess:eo})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(h.Z,{datasetId:C.v.PAYMENT_METHOD,name:"paymentMethod",label:el.paymentMethod,valueField:"key",displayField:"value",values:em.values,required:!0,readOnly:ex||ey,maxAccess:eo,onChange:(e,n)=>{(null==n?void 0:n.key)||em.setFieldValue("cashAccountId",""),em.setFieldValue("paymentMethod",(null==n?void 0:n.key)||null)},error:em.touched.paymentMethod&&!!em.errors.paymentMethod})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(h.Z,{endpointId:I.r.Plant.qry,name:"plantId",label:el.plant,valueField:"recordId",readOnly:ex||ey,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:em.values,onChange:(e,n)=>{em.setFieldValue("plantId",(null==n?void 0:n.recordId)||null)},error:em.touched.plantId&&!!em.errors.plantId})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsx)(h.Z,{endpointId:A.G.CashAccount.qry,parameters:"_type=0",name:"cashAccountId",readOnly:ex||ey,label:el.cashAccount,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:em.values,maxAccess:eo,onChange:(e,n)=>{em.setFieldValue("cashAccountId",(null==n?void 0:n.recordId)||null)},error:em.touched.cashAccountId&&!!em.errors.cashAccountId})})]})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsxs)(t.ZP,{container:!0,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(m.Z,{name:"reference",label:el.reference,value:em.values.reference,readOnly:eh,maxAccess:!eh&&eo,maxLength:"15",onChange:em.handleChange,onClear:()=>em.setFieldValue("reference",""),error:em.touched.reference&&!!em.errors.reference})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(b.Z,{name:"vatAmount",label:el.vat,value:eP,readOnly:!0,maxAccess:eo,onChange:em.handleChange,onClear:()=>em.setFieldValue("vatAmount",""),error:em.touched.vatAmount&&!!em.errors.vatAmount})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(b.Z,{name:"subTotal",label:el.subtotal,value:eA,readOnly:!0,maxAccess:eo,onChange:em.handleChange,onClear:()=>em.setFieldValue("subTotal",""),error:em.touched.subTotal&&!!em.errors.subTotal})}),(0,l.jsx)(t.ZP,{item:!0,xs:6,children:(0,l.jsx)(b.Z,{name:"amount",label:el.amount,maxLength:"10",decimalScale:2,readOnly:!0,value:ev,maxAccess:eo,onChange:async e=>{var n,a,l;let t=(0,T.fB)({amount:null!==(l=e.target.value)&&void 0!==l?l:0,exRate:null===(n=em.values)||void 0===n?void 0:n.exRate,baseAmount:0,rateCalcMethod:null===(a=em.values)||void 0===a?void 0:a.rateCalcMethod,dirtyField:T.ss});em.setFieldValue("baseAmount",parseFloat(null==t?void 0:t.baseAmount).toFixed(2)||0),em.setFieldValue("amount",e.target.value)},onClear:()=>{em.setFieldValue("amount","")},error:em.touched.amount&&!!em.errors.amount})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsx)(h.Z,{neverPopulate:!0,endpointId:F.H.DescriptionTemplate.qry,name:"templateId",label:el.descriptionTemplate,valueField:"recordId",displayField:"name",values:em.values,onChange:(e,n)=>{let a=em.values.notes||"";(null==n?void 0:n.name)&&em.setFieldValue("notes",""===a?n.name:"".concat(a,"\n").concat(n.name)),em.setFieldValue("templateId",(null==n?void 0:n.recordId)||null)},readOnly:ex||ey,error:em.touched.templateId&&!!em.errors.templateId,maxAccess:eo})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsx)(g.Z,{name:"notes",type:"text",label:el.notes,value:em.values.notes,rows:3,readOnly:ex||ey,maxAccess:eo,onChange:em.handleChange,onClear:()=>em.setFieldValue("notes","")})})]})})]})}),(0,l.jsx)(V._,{onChange:e=>em.setFieldValue("expenses",e),value:em.values.expenses,error:em.errors.expenses,initialValues:null==em?void 0:null===(z=em.initialValues)||void 0===z?void 0:z.expenses[0],columns:eZ,allowDelete:!ex&&!ey,allowAddNewLine:!ex&&!ey})]})})}_.width=1300,_.height=700}}]);