"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[77980],{77980:function(e,n,a){a.d(n,{Z:function(){return I}});var l=a(52322),t=a(2784),o=a(84100),i=a(76399),d=a(26612),s=a(48601),r=a(61802),u=a(60218),c=a(95453),m=a(37691),p=a(6640),v=a(91406),h=a(21581),f=a(5088),x=a(62362),y=a(27423),A=a(65950),b=a(80983),F=a(2119),g=a(19473),C=a(60418),P=a(23925),S=a(45021);let _=e=>{let{DialogText:n,window:a}=e,{platformLabels:o}=(0,t.useContext)(g.l);return(0,l.jsxs)(P.Z,{sx:{display:"flex",flexDirection:"column",height:"100%",maxHeight:"100vh",p:3,boxSizing:"border-box",overflow:"hidden"},children:[(0,l.jsx)(P.Z,{sx:{flexGrow:1,overflowY:"auto",minHeight:0},children:n}),(0,l.jsx)(P.Z,{sx:{display:"flex",justifyContent:"flex-end",pt:2,flexShrink:0},children:(0,l.jsx)(S.Z,{onClick:()=>a.close(),color:"primary",children:o.OK})})]})};_.width=550,_.height=250;var Z=a(96026),k=a(54074),R=a(93542);function j(e){var n,a,o,i,d,P;let{labels:S,data:j,maxAccess:O,amount:I}=e,{getRequestFullEndPoint:w,getRequest:N}=(0,t.useContext)(A.$),{userDefaultsData:T}=(0,t.useContext)(g.l),V=parseInt(null==T?void 0:null===(a=T.list)||void 0===a?void 0:null===(n=a.find(e=>"cashAccountId"===e.key))||void 0===n?void 0:n.value),[q,E]=(0,t.useState)(!1),{stack:U}=(0,r.zY)(),{stack:L}=(0,Z.V)(),{formik:B}=(0,b.c)({maxAccess:O,initialValues:{msgid:null,ecrno:R.env.NEXT_PUBLIC_ECRNO,ecR_RCPT:null==j?void 0:j.reference,amount:(100*I).toString(),a1:"E",a2:"",a3:"",a4:"",a5:"",ipaddressOrPort:R.env.NEXT_PUBLIC_POS_PORT,log:1,posSelected:1,cashAccountId:null,cashAccountRef:null,cashAccountName:null},validateOnChange:!0,validationSchema:s.Ry({cashAccountId:s.Rx().required(),posRef:s.Z_().required()})}),X=[{key:"Received",condition:!0,onClick:D,viewLoader:q,disabled:null==j?void 0:j.viewPosButtons},{key:"Cancel",condition:!0,onClick:Y,disabled:null==j?void 0:j.viewPosButtons}];async function D(){try{let e=await B.validateForm();if(B.setTouched({cashAccountId:!0,posRef:!0}),Object.keys(e).length>0)return;E(!0);let n=await C.Z.post("".concat(R.env.NEXT_PUBLIC_POS_URL,"/api/Ingenico/start_PUR"),B.values);if(n.data){E(!1);let e=n.data.replace(/ /g,"\n");U({Component:_,props:{DialogText:e},expandable:!1,closable:!1})}}catch(e){E(!1),L({message:null==e?void 0:e.message})}}async function Y(){try{let e=await B.validateForm();if(B.setTouched({cashAccountId:!0,posRef:!0}),Object.keys(e).length>0)return;E(!1),await C.Z.get("".concat(R.env.NEXT_PUBLIC_POS_URL,"/api/Ingenico/cancelTransaction"))}catch(e){L({message:null==e?void 0:e.message})}}async function z(){var e,n;if(!V)return;let a=await N({extension:F.G.CashAccount.get,parameters:"_recordId=".concat(V)});B.setFieldValue("cashAccountId",V),B.setFieldValue("cashAccountRef",null==a?void 0:null===(e=a.record)||void 0===e?void 0:e.reference),B.setFieldValue("cashAccountName",null==a?void 0:null===(n=a.record)||void 0===n?void 0:n.name)}return(0,t.useEffect)(()=>{!async function(){await z();let e=await w({endPoint:"".concat(R.env.NEXT_PUBLIC_POS_URL,"/api/Ingenico/checkDevice?_port=").concat(R.env.NEXT_PUBLIC_POS_PORT)});B.setFieldValue("posSelected",(null==e?void 0:e.data)?2:1)}()},[]),(0,l.jsx)(k.Z,{isSaved:!1,onSave:()=>D(),actions:X,disabledSubmit:null==j?void 0:j.viewPosButtons,children:(0,l.jsx)(x.Q,{children:(0,l.jsxs)(u.ZP,{container:!0,spacing:2,children:[(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsx)(f.Z,{name:"reference",readOnly:!0,label:null==S?void 0:S.reference,maxAccess:O,value:null==j?void 0:j.reference})}),(0,l.jsxs)(u.ZP,{item:!0,container:!0,spacing:2,children:[(0,l.jsx)(u.ZP,{item:!0,xs:6,children:(0,l.jsx)(f.Z,{name:"clientName",readOnly:!0,label:null==S?void 0:S.client,value:null==j?void 0:j.clientName,maxAccess:O})}),(0,l.jsx)(u.ZP,{item:!0,xs:6,children:(0,l.jsx)(f.Z,{name:"beneficiaryName",readOnly:!0,label:null==S?void 0:S.beneficiary,value:null==j?void 0:j.beneficiaryName,maxAccess:O})})]}),(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsxs)(c.Z,{row:!0,value:B.values.posSelected,defaultValue:1,children:[(0,l.jsx)(m.Z,{value:1,control:(0,l.jsx)(p.Z,{}),label:S.manualPOS,disabled:2==B.values.posSelected}),(0,l.jsx)(m.Z,{value:2,control:(0,l.jsx)(p.Z,{}),label:S.apiPOS,disabled:1==B.values.posSelected})]})}),(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsx)(y.U,{endpointId:F.G.CashAccount.snapshot,parameters:{_type:2},valueField:"reference",displayField:"name",name:"cashAccountId",label:S.posAccount,form:B,readOnly:2==B.values.posSelected,displayFieldWidth:2,valueShow:"cashAccountRef",secondValueShow:"cashAccountName",editMode:!0,maxAccess:O,errorCheck:"cashAccountId",onChange:(e,n)=>{B.setFieldValue("cashAccountRef",null==n?void 0:n.reference),B.setFieldValue("cashAccountName",null==n?void 0:n.name),B.setFieldValue("cashAccountId",(null==n?void 0:n.recordId)||null)}})}),(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsx)(v.Z,{name:"amount",label:S.amount,value:null==B?void 0:null===(o=B.values)||void 0===o?void 0:o.amount,maxAccess:O,readOnly:!0,error:(null===(i=B.touched)||void 0===i?void 0:i.amount)&&!!(null===(d=B.errors)||void 0===d?void 0:d.amount)})}),(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsx)(f.Z,{name:"posRef",label:null==S?void 0:S.posRef,value:null==B?void 0:B.posRef,maxAccess:O,readOnly:2==B.values.posSelected,onChange:B.handleChange,error:B.touched.posRef&&!!B.errors.posRef})}),(0,l.jsx)(u.ZP,{item:!0,xs:12,children:(0,l.jsx)(h.Z,{name:"remarks",label:S.remarks,value:B.values.remarks,rows:3,maxAccess:O,editMode:!0,onChange:e=>B.setFieldValue("remarks",e.target.value),onClear:()=>B.setFieldValue("remarks",""),error:(null===(P=B.touched)||void 0===P?void 0:P.remarks)&&!!B.errors.remarks})})]})})})}var O=a(50023);function I(e){let{isPosted:n,value:u,amount:c,...m}=e,p=!!m.data.recordId,{labels:v,access:h}=(0,O.Z)({datasetId:null===d.i||void 0===d.i?void 0:d.i.POSPayment,editMode:p}),{stack:f}=(0,r.zY)(),x=[{id:1,seqNo:1,cashAccountId:null,cashAccount:"",posStatus:1,posStatusName:"",type:"",amount:"",paidAmount:"",returnedAmount:0,bankFees:"",receiptRef:""}];(0,t.useEffect)(()=>{let e=s.IX().of(s.Ry().shape({type:s.Z_().required("Type is required").test("unique","Type must be unique",function(e){var n;let{options:a}=this,l=null===(n=a.context)||void 0===n?void 0:n[m.name].map(e=>e.type);return 2!=e||!(l.filter(e=>"2"===e).length>1)}),paidAmount:s.Z_().test("Paid Amount","Paid Amount is required",function(e){return"2"!=this.parent.type||!!e}),returnedAmount:s.Z_().test("Returned Amount","Returned Amount is required",function(e){return"2"!=this.parent.type||!!e}),amount:s.Z_().nullable().required("Amount is required")})).required("Cash array is required");u||m.setFormik({...x,paymentValidation:e})},[m.name,u]);let y=e=>{var n;let a=e.reduce((e,n)=>e+parseFloat(n.paidAmount||0),0),l=c+parseFloat((null==u?void 0:null===(n=u.find(e=>(null==e?void 0:e.type)==="2"))||void 0===n?void 0:n.paidAmount)||0)-parseFloat(a||0),t=e.map(e=>"2"===e.type?{...e,returnedAmount:(parseFloat(a||0)-parseFloat(c)).toFixed(2),amount:l}:e);m.onChange(t)},A=[{component:"resourcecombobox",label:v.type,name:"type",props:{datasetId:o.v.CA_CASH_ACCOUNT_TYPE,displayField:"value",valueField:"key",mapping:[{from:"key",to:"type"},{from:"value",to:"typeName"}],readOnly:n},propsReducer(e){let{row:n,props:a}=e;return{...a,readOnly:n.paidAmount>0}},async onChange(e){let{row:{update:n,newRow:a}}=e,l=u.slice(0,-1).reduce((e,n)=>e+(parseFloat(n.amount.toString().replace(/,/g,""))||0),0);n({amount:(parseFloat(c)-parseFloat(l)).toFixed(2)})}},{component:"numberfield",name:"paidAmount",label:null==v?void 0:v.paidAmount,async onChange(e){var n,a,l;let{row:{update:t,newRow:o,updateRow:i}}=e,d=(null==u?void 0:null===(n=u.reduce((e,n)=>n.id!==o.id?e+parseFloat(n.paidAmount||0):e,0))||void 0===n?void 0:n.toFixed(2))||0,s=(parseFloat(o.paidAmount||0)+parseFloat(d||0)-parseFloat(c||0)).toFixed(2);(null==o?void 0:o.type)!=="2"?(t({returnedAmount:0,amount:o.paidAmount}),i({id:null==u?void 0:null===(a=u.find(e=>(null==e?void 0:e.type)==="2"))||void 0===a?void 0:a.id,changes:{returnedAmount:s||0,amount:c+parseFloat((null==u?void 0:null===(l=u.find(e=>(null==e?void 0:e.type)==="2"))||void 0===l?void 0:l.paidAmount)||0)-parseFloat(d||0)-parseFloat(o.paidAmount||0)}})):t({returnedAmount:s||0,amount:(parseFloat(c||0)-parseFloat(d||0)).toFixed(2)})}},{component:"numberfield",name:"returnedAmount",label:v.returnedAmount,props:{readOnly:!0}},{component:"numberfield",name:"amount",label:null==v?void 0:v.Amount,props:{readOnly:n}},{component:"numberfield",header:v.bankFees,name:"bankFees",label:null==v?void 0:v.bankFees,props:{readOnly:n}},{component:"textfield",header:null==v?void 0:v.receiptRef,name:"receiptRef",label:null==v?void 0:v.receiptRef,props:{readOnly:n}},{component:"resourcecombobox",label:null==v?void 0:v.posStatus,name:"posStatusName",props:{readOnly:!0,datasetId:o.v.RT_POSSTATUS,displayField:"value",valueField:"key",mapping:[{from:"value",to:"posStatusName"},{from:"key",to:"posStatus"}]}},{component:"button",name:"pos",props:{onCondition:e=>3==e.type?{imgSrc:a(29485).default.src,hidden:!1,disabled:!p||3!=e.type}:{imgSrc:"",hidden:!0,disabled:!p||3!=e.type}},label:v.pos,onClick:(e,n)=>{f({Component:j,props:{labels:v,data:m.data,amount:null==n?void 0:n.amount,maxAccess:h},width:700,title:null==v?void 0:v.pos})}}];return(0,l.jsx)(i._,{...m,columns:A,maxAccess:h,onChange:(e,n)=>{m.onChange(e,n),"delete"===n&&Array.isArray(e)&&y(e)},value:u,initialValues:x[0],allowDelete:!m.disabled})}}}]);