"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[84622],{84622:function(e,l,n){n.d(l,{Z:function(){return O}});var d=n(52322),o=n(60218),i=n(2784),t=n(48601),r=n(82737),a=n(62202),s=n(65950),u=n(71987),c=n(26612),v=n(5088),m=n(31389),h=n(62362),p=n(80983),y=n(38449),I=n(8661),C=n(89330),f=n(39812),x=n(91406),k=n(7121),b=n(98345),w=n(19473),g=n(65215),F=n(76399),Z=n(90587),j=n(33625),N=n(21581),q=n(27423),R=n(96026),P=n(61802),V=n(9657),W=n(21326),S=n(50023);function O(e){var l,n,O,Q,A,_,D,J,U,E,L,M,T,$,z,G,K,H,X,Y,B,ee,el,en,ed,eo,ei,et;let{recordId:er,window:ea}=e,{stack:es}=(0,P.zY)(),{platformLabels:eu}=(0,i.useContext)(w.l),{getRequest:ec,postRequest:ev}=(0,i.useContext)(s.$),em=(0,i.useRef)([]),{stack:eh}=(0,R.V)(),[ep,ey]=(0,i.useState)([]),[eI,eC]=(0,i.useState)(!1),{labels:ef,access:ex}=(0,S.Z)({datasetId:c.i.WorkCenterConsumptions,editMode:!!er});(0,W.Z)({title:ef.workCenterConsumption,window:ea});let{documentType:ek,maxAccess:eb,changeDT:ew}=(0,b.H)({functionId:k.J.WorkCenterConsumption,access:ex,enabled:!er,objectName:"header"}),eg=(0,u.E)({endpointId:Z.u.WorkCenterConsumption.page});function eF(e){return("qty"===e?t.Rx().nullable().max(999999999.999," "):t.nK()).test(function(e){let{sku:l,qty:n,itemName:d}=this.parent;return!l&&!n&&!d||!!e})}let eZ=t.Ry({itemName:eF("itemName"),sku:eF("sku"),qty:eF("qty")}),{formik:ej}=(0,p.c)({documentType:{key:"header.dtId",value:null==ek?void 0:ek.dtId,reference:null==ek?void 0:ek.reference},initialValues:{recordId:er,header:{recordId:null,reference:"",dtId:null,date:new Date,plantId:null,siteId:null,workCenterId:null,WcRef:"",WcName:"",weight:0,totalQty:0,description:"",status:1,wip:1},items:[{id:1,seqNo:1,itemId:null,consumptionId:er,qty:0,unitCost:0,muId:null,msId:null,itemName:"",totalCost:0,baseQty:null}]},maxAccess:eb,validateOnChange:!0,validationSchema:t.Ry({header:t.Ry({date:t.hT().required(),workCenterId:t.Rx().required()}),items:t.IX().of(eZ)}),onSubmit:async e=>{var l;let{items:n,header:d}=e,o=null==n?void 0:null===(l=n.filter(e=>e.sku))||void 0===l?void 0:l.map((l,n)=>({...l,seqNo:n+1,consumptionId:e.recordId||0})),i=await ev({extension:Z.u.WorkCenterConsumption.set2,record:JSON.stringify({header:d,items:o})}),t=e.recordId?eu.Edited:eu.Added;a.ZP.success(t),eU(i.recordId),eg()}}),eN=!!(null===(l=ej.values)||void 0===l?void 0:l.recordId),eq=(null==ej?void 0:null===(O=ej.values)||void 0===O?void 0:null===(n=O.header)||void 0===n?void 0:n.status)===3,eR=(null==ej?void 0:null===(A=ej.values)||void 0===A?void 0:null===(Q=A.header)||void 0===Q?void 0:Q.wip)===2,eP=ej.values.items.reduce((e,l)=>e+(Number(null==l?void 0:l.totalCost)||0),0),eV=eI?ej.values.items.reduce((e,l)=>e+(Number(null==l?void 0:l.qty)||0),0):(null===(_=ej.values)||void 0===_?void 0:_.header.totalQty)||0,eW=async()=>await ec({extension:g.$.MeasurementUnit.qry,parameters:"_msId=0"});async function eS(e,l){if(!e)return;let n=(null==ep?void 0:ep.filter(e=>e.msId==l))||[];em.current=n}let eO=async e=>{if(!e)return;let l=await ec({extension:Z.u.WorkCenterConsumption.get,parameters:"_recordId=".concat(e)});return{...null==l?void 0:l.record,date:(0,f.a1)(null==l?void 0:l.record.date)}},eQ=async e=>{var l;if(!e)return;let n=await ec({extension:Z.u.ConsumptionItemView.qry,parameters:"_consumptionId=".concat(e)});return(null==n?void 0:null===(l=n.list)||void 0===l?void 0:l.length)>0?n.list.map((e,l)=>({...e,id:l+1,seqNo:l+1})):ej.values.items},eA=async()=>{await ev({extension:Z.u.WorkCenterConsumption.post,record:JSON.stringify(ej.values.header)}),a.ZP.success(eu.Posted),eg(),ea.close()},e_=async()=>{await ev({extension:Z.u.WorkCenterConsumption.unpost,record:JSON.stringify(ej.values.header)}),eU(ej.values.recordId),a.ZP.success(eu.Unposted),eg()},eD=async()=>{await ev({extension:Z.u.WorkCenterConsumption.close,record:JSON.stringify(ej.values.header)}),a.ZP.success(eu.Closed),eU(ej.values.recordId),eg()},eJ=async()=>{await ev({extension:Z.u.WorkCenterConsumption.reopen,record:JSON.stringify(ej.values.header)}),a.ZP.success(eu.Reopened),eU(ej.values.recordId),eg()};async function eU(e){let l=await eO(e),n=await eQ(e);ej.setValues({...ej.values,recordId:l.recordId,header:{...ej.values.header,...l},items:n})}let eE=async e=>{var l;let n=await ec({extension:g.$.CurrentCost.get,parameters:"_itemId=".concat(e)});return null==n?void 0:null===(l=n.record)||void 0===l?void 0:l.currentCost},eL=[{component:"resourcelookup",label:ef.sku,name:"sku",props:{endpointId:g.$.Item.snapshot,valueField:"sku",displayField:"sku",mandatory:!0,readOnly:eR,displayFieldWidth:3,mapping:[{from:"recordId",to:"itemId"},{from:"msId",to:"msId"},{from:"sku",to:"sku"},{from:"name",to:"itemName"}],columnsInDropDown:[{key:"sku",value:"SKU"},{key:"name",value:"Name"}]},async onChange(e){let{row:{update:l,newRow:n}}=e;if(!(null==n?void 0:n.itemId)){em.current=[],l({muRef:null,muId:null,baseQty:0,muQty:0,qty:0,totalCost:0});return}if(n.isInactive){l({...ej.initialValues.items[0],id:n.id}),eh({message:ef.inactiveItem});return}if(null==n?void 0:n.itemId){var d,o,i,t,r,a,s,u;eS(null==n?void 0:n.itemId,n.msId),l({unitCost:((null==n?void 0:n.itemId)?await eE(null==n?void 0:n.itemId):0)||0,muRef:(null==em?void 0:null===(o=em.current)||void 0===o?void 0:null===(d=o[0])||void 0===d?void 0:d.reference)||null,muId:(null==em?void 0:null===(t=em.current)||void 0===t?void 0:null===(i=t[0])||void 0===i?void 0:i.recordId)||null,muQty:(null==em?void 0:null===(a=em.current)||void 0===a?void 0:null===(r=a[0])||void 0===r?void 0:r.qty)||0,baseQty:(null==em?void 0:null===(u=em.current)||void 0===u?void 0:null===(s=u[0])||void 0===s?void 0:s.qty)||(null==n?void 0:n.qty),qty:(null==n?void 0:n.qty)||0})}}},{component:"textfield",label:ef.itemName,name:"itemName",flex:2,props:{readOnly:!0}},{component:"resourcecombobox",label:ef.MU,name:"muRef",props:{store:null==em?void 0:em.current,displayField:"reference",valueField:"recordId",readOnly:eR,mapping:[{from:"reference",to:"muRef"},{from:"name",to:"muName"},{from:"qty",to:"muQty"},{from:"recordId",to:"muId"}]},async onChange(e){let{row:{update:l,newRow:n}}=e;eC(!0),n&&l(n.muId?{baseQty:(null==n?void 0:n.qty)?(null==n?void 0:n.qty)*(null==n?void 0:n.muQty):null==n?void 0:n.muQty}:{baseQty:0})},propsReducer(e){let{row:l,props:n}=e;return{...n,store:null==em?void 0:em.current}}},{component:"numberfield",name:"qty",label:ef.qty,async onChange(e){let{row:{update:l,newRow:n}}=e;eC(!0),l({totalCost:parseFloat((null==n?void 0:n.unitCost)*(null==n?void 0:n.qty)).toFixed(2),baseQty:(null==n?void 0:n.muQty)?(null==n?void 0:n.muQty)*(null==n?void 0:n.qty):null==n?void 0:n.qty})},props:{decimalScale:2,readOnly:eR}},{component:"numberfield",name:"unitCost",label:ef.unitCost,props:{decimalScale:2,readOnly:!0}},{component:"numberfield",name:"totalCost",label:ef.totalCost,props:{decimalScale:2,readOnly:!0}}];async function eM(){es({Component:V.Z,props:{resourceId:c.i.WCConsumptionImport,access:eb,onSuccess:async e=>{var l;if(null==ej?void 0:null===(l=ej.values)||void 0===l?void 0:l.recordId){let e=await eO(null==ej?void 0:ej.values.recordId),l=await eQ(null==ej?void 0:ej.values.recordId);ej.setValues({...ej.values,recordId:e.recordId,header:{...ej.values.header,...e},items:l}),eg()}}}})}let eT=[{key:"Locked",condition:eq,onClick:"onUnpostConfirmation",onSuccess:e_,disabled:!eR},{key:"Unlocked",condition:!eq,onClick:eA,disabled:!eR},{key:"Close",condition:!eR,onClick:eD,disabled:eR||!eN},{key:"Reopen",condition:eR,onClick:eJ,disabled:!eR||eq},{key:"GL",condition:!0,onClick:"onClickGL",valuesPath:{...ej.values.header,notes:ej.values.header.description},datasetId:c.i.WorkCenterConsumptions,disabled:!eN},{key:"Import",condition:!0,onClick:eM,disabled:!eN||ej.values.items.some(e=>e.itemId)||eR}];return(0,i.useEffect)(()=>{ej.setFieldValue("header.totalQty",parseFloat(eV).toFixed(2)),ej.setFieldValue("header.totalCostField",parseFloat(eP).toFixed(2))},[eV,eP]),(0,i.useEffect)(()=>{!async function(){let e=await eW();ey(null==e?void 0:e.list),er&&eU(er)}()},[]),(0,d.jsx)(r.Z,{form:ej,resourceId:c.i.WorkCenterConsumptions,functionId:k.J.WorkCenterConsumption,maxAccess:eb,actions:eT,editMode:eN,previewReport:eN,disabledSubmit:eR,children:(0,d.jsxs)(m.R,{children:[(0,d.jsx)(j.g,{children:(0,d.jsxs)(o.ZP,{container:!0,spacing:2,xs:12,children:[(0,d.jsx)(o.ZP,{item:!0,xs:6,children:(0,d.jsxs)(o.ZP,{container:!0,spacing:2,children:[(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(I.Z,{endpointId:y.r.DocumentType.qry,parameters:"_startAt=0&_pageSize=1000&_dgId=".concat(k.J.WorkCenterConsumption),name:"header.dtId",label:ef.docType,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:eN,valueField:"recordId",displayField:["reference","name"],values:ej.values.header,maxAccess:eb,onChange:(e,l)=>{ej.setFieldValue("header.dtId",(null==l?void 0:l.recordId)||null),ew(l)},error:(null===(D=ej.touched.header)||void 0===D?void 0:D.dtId)&&!!(null===(J=ej.errors.header)||void 0===J?void 0:J.dtId)})}),(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(v.Z,{name:"header.reference",label:ef.reference,value:null==ej?void 0:null===(E=ej.values)||void 0===E?void 0:null===(U=E.header)||void 0===U?void 0:U.reference,maxAccess:!eN&&eb,readOnly:eN,onChange:ej.handleChange,onClear:()=>ej.setFieldValue("header.reference",""),error:(null===(L=ej.touched.header)||void 0===L?void 0:L.reference)&&!!(null===(M=ej.errors.header)||void 0===M?void 0:M.reference)})}),(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(C.Z,{name:"header.date",required:!0,readOnly:eR,label:ef.date,value:null==ej?void 0:null===($=ej.values)||void 0===$?void 0:null===(T=$.header)||void 0===T?void 0:T.date,maxAccess:eb,onChange:ej.setFieldValue,onClear:()=>ej.setFieldValue("header.date",null),error:(null===(G=ej.touched)||void 0===G?void 0:null===(z=G.header)||void 0===z?void 0:z.date)&&!!(null===(H=ej.errors)||void 0===H?void 0:null===(K=H.header)||void 0===K?void 0:K.date)})}),(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(I.Z,{endpointId:y.r.Plant.qry,name:"header.plantId",readOnly:eR,label:ef.plant,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ej.values.header,maxAccess:eb,onChange:(e,l)=>{ej.setFieldValue("header.plantId",(null==l?void 0:l.recordId)||null)},error:(null===(X=ej.touched.header)||void 0===X?void 0:X.plantId)&&!!(null===(Y=ej.errors.header)||void 0===Y?void 0:Y.plantId)})})]})}),(0,d.jsx)(o.ZP,{item:!0,xs:6,children:(0,d.jsxs)(o.ZP,{container:!0,spacing:2,children:[(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(q.U,{endpointId:Z.u.WorkCenter.snapshot,valueField:"reference",displayField:"name",name:"header.workCenterId",secondFieldLabel:ef.name,label:ef.workCenter,valueShow:"WcRef",secondValueShow:"WcName",maxAccess:eb,formObject:ej.values.header,form:ej,displayFieldWidth:2,required:!0,readOnly:eR,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"},{key:"siteName",value:"Site Name"}],onSecondValueChange:(e,l)=>{ej.setFieldValue("header.WcName",l)},onChange:(e,l)=>{ej.setFieldValue("header.WcRef",(null==l?void 0:l.isInactive)?"":null==l?void 0:l.reference),ej.setFieldValue("header.WcName",(null==l?void 0:l.isInactive)?"":null==l?void 0:l.name),ej.setFieldValue("header.siteId",(null==l?void 0:l.isInactive)?null:null==l?void 0:l.siteId),ej.setFieldValue("header.siteRef",(null==l?void 0:l.isInactive)?"":null==l?void 0:l.siteRef),ej.setFieldValue("header.siteName",(null==l?void 0:l.isInactive)?"":null==l?void 0:l.siteName),ej.setFieldValue("header.workCenterId",(null==l?void 0:l.isInactive)?null:null==l?void 0:l.recordId),(null==l?void 0:l.isInactive)&&eh({message:ef.inactiveWorkCenter})},error:(null===(B=ej.touched.header)||void 0===B?void 0:B.workCenterId)&&!!(null===(ee=ej.errors.header)||void 0===ee?void 0:ee.workCenterId)})}),(0,d.jsx)(o.ZP,{item:!0,xs:6,children:(0,d.jsx)(v.Z,{name:"header.siteRef",label:ef.siteRef,value:null===(el=ej.values.header)||void 0===el?void 0:el.siteRef,readOnly:!0})}),(0,d.jsx)(o.ZP,{item:!0,xs:6,children:(0,d.jsx)(v.Z,{name:"header.reference",label:ef.siteName,value:null===(en=ej.values.header)||void 0===en?void 0:en.siteName,readOnly:!0,maxAccess:eb,error:(null===(ed=ej.touched.header)||void 0===ed?void 0:ed.siteName)&&!!(null===(eo=ej.errors.header)||void 0===eo?void 0:eo.siteName)})}),(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(N.Z,{name:"header.description",label:ef.description,value:ej.values.header.description,rows:2.5,readOnly:eR,maxAccess:eb,onChange:e=>ej.setFieldValue("header.description",e.target.value),onClear:()=>ej.setFieldValue("header.description",""),error:(null===(ei=ej.touched.header)||void 0===ei?void 0:ei.description)&&!!(null===(et=ej.errors.header)||void 0===et?void 0:et.description)})})]})})]})}),(0,d.jsx)(h.Q,{children:(0,d.jsx)(F._,{onChange:(e,l)=>{ej.setFieldValue("items",e),"delete"===l&&eC(!0)},onSelectionChange:(e,l,n)=>{"muRef"==n&&eS(null==e?void 0:e.itemId,null==e?void 0:e.msId)},value:ej.values.items,error:ej.errors.items,allowDelete:!eR,name:"items",columns:eL,maxAccess:eb})}),(0,d.jsx)(j.g,{children:(0,d.jsx)(o.ZP,{container:!0,spacing:2,xs:12,children:(0,d.jsx)(o.ZP,{item:!0,xs:4,children:(0,d.jsxs)(o.ZP,{container:!0,spacing:2,children:[(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(x.Z,{name:"totalQty",maxAccess:eb,label:ef.totalQty,value:eV,decimalScale:2,readOnly:!0})}),(0,d.jsx)(o.ZP,{item:!0,xs:12,children:(0,d.jsx)(x.Z,{name:"totalCost",maxAccess:eb,label:ef.totalCost,value:eP,decimalScale:2,readOnly:!0})})]})})})})]})})}O.width=1200,O.height=700}}]);