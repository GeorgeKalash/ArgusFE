"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[40082],{40082:function(e,a,n){n.d(a,{Z:function(){return D}});var t=n(52322),l=n(60218),o=n(2784),r=n(48601),d=n(82737),s=n(62202),c=n(76399),i=n(65950),u=n(71987),v=n(26612),m=n(5088),p=n(80983),y=n(19473),h=n(31389),x=n(89330),I=n(8661),f=n(38449),C=n(7121),b=n(84100),k=n(25870),F=n(2119),A=n(21581),V=n(98345),g=n(39812),P=n(39704),Z=n(61802),w=n(14027),N=n(77595),j=n(1251),R=n(26553),O=n(30657),q=n(33625),M=n(91406),_=n(50023),S=n(21326),T=n(69627);function D(e){var a,D,E,H,J,L,B,G,U,z,W,Y,X,$,K,Q,ee;let{recordId:ea,plantId:en,window:et}=e,{getRequest:el,postRequest:eo}=(0,o.useContext)(i.$),{platformLabels:er,defaultsData:ed,userDefaultsData:es}=(0,o.useContext)(y.l),{stack:ec}=(0,Z.zY)(),ei=parseInt(null==ed?void 0:null===(D=ed.list)||void 0===D?void 0:null===(a=D.find(e=>"currencyId"===e.key))||void 0===a?void 0:a.value),eu=parseInt(null==es?void 0:null===(H=es.list)||void 0===H?void 0:null===(E=H.find(e=>"cashAccountId"===e.key))||void 0===E?void 0:E.value),{labels:ev,access:em}=(0,_.Z)({datasetId:v.i.PaymentVoucherExpenses,editMode:!!ea}),{documentType:ep,maxAccess:ey,changeDT:eh}=(0,V.H)({functionId:C.J.PaymentVoucher,access:em,enabled:!ea});(0,S.Z)({title:ev.paymentVoucherExpenses,window:et});let ex={recordId:null,reference:"",accountId:"",accountType:3,currencyId:parseInt(ei),currencyName:"",paymentMethod:"",date:new Date,glId:null,amount:null,checkNo:"",checkbookId:null,decimals:null,notes:"",exRate:1,rateCalcMethod:1,baseAmount:null,cashAccountId:parseInt(eu)||null,dtId:null,status:1,releaseStatus:null,plantId:parseInt(en),contactId:null,isVerified:!1,expenses:[{id:1,pvId:ea||0,seqNo:1,etId:"",subtotal:null,vatAmount:null,amount:null,supplierName:"",taxRef:"",notes:"",isVAT:!1,hasCostCenters:!1,costCenters:[]}]},eI=(0,u.E)({endpointId:k.H.PaymentVouchers.page2}),{formik:ef}=(0,p.c)({initialValues:ex,maxAccess:ey,validateOnChange:!0,documentType:{key:"dtId",value:null==ep?void 0:ep.dtId},validationSchema:r.Ry({accountType:r.Z_().required(),currencyId:r.Rx().required(),date:r.Z_().required(),paymentMethod:r.Z_().required(),cashAccountId:r.Z_().required(),expenses:r.IX().of(r.Ry().shape({etId:r.Rx().required(),amount:r.Rx().required()})).required()}),onSubmit:async e=>{let a=eC(e),n=await eo({extension:k.H.PaymentVouchers.set2,record:JSON.stringify(a)});ea?s.ZP.success(er.Edited):s.ZP.success(er.Added);let t=await eg(n.recordId);t.record.date=(0,g.a1)(t.record.date),await eS(t.record),eI()}}),eC=e=>{let a=(0,O.fB)({amount:eb,exRate:null==e?void 0:e.exRate,baseAmount:0,rateCalcMethod:null==e?void 0:e.rateCalcMethod,dirtyField:O.ss}),n={...e};delete n.expenses,n.date=(0,g.ku)(n.date),n.amount=eb,n.baseAmount=(null==a?void 0:a.baseAmount)||0;let t=[];return{header:n,items:ef.values.expenses.map((e,a)=>{let{costCenters:n,...l}=e;return n&&t.push(...n),{...l,seqNo:a+1,pvId:ef.values.recordId||0}}),costCenters:t}},eb=null===(L=ef.values)||void 0===L?void 0:null===(J=L.expenses)||void 0===J?void 0:J.reduce((e,a)=>{var n;return e+(parseFloat(null===(n=a.amount)||void 0===n?void 0:n.toString().replace(/,/g,""))||0)},0),ek=3===ef.values.status,eF=-1===ef.values.status,eA=!!ef.values.recordId,eV=ef.values.isVerified;async function eg(e){return await el({extension:k.H.PaymentVouchers.get,parameters:"_recordId=".concat(e)})}let eP=async()=>{try{let e=await eo({extension:k.H.PaymentVouchers.post,record:JSON.stringify(ef.values)});s.ZP.success(er.Posted),eI();let a=await eg(e.recordId);a.record.date=(0,g.a1)(a.record.date),await eS(a.record)}catch(e){}};async function eZ(e){if(e){var a,n,t;let l=await el({extension:k.H.FIDocTypeDefaults.get,parameters:"_dtId=".concat(e)});ef.setFieldValue("plantId",(null==l?void 0:null===(a=l.record)||void 0===a?void 0:a.plantId)||en);let o=await ew((null==l?void 0:null===(n=l.record)||void 0===n?void 0:n.cashAccountId)||eu);ef.setFieldValue("paymentMethod",(null==l?void 0:null===(t=l.record)||void 0===t?void 0:t.paymentMethod)||o)}}let ew=async e=>{if(!e)return null;{let{record:a}=await el({extension:F.G.CbBankAccounts.get,parameters:"_recordId=".concat(e)});return ef.setFieldValue("cashAccountId",(null==a?void 0:a.recordId)||null),ef.setFieldValue("cashAccountRef",(null==a?void 0:a.reference)||""),ef.setFieldValue("cashAccountName",(null==a?void 0:a.name)||""),a.paymentMethod}};async function eN(){let e=parseInt((await el({extension:f.r.Defaults.get,parameters:"_filter=&_key=vatPct"})).record.value);ef.setFieldValue("vatPct",e)}(0,o.useEffect)(()=>{var e,a;(null===(e=ef.values)||void 0===e?void 0:e.dtId)&&!ea&&eZ(null===(a=ef.values)||void 0===a?void 0:a.dtId)},[null===(B=ef.values)||void 0===B?void 0:B.dtId]),(0,o.useEffect)(()=>{!async function(){try{if(ea){let e=await eg(ea);e.record.date=(0,g.a1)(e.record.date),await eS(e.record)}else ew(eu);await eN()}catch(e){}}()},[]);let ej=async()=>{ec({Component:P.Z,props:{functionId:C.J.PaymentVoucher,recordId:ef.values.recordId}})},eR=async()=>{await eo({extension:k.H.PaymentVouchers.verify,record:JSON.stringify(ef.values)})&&(s.ZP.success(eV?er.Unverfied:er.Verified),eI(),et.close())},eO=async()=>{eN();let e=eC(ef.values);await eo({extension:k.H.ResetGL_PV.reset,record:JSON.stringify(e)})},eq=[{key:"Locked",condition:ek,onClick:"onUnpostConfirmation",onSuccess:async()=>{let e=await eo({extension:k.H.PaymentVouchers.unpost,record:JSON.stringify(ef.values)});if(null==e?void 0:e.recordId){s.ZP.success(er.Unposted),eI();let a=await eg(e.recordId);a.record.date=(0,g.a1)(a.record.date),await eS(a.record)}},disabled:!eA||eF||eV},{key:"Unlocked",condition:!ek,onClick:eP,disabled:!eA||eF},{key:"Cancel",condition:!0,onClick:async()=>{try{let e=await eo({extension:k.H.PaymentVouchers.cancel,record:JSON.stringify(ef.values)});s.ZP.success(er.Cancelled),eI();let a=await eg(e.recordId);a.record.date=(0,g.a1)(a.record.date),await eS(a.record)}catch(e){}},disabled:!eA||ek||eF},{key:"FI Trx",condition:!0,onClick:"onClickIT",disabled:!eA},{key:"GL",condition:!0,onClick:"onClickGL",datasetId:v.i.GLPaymentVoucherExpenses,onReset:eO,disabled:!eA},{key:"RecordRemarks",condition:!0,onClick:"onRecordRemarks",disabled:!eA},{key:"WorkFlow",condition:!0,onClick:ej,disabled:!eA},{key:"Verify",condition:!eV,onClick:eR,disabled:!ek},{key:"Unverify",condition:eV,onClick:eR,disabled:!ek}],eM=[{component:"resourcelookup",label:ev.expenseType,name:"reference",props:{valueField:"reference",displayField:"reference",displayFieldWidth:4,endpointId:k.H.ExpenseTypes.snapshot,mapping:[{from:"recordId",to:"etId"},{from:"name",to:"etName"},{from:"reference",to:"etRef"}],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:ek||eF}},{component:"textfield",label:ev.expenseName,name:"etName",props:{readOnly:!0}},{component:"checkbox",label:ev.isVAT,name:"isVAT",props:{disabled:ek||eF},async onChange(e){let{row:{update:a,newRow:n}}=e;if(n.isVAT&&n.amount){let e=n.amount*(100/(100+ef.values.vatPct));a({subtotal:e.toFixed(2),vatAmount:(n.amount-e).toFixed(2)})}else a({subtotal:n.amount,vatAmount:0})}},{component:"numberfield",label:ev.amount,name:"amount",props:{readOnly:ek||eF},async onChange(e){let{row:{update:a,newRow:n}}=e;if(n.isVAT){let e=n.amount*(100/(100+ef.values.vatPct));a({subtotal:e.toFixed(2),vatAmount:(n.amount-e).toFixed(2)})}else a({subtotal:n.amount,vatAmount:0})}},{component:"numberfield",label:ev.vat,name:"vatAmount",props:{readOnly:!0}},{component:"numberfield",label:ev.subtotal,name:"subtotal",props:{readOnly:!0}},{component:"textfield",label:ev.vendorName,name:"supplierName",props:{readOnly:ek||eF}},{component:"numberfield",label:ev.vatNo,name:"taxRef",props:{readOnly:ek||eF}},{component:"textfield",label:ev.notes,name:"notes",props:{readOnly:ek||eF}},{component:"button",name:"hasCostCenters",props:{imgSrc:n(9130).default.src},label:ev.costCenter,onClick:(e,a,n,t)=>{ec({Component:w.Z,props:{maxAccess:ey,labels:ev,recordId:ea,row:a,updateRow:t,readOnly:ek||eF}})}}],e_=async(e,a)=>(await el({extension:k.H.PaymentVoucherCostCenters.qry,parameters:"_pvId=".concat(e,"&_seqNo=").concat(a)})).list.map(e=>({...e,id:e.ccSeqNo})),eS=async e=>{let a=await el({extension:k.H.PaymentVoucherExpenses.qry,parameters:"_pvId=".concat(e.recordId)}),n=await Promise.all(a.list.map(async a=>{let n=await e_(e.recordId,a.seqNo);return{...a,id:a.seqNo,isVAT:0!=a.vatAmount,hasCostCenters:!1,costCenters:n}}));ef.setValues({...e,expenses:n})},eT=null===(U=ef.values)||void 0===U?void 0:null===(G=U.expenses)||void 0===G?void 0:G.reduce((e,a)=>{var n;return e+(parseFloat(null===(n=a.subtotal)||void 0===n?void 0:n.toString().replace(/,/g,""))||0)},0),eD=null===(W=ef.values)||void 0===W?void 0:null===(z=W.expenses)||void 0===z?void 0:z.reduce((e,a)=>{var n;return e+(parseFloat(null===(n=a.vatAmount)||void 0===n?void 0:n.toString().replace(/,/g,""))||0)},0),eE=null===(X=ef.values)||void 0===X?void 0:null===(Y=X.expenses)||void 0===Y?void 0:Y.reduce((e,a)=>{var n;return e+(parseFloat(null===(n=a.amount)||void 0===n?void 0:n.toString().replace(/,/g,""))||0)},0);async function eH(e,a,n,t){if(e&&a&&n){var l,o,r,d,s,c;let i=await el({extension:j.q.Currency.get,parameters:"_currencyId=".concat(e,"&_date=").concat((0,g.Uf)(a),"&_rateDivision=").concat(n)}),u=(0,O.fB)({amount:0===t?0:null!=t?t:ef.values.amount,exRate:null===(l=i.record)||void 0===l?void 0:l.exRate,baseAmount:0,rateCalcMethod:null===(o=i.record)||void 0===o?void 0:o.rateCalcMethod,dirtyField:O.ss});ef.setFieldValue("baseAmount",parseFloat(null==u?void 0:u.baseAmount).toFixed(2)||0),(null===(r=i.record)||void 0===r?void 0:r.exRate)&&ef.setFieldValue("exRate",null===(d=i.record)||void 0===d?void 0:d.exRate),(null===(s=i.record)||void 0===s?void 0:s.rateCalcMethod)&&ef.setFieldValue("rateCalcMethod",null===(c=i.record)||void 0===c?void 0:c.rateCalcMethod)}}return(0,o.useEffect)(()=>{!async function(){await eH(ef.values.currencyId,ef.values.date,R.B.FINANCIALS)}()},[]),(0,t.jsx)(d.Z,{resourceId:v.i.PaymentVoucherExpenses,form:ef,maxAccess:ey,editMode:eA,previewReport:eA,actions:eq,functionId:C.J.PaymentVoucher,disabledSubmit:ek||eF,children:(0,t.jsxs)(h.R,{children:[(0,t.jsx)(q.g,{children:(0,t.jsxs)(l.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsxs)(l.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(l.ZP,{item:!0,xs:12,children:(0,t.jsx)(I.Z,{endpointId:f.r.DocumentType.qry,parameters:"_dgId=".concat(C.J.PaymentVoucher,"&_startAt=",0,"&_pageSize=",50),filter:eA?void 0:e=>1===e.activeStatus,name:"dtId",label:ev.documentType,readOnly:eA,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ef.values,onChange:async(e,a)=>{ef.setFieldValue("dtId",(null==a?void 0:a.recordId)||null),eh(a)},error:ef.touched.dtId&&!!ef.errors.dtId,maxAccess:ey})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(m.Z,{name:"reference",label:ev.reference,value:ef.values.reference,readOnly:eA,maxAccess:!eA&&ey,maxLength:"15",onChange:ef.handleChange,onClear:()=>ef.setFieldValue("reference",""),error:ef.touched.reference&&!!ef.errors.reference})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(x.Z,{name:"date",label:ev.date,value:null===($=ef.values)||void 0===$?void 0:$.date,required:!0,onChange:async(e,a)=>{ef.setFieldValue("date",a),await eH(ef.values.currencyId,a,R.B.FINANCIALS)},onClear:()=>ef.setFieldValue("date",null),readOnly:ek||eF,error:ef.touched.date&&!!ef.errors.date,maxAccess:ey})}),(0,t.jsx)(l.ZP,{item:!0,xs:12,children:(0,t.jsx)(I.Z,{endpointId:f.r.Plant.qry,name:"plantId",label:ev.plant,valueField:"recordId",readOnly:ek||eF,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ef.values,onChange:(e,a)=>{ef.setFieldValue("plantId",a?null==a?void 0:a.recordId:"")},error:ef.touched.plantId&&!!ef.errors.plantId})}),(0,t.jsx)(l.ZP,{item:!0,xs:12,children:(0,t.jsx)(I.Z,{endpointId:F.G.CashAccount.qry,parameters:"_type=0",name:"cashAccountId",readOnly:eF||ek,required:!0,label:ev.cashAccount,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:ef.values,maxAccess:ey,onChange:async(e,a)=>{ef.setFieldValue("cashAccountId",(null==a?void 0:a.recordId)||null)},error:ef.touched.cashAccountId&&!!ef.errors.cashAccountId})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsxs)(l.ZP,{container:!0,spacing:1,alignItems:"center",children:[(0,t.jsx)(l.ZP,{item:!0,xs:8,children:(0,t.jsx)(I.Z,{endpointId:f.r.Currency.qry,name:"currencyId",label:ev.currency,valueField:"recordId",required:!0,filter:e=>1===e.currencyType,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:ek||eF,values:ef.values,onChange:async(e,a)=>{await eH(null==a?void 0:a.recordId,ef.values.date,R.B.FINANCIALS),ef.setFieldValue("currencyId",a?null==a?void 0:a.recordId:null),ef.setFieldValue("currencyName",null==a?void 0:a.name)},error:ef.touched.currencyId&&!!ef.errors.currencyId})}),(0,t.jsx)(l.ZP,{item:!0,xs:4,children:(0,t.jsx)(T.Z,{onClick:()=>{var e;return e=ef.values,void ec({Component:N.Z,props:{DatasetIdAccess:v.i.MCRPaymentVoucherExpenses,data:{...e,amount:eE},onOk:e=>{ef.setValues(a=>({...a,...e}))}}})},image:"popup.png",tooltipText:er.add,disabled:!ef.values.currencyId||ef.values.currencyId===ei})})]})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(I.Z,{neverPopulate:!0,endpointId:k.H.DescriptionTemplate.qry,name:"templateId",label:ev.descriptionTemplate,readOnly:ek||eF,valueField:"recordId",displayField:"name",values:ef.values,onChange:(e,a)=>{let n=ef.values.notes||"";(null==a?void 0:a.name)&&ef.setFieldValue("notes",""===n?a.name:"".concat(n,"\n").concat(a.name)),ef.setFieldValue("templateId",(null==a?void 0:a.recordId)||null)},error:ef.touched.templateId&&!!ef.errors.templateId,maxAccess:ey})})]})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsxs)(l.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(I.Z,{datasetId:b.v.PAYMENT_METHOD,name:"paymentMethod",label:ev.paymentMethod,valueField:"key",displayField:"value",values:ef.values,required:!0,readOnly:ek||eF,maxAccess:ey,onChange:(e,a)=>{ef.setFieldValue("paymentMethod",a?a.key:null)},error:ef.touched.paymentMethod&&!!ef.errors.paymentMethod})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(M.Z,{name:"subtotal",label:ev.subtotal,value:eT,readOnly:!0,maxAccess:ey,onChange:ef.handleChange,onClear:()=>ef.setFieldValue("subtotal",""),error:ef.touched.subtotal&&!!ef.errors.subtotal})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(m.Z,{name:"checkNo",label:ev.checkNo,value:ef.values.checkNo,maxAccess:ey,onChange:ef.handleChange,onClear:()=>ef.setFieldValue("checkNo",""),error:ef.touched.checkNo&&!!ef.errors.checkNo,disabled:3!=ef.values.paymentMethod,required:3==ef.values.paymentMethod})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(M.Z,{name:"vatAmount",label:ev.vat,value:eD,readOnly:!0,maxAccess:ey,onChange:ef.handleChange,onClear:()=>ef.setFieldValue("vatAmount",""),error:ef.touched.vatAmount&&!!ef.errors.vatAmount})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(I.Z,{endpointId:F.G.CACheckbook.qry,name:"checkbookId",label:ev.checkbook,valueField:"recordId",displayField:"firstCheckNo",values:ef.values,onChange:(e,a)=>{ef.setFieldValue("checkbookId",a?null==a?void 0:a.recordId:"")},error:ef.touched.checkbookId&&!!ef.errors.checkbookId,disabled:3!=ef.values.paymentMethod})}),(0,t.jsx)(l.ZP,{item:!0,xs:6,children:(0,t.jsx)(M.Z,{name:"amount",label:ev.amount,value:eE,readOnly:!0,maxAccess:ey,thousandSeparator:!1,onChange:async e=>{var a,n,t;let l=(0,O.fB)({amount:null!==(t=e.target.value)&&void 0!==t?t:0,exRate:null===(a=ef.values)||void 0===a?void 0:a.exRate,baseAmount:0,rateCalcMethod:null===(n=ef.values)||void 0===n?void 0:n.rateCalcMethod,dirtyField:O.ss});ef.setFieldValue("baseAmount",parseFloat(null==l?void 0:l.baseAmount).toFixed(2)||0),ef.setFieldValue("amount",e.target.value)},onClear:async()=>{ef.setFieldValue("amount",0)},error:ef.touched.amount&&!!ef.errors.amount})}),(0,t.jsx)(l.ZP,{item:!0,xs:12,children:(0,t.jsx)(A.Z,{name:"notes",type:"text",label:ev.notes,value:ef.values.notes,readOnly:ek||eF,rows:3,maxAccess:ey,onChange:e=>ef.setFieldValue("notes",e.target.value),onClear:()=>ef.setFieldValue("notes",""),error:ef.touched.notes&&!!ef.errors.notes})})]})})]})}),(0,t.jsx)(c._,{onChange:e=>{ef.setFieldValue("expenses",e)},value:null==ef?void 0:null===(K=ef.values)||void 0===K?void 0:K.expenses,error:null==ef?void 0:null===(Q=ef.errors)||void 0===Q?void 0:Q.expenses,initialValues:null==ef?void 0:null===(ee=ef.initialValues)||void 0===ee?void 0:ee.expenses[0],columns:eM,allowDelete:!ek&&!eF,allowAddNewLine:!ek&&!eF})]})})}D.width=1300,D.height=700}}]);