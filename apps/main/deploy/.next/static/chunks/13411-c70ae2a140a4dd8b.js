"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[13411],{13411:function(e,r,a){a.d(r,{Z:function(){return V}});var l=a(52322),t=a(60218),n=a(2784),i=a(48601),d=a(82737),o=a(62202),s=a(76399),c=a(65950),u=a(71987),m=a(26612),v=a(5088),p=a(80983),x=a(19473),h=a(31389),I=a(62362),y=a(89330),f=a(8661),g=a(38449),T=a(7121),F=a(21581),j=a(98345),Z=a(39812),b=a(30043),w=a(22341),N=a(33625),O=a(28298),C=a(28879),P=a.n(C);function V(e){var r,a,C,V,k,S,D,A;let{labels:R,maxAccess:_,recordId:U}=e,{getRequest:q,postRequest:W}=(0,n.useContext)(c.$),{platformLabels:J,userDefaultsData:L}=(0,n.useContext)(x.l),{documentType:B,maxAccess:E,changeDT:z}=(0,j.H)({functionId:T.J.DeliveryTrip,access:_,enabled:!U});async function $(){let e=["plantId"],r=((null==L?void 0:L.list)||[]).reduce((r,a)=>{let{key:l,value:t}=a;return e.includes(l)&&(r[l]=t?parseInt(t):null),r},{});G.setFieldValue("plantId",parseInt(null==r?void 0:r.plantId))}let M=(0,u.E)({endpointId:b.U.Trip.page}),{formik:G}=(0,p.c)({initialValues:{recordId:null,reference:"",plantId:null,vehicleId:null,driverId:null,date:new Date,departureTime:new Date,departureTimeField:null,arrivalTime:null,arrivalTimeField:null,notes:"",dtId:null,status:1,statusName:"",printStatusName:"",dtName:"",plantName:"",vehName:"",driverName:"",capacityVolume:null,wip:1,wipName:"",orders:[{id:1,soRef:null,soId:null,soDate:null,clientName:null,soVolume:null,soWipStatusName:null}]},maxAccess:E,documentType:{key:"dtId",value:null==B?void 0:B.dtId},validateOnChange:!0,validationSchema:i.Ry({departureTime:i.Z_().required(),plantId:i.Rx().required()}),onSubmit:async e=>{let r={...e};delete r.orders,r.date=(0,Z.ku)(r.date);let a=H(r.departureTime,r.departureTimeField);if(r.departureTime=(0,Z.ku)(a),r.arrivalTime){let e=H(r.arrivalTime,r.arrivalTimeField);r.arrivalTime=(0,Z.ku)(e)}let l=await W({extension:b.U.Trip.set,record:JSON.stringify(r)});G.setFieldValue("recordId",l.recordId);let t=G.values.orders.filter(e=>""!==e.soId&&void 0!==e.soId),n=new Set,i=!1;for(let e of t){if(n.has(e.soId)){i=!0;break}n.add(e.soId)}if(i)return;t=(null==t?void 0:t.some(e=>e.soId))?t.map((e,r)=>({...e,tripId:l.recordId||0,id:r+1})):[];let d={tripId:l.recordId||0,tripOrders:t};await W({extension:b.U.TripOrderPack2.set2,record:JSON.stringify(d)}),await er(l.recordId),G.values.recordId?o.ZP.success(J.Edited):o.ZP.success(J.Added),M()}});function H(e,r){let a=P()(e).startOf("day"),l=a;if(null!=r){let e=P()(r,"hh:mm A");l=a.set("hour",e.hour()).set("minute",e.minute())}return l}let K=G.values.orders.reduce((e,r)=>e+(parseFloat(r.soVolume)||0),0),Q=G.values.orders.reduce((e,r)=>e+(parseFloat(r.soWeight)||0),0),X=3===G.values.status,Y=2===G.values.wip,ee=!!G.values.recordId;async function er(e){let r=await ea(e),a=(0,Z.a1)(r.record.departureTime),l=(0,Z.a1)(r.record.arrivalTime);r.record.date=(0,Z.a1)(r.record.date),r.record.departureTime=a,a&&(r.record.departureTimeField=P()(P()(a),"hh:mm A")),r.record.arrivalTime=l,l&&(r.record.arrivalTimeField=P()(P()(l),"hh:mm A")),await el(r.record)}async function ea(e){return await q({extension:b.U.Trip.get,parameters:"_recordId=".concat(e)})}let el=async e=>{let r=await q({extension:b.U.TripOrder.qry,parameters:"_tripId=".concat(e.recordId)}),a=[];r.list!=[]&&(a=await Promise.all(r.list.map((e,r)=>({...e,id:r+1,soDate:(0,Z.a1)(e.soDate)})))),G.setValues({...e,orders:a})},et=async()=>{await W({extension:b.U.Trip.post,record:JSON.stringify(G.values)}),o.ZP.success(J.Posted),M(),await er(G.values.recordId)},en=async()=>{await W({extension:b.U.Trip.unpost,record:JSON.stringify(G.values)}),o.ZP.success(J.Unposted),M(),await er(G.values.recordId)},ei=async()=>{await W({extension:b.U.Trip.close,record:JSON.stringify(G.values)}),U&&o.ZP.success(J.Closed),M(),await er(G.values.recordId)},ed=async()=>{await W({extension:b.U.Trip.reopen,record:JSON.stringify(G.values)}),U&&o.ZP.success(J.Reopened),M(),await er(G.values.recordId)};(0,n.useEffect)(()=>{!async function(){$(),U&&await er(U)}()},[]);let eo=[{key:"Locked",condition:X,onClick:"onUnpostConfirmation",onSuccess:en,disabled:!ee||!Y},{key:"Unlocked",condition:!X,onClick:et,disabled:!ee||!Y},{key:"Close",condition:!Y,onClick:()=>ei(G.values.recordId),disabled:X||Y||!ee},{key:"Reopen",condition:Y,onClick:ed,disabled:!Y||X}],es=[{component:"resourcelookup",label:R.reference,name:"soRef",props:{valueField:"reference",displayField:"reference",displayFieldWidth:1,endpointId:w.P.SalesOrder.snapshot,mapping:[{from:"recordId",to:"soId"},{from:"reference",to:"soRef"},{from:"date",to:"soDate"},{from:"clientId",to:"clientId"},{from:"clientRef",to:"clientRef"},{from:"clientName",to:"clientName"},{from:"volume",to:"soVolume"},{from:"szName",to:"szName"},{from:"wipName",to:"soWipStatusName"}],columnsInDropDown:[{key:"reference",value:"Reference"}],readOnly:X||Y},onChange(e){let{row:{update:r,newRow:a}}=e;r({soDate:(null==a?void 0:a.soDate)?(0,Z.a1)(null==a?void 0:a.soDate):""})}},{component:"date",name:"soDate",label:R.date,props:{readOnly:!0}},{component:"textfield",label:R.client,name:"clientName",props:{readOnly:!0}},{component:"textfield",label:R.szName,name:"szName",props:{readOnly:!0}},{component:"textfield",label:R.volume,name:"soVolume",props:{readOnly:!0}},{component:"textfield",label:R.wip,name:"soWipStatusName",props:{readOnly:!0}}];async function ec(){let e={printStatus:2,recordId:G.values.recordId};await W({extension:b.U.TRP.flag,record:JSON.stringify(e)}),M()}return(0,l.jsx)(d.Z,{resourceId:m.i.Trip,form:G,maxAccess:E,editMode:ee,actions:eo,previewBtnClicked:ec,functionId:T.J.DeliveryTrip,disabledSubmit:X||Y,previewReport:ee,children:(0,l.jsxs)(h.R,{children:[(0,l.jsx)(N.g,{children:(0,l.jsxs)(t.ZP,{container:!0,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsxs)(t.ZP,{container:!0,xs:12,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(f.Z,{endpointId:g.r.DocumentType.qry,parameters:"_dgId=".concat(T.J.DeliveryTrip,"&_startAt=",0,"&_pageSize=",1e3),filter:ee?void 0:e=>1===e.activeStatus,name:"dtId",label:R.docType,readOnly:ee,valueField:"recordId",displayField:"name",values:G.values,onChange:async(e,r)=>{G.setFieldValue("dtId",(null==r?void 0:r.recordId)||""),z(r)},error:G.touched.dtId&&!!G.errors.dtId,maxAccess:E})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(y.Z,{name:"departureTime",label:R.departureDate,value:null===(r=G.values)||void 0===r?void 0:r.departureTime,onChange:G.setFieldValue,onClear:()=>G.setFieldValue("departureTime",""),readOnly:X||Y,error:G.touched.departureTime&&!!G.errors.departureTime,maxAccess:E,required:!0})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(f.Z,{endpointId:g.r.Plant.qry,name:"plantId",label:R.plant,valueField:"recordId",readOnly:X||Y,displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:G.values,onChange:(e,r)=>{G.setFieldValue("plantId",r?null==r?void 0:r.recordId:"")},error:G.touched.plantId&&!!G.errors.plantId,required:!0})})]})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsxs)(t.ZP,{container:!0,xs:12,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(v.Z,{name:"reference",label:R.reference,value:G.values.reference,readOnly:ee,maxAccess:E,onChange:G.handleChange,onClear:()=>G.setFieldValue("reference",""),error:G.touched.reference&&!!G.errors.reference})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(O.Z,{label:R.departureTime,name:"departureTimeField",value:null===(a=G.values)||void 0===a?void 0:a.departureTimeField,onChange:G.setFieldValue,onClear:()=>G.setFieldValue("departureTimeField",""),readOnly:X||Y,error:G.touched.departureTimeField&&!!G.errors.departureTimeField,maxAccess:E})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(f.Z,{endpointId:b.U.Driver.qry,name:"driverId",label:R.driver,valueField:"recordId",readOnly:X||Y,displayField:"name",values:G.values,onChange:(e,r)=>{G.setFieldValue("driverId",r?null==r?void 0:r.recordId:"")},error:G.touched.driverId&&!!G.errors.driverId})})]})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsxs)(t.ZP,{container:!0,xs:12,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(y.Z,{name:"date",label:R.date,value:null===(C=G.values)||void 0===C?void 0:C.date,onChange:G.setFieldValue,onClear:()=>G.setFieldValue("date",""),readOnly:X||Y,error:G.touched.date&&!!G.errors.date,maxAccess:E})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(y.Z,{name:"arrivalTime",label:R.arrivalDate,value:null===(V=G.values)||void 0===V?void 0:V.arrivalTime,onChange:(e,r)=>{G.setFieldValue("arrivalTime",r),r||G.setFieldValue("arrivalTimeField","")},onClear:()=>G.setFieldValue("arrivalTime",""),readOnly:X||Y,error:G.touched.arrivalTime&&!!G.errors.arrivalTime,maxAccess:E})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(f.Z,{endpointId:b.U.Vehicle.qry,name:"vehicleId",label:R.vehicle,valueField:"recordId",readOnly:X||Y,displayField:"name",values:G.values,onChange:(e,r)=>{G.setFieldValue("vehicleId",r?null==r?void 0:r.recordId:"")},error:G.touched.vehicleId&&!!G.errors.vehicleId})})]})}),(0,l.jsx)(t.ZP,{item:!0,xs:12,children:(0,l.jsxs)(t.ZP,{container:!0,xs:12,spacing:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:4}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(O.Z,{label:R.arrivalTime,name:"arrivalTimeField",value:null===(k=G.values)||void 0===k?void 0:k.arrivalTimeField,onChange:G.setFieldValue,onClear:()=>G.setFieldValue("arrivalTimeField",""),readOnly:X||Y||!(null===(S=G.values)||void 0===S?void 0:S.arrivalTime),error:G.touched.arrivalTimeField&&!!G.errors.arrivalTimeField,maxAccess:E})}),(0,l.jsx)(t.ZP,{item:!0,xs:4,children:(0,l.jsx)(F.Z,{name:"notes",type:"text",label:R.notes,value:G.values.notes,readOnly:X||Y,rows:3,maxAccess:E,onChange:e=>G.setFieldValue("notes",e.target.value),onClear:()=>G.setFieldValue("notes",""),error:G.touched.notes&&!!G.errors.notes})})]})})]})}),(0,l.jsx)(I.Q,{children:(0,l.jsx)(s._,{onChange:e=>{G.setFieldValue("orders",e)},value:null==G?void 0:null===(D=G.values)||void 0===D?void 0:D.orders,error:null==G?void 0:null===(A=G.errors)||void 0===A?void 0:A.orders,columns:es,allowDelete:!X&&!Y,allowAddNewLine:!X&&!Y})}),(0,l.jsx)(N.g,{children:(0,l.jsxs)(t.ZP,{container:!0,rowGap:1,xs:10,spacing:2,pt:2,children:[(0,l.jsx)(t.ZP,{item:!0,xs:5,children:(0,l.jsx)(v.Z,{name:"totalVolume",label:R.totVol,maxAccess:E,value:K,maxLength:"30",readOnly:!0,error:G.touched.totalVolume&&!!G.errors.totalVolume,helperText:G.touched.totalVolume&&G.errors.totalVolume})}),(0,l.jsx)(t.ZP,{item:!0,xs:5,children:(0,l.jsx)(v.Z,{name:"totalWeight",label:R.totalWeight,maxAccess:E,value:Q,maxLength:"30",readOnly:!0,error:G.touched.totalWeight&&!!G.errors.totalWeight,helperText:G.touched.totalWeight&&G.errors.totalWeight})})]})})]})})}},1685:function(e,r,a){a.d(r,{m:function(){return l}});let l=e=>{let r=window.sessionStorage.getItem(e);return r?JSON.parse(r):null}},98345:function(e,r,a){a.d(r,{H:function(){return x},G:function(){return p}});var l=a(45300),t=a(2784),n=a(96026),i=a(38449);a(26612);var d=a(65947),o=a(1685);let s=async(e,r,a)=>{try{let l=await e({extension:r,parameters:a});return r.includes("qry")?l:l.record}catch(e){return null}},c=(e,r,a,l)=>{let t=(e=JSON.parse(JSON.stringify(e))).record.controls,n=t.find(e=>"reference"===e.controlId);return n?n.accessLevel=(null==r?void 0:r.mandatory)?d.$7:d.rr:(null==r?void 0:r.mandatory)?t.push({sgId:0,resourceId:"",controlId:"".concat(l?l+".":"","reference"),accessLevel:(null==r?void 0:r.mandatory)?d.$7:d.rr}):(null==r?void 0:r.readOnly)?t.push({sgId:0,resourceId:"",controlId:"".concat(l?l+".":"","reference"),accessLevel:(null==r?void 0:r.readOnly)?d.rr:d.$7}):t=e.record.controls.filter(e=>"reference"!=e.controlId),a&&t.push({sgId:0,resourceId:"",controlId:"".concat(l?l+".":"","dtId"),accessLevel:d.$7}),{...e,record:{...e.record,controls:t}}},u=async(e,r,a)=>{let l,t;switch(a){case"dtId":let n=(0,o.m)("userData"),d=null==n?void 0:n.userId;t="_userId=".concat(d,"&_functionId=").concat(r),l=i.r.UserFunction.get;break;case"glbSysNumberRange":t="_recordId=".concat(r),l=i.r.SystemFunction.get;break;case"DocumentType":t="_dgId=".concat(r,"&_startAt=",0,"&_pageSize=",50),l=i.r.DocumentType.qry;break;case"DcTypNumberRange":t="_recordId=".concat(r),l=i.r.DocumentType.get;break;case"isExternal":t="_recordId=".concat(r),l=i.r.NumberRange.get;break;default:return null}return await s(e,l,t)},m=async function(e){let r,a,l,t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,o=!(arguments.length>4)||void 0===arguments[4]||arguments[4],s=arguments.length>5?arguments[5]:void 0,m=void 0===d&&n&&await u(e,n,"dtId"),v=null==m?void 0:m.dtId,p="",x=!0;if(m&&void 0===d||"nraId"===d){if(v){let a=await u(e,v,"DcTypNumberRange");r=null==a?void 0:a.nraId,x=!((null==a?void 0:a.activeStatus)<0),r||(p="Assign the document type to a number range")}if((!v||!x)&&o&&n){var h;let r=await u(e,n,"DocumentType");t=(null==r?void 0:null===(h=r.list)||void 0===h?void 0:h.filter(e=>(null==e?void 0:e.activeStatus)===1).length)>0}}if(("nraId"===d||void 0===d)&&n){if((!v||v)&&!r||r&&!x){let a=await u(e,n,"glbSysNumberRange");(r=null==a?void 0:a.nraId)&&t&&(t=!1),x=!0}p=r||t?"":"Assign the system Function to a number range"}d>0&&!r&&(r=d),r&&x?(a={readOnly:null==(l=await u(e,r,"isExternal"))||!l.external,mandatory:null!=l&&!!l.external},i&&(i=await c(i,a,t,s))):!r&&i&&(i=await c(i,a,t,s));let I=s?"".concat(s,".reference"):"reference";return{dtId:v,resetReference:null==a?void 0:a.readOnly,dcTypeRequired:t,reference:{fieldName:I,isEmpty:(null==l?void 0:l.external)!==void 0&&(null==l||!l.external)},errorMessage:p,maxAccess:i,selectNraId:d}};var v=a(65950);function p(e){let{functionId:r,action:a,hasDT:l}=e,{getRequest:i}=(0,t.useContext)(v.$),{stack:d}=(0,n.V)();return{proxyAction:async()=>{let e=await m(i,r,"",void 0,l);(null==e?void 0:e.errorMessage)?d({message:null==e?void 0:e.errorMessage}):await a()}}}function x(e){var r;let{functionId:a,access:i,hasDT:d,enabled:o=!0,objectName:s=""}=e,{getRequest:c}=(0,t.useContext)(v.$),{stack:u}=(0,n.V)(),[p,x]=(0,t.useState)(),h=async e=>{let r=await m(c,a,i,e,d,s);if(!r.errorMessage)return r;u({message:null==r?void 0:r.errorMessage})},I=(0,l.a)({retry:!1,staleTime:0,enabled:o,queryKey:[a,p,!!i,o],queryFn:p||"nraId"===p?()=>h(p):()=>h()});return{documentType:I.data,maxAccess:(null==I?void 0:null===(r=I.data)||void 0===r?void 0:r.maxAccess)||i,changeDT(e){x((null==e?void 0:e.nraId)||"nraId")}}}},28298:function(e,r,a){var l=a(52322),t=a(2784),n=a(74143),i=a(44258),d=a(41633),o=a(45297),s=a(94918),c=a(26698),u=a(51909),m=a(90740),v=a(32827),p=a(81576),x=a(7087),h=a.n(x);r.Z=e=>{let{name:r,label:a,value:x,onChange:I,error:y=!1,helperText:f="",disabledRangeTime:g={},variant:T="outlined",size:F="small",fullWidth:j=!0,required:Z=!1,autoFocus:b=!1,disabled:w=!1,disabledTime:N=null,readOnly:O=!1,editMode:C=!1,hasBorder:P=!0,hidden:V=!1,use24Hour:k=!1,min:S=null,max:D=null,...A}=e,[R,_]=(0,t.useState)(!1),[U,q]=(0,t.useState)(!1),{_readOnly:W,_required:J,_hidden:L}=(0,p.W)(r,A.maxAccess,Z,O,V);return L?(0,l.jsx)(l.Fragment,{}):(0,l.jsx)(d._,{dateAdapter:m.y,children:(0,l.jsx)(u.j,{variant:T,size:F,value:x,label:a,fullWidth:j,ampm:!k,minTime:S,maxTime:D,onFocus:()=>q(!0),onBlur:()=>q(!1),autoFocus:b,onChange:e=>I(r,e),onClose:()=>_(!1),open:R,disabled:w,readOnly:W,clearable:!0,slotProps:{textField:{required:J,size:F,fullWidth:j,error:!!y,helperText:"string"==typeof y?y:f,InputProps:{classes:{root:h().outlinedRoot,notchedOutline:P?h().outlinedFieldset:h().outlinedNoBorder,input:h().inputBase},endAdornment:!(W||w)&&(0,l.jsxs)(n.Z,{position:"end",className:h().inputAdornment,children:[x&&(0,l.jsx)(i.Z,{tabIndex:-1,className:h().iconButton,onClick:()=>I(r,null),children:(0,l.jsx)(o.Z,{className:h().icon})}),(0,l.jsx)(i.Z,{tabIndex:-1,className:h().iconButton,onClick:()=>_(!0),children:(0,l.jsx)(s.Z,{className:h().icon})})]})},InputLabelProps:{className:U||x?h().inputLabelShrink:h().inputLabel}},actionBar:{actions:["accept"]}},slots:{actionBar:e=>(0,l.jsx)(c.Z,{...e,actions:["accept"]}),popper:e=>(0,l.jsx)(v.Z,{...e,matchAnchorWidth:!1,isDateTimePicker:!0})},...A})})}}}]);