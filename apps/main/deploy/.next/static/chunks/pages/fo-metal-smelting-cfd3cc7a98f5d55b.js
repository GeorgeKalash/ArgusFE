(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[27733],{45686:function(e,l,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/fo-metal-smelting",function(){return a(89132)}])},89132:function(e,l,a){"use strict";a.r(l),a.d(l,{default:function(){return T}});var t=a(52322),n=a(2784),r=a(62202),d=a(69387),i=a(65950),o=a(71987),u=a(26612),s=a(31389),c=a(33625),v=a(62362),m=a(61802),y=a(98345),p=a(7121),h=a(19473),f=a(36908),x=a(36773),I=a(60218),g=a(48601),b=a(82737),F=a(5088),w=a(80983),k=a(38449),q=a(8661),S=a(89330),N=a(39812),j=a(91406),C=a(65215),P=a(76399),Z=a(90587),V=a(27423),A=a(84100),O=a(96026),_=a(67920),M=a(21581);function R(e){var l,a,d,m,f,R,T,D,E,L,Q,$,B,J,U,G,W,z,K,X,H,Y,ee,el,ea,et,en,er,ed,ei,eo,eu,es,ec,ev,em,ey,ep,eh,ef,ex,eI,eg,eb,eF,ew,ek,eq,eS,eN,ej,eC,eP,eZ,eV,eA;let{labels:eO,access:e_,recordId:eM,window:eR}=e,{getRequest:eT,postRequest:eD}=(0,n.useContext)(i.$),{platformLabels:eE,userDefaultsData:eL,defaultsData:eQ}=(0,n.useContext)(h.l),{stack:e$}=(0,O.V)(),[eB,eJ]=(0,n.useState)([]),[eU,eG]=(0,n.useState)(!1),eW=(0,n.useRef)(),ez=(0,n.useRef)({}),eK=p.J.MetalSmelting,{documentType:eX,maxAccess:eH,changeDT:eY}=(0,y.H)({functionId:eK,access:e_,enabled:!eM,objectName:"header"}),e0=(0,o.E)({endpointId:x.B.FoundaryTransaction.page}),e1=parseInt(null==eL?void 0:null===(a=eL.list)||void 0===a?void 0:null===(l=a.find(e=>"plantId"===e.key))||void 0===l?void 0:l.value),e2=parseInt(null==eL?void 0:null===(m=eL.list)||void 0===m?void 0:null===(d=m.find(e=>"siteId"===e.key))||void 0===d?void 0:d.value),e3=parseInt(null==eQ?void 0:null===(R=eQ.list)||void 0===R?void 0:null===(f=R.find(e=>"baseSalesMetalId"===e.key))||void 0===f?void 0:f.value)||null,{schema:e6,requiredFields:e8}=(0,_.m)({sku:e=>null==e?void 0:e.sku,itemName:e=>null==e?void 0:e.itemName,qty:e=>null==e?void 0:e.qty},!0,eH,"scraps"),{formik:e4}=(0,w.c)({documentType:{key:"header.dtId",value:null==eX?void 0:eX.dtId,reference:null==eX?void 0:eX.reference},initialValues:{recordId:eM||null,header:{recordId:eM,functionId:p.J.MetalSmelting,date:new Date,dtId:null,plantId:e1,reference:"",siteId:e2,status:1,workCenterId:null,itemId:null,qty:null,extendedAlloy:0,totalAlloy:0,purity:null,metalId:null,smeltingMaxAllowedVariation:null,notes:"",baseSalesMetalPurity:0,baseSalesMetalRef:"",avgPurity:0},items:[{id:1,itemId:null,sku:"",itemName:"",metalId:null,purity:null,qty:0,seqNo:1,trxId:eM||0,type:null,currentCost:0,qtyAtPurity:0,expectedAlloyQty:0}],scraps:[{id:1,itemId:null,sku:"",itemName:"",qty:null}]},maxAccess:eH,conditionSchema:["scraps"],validationSchema:g.Ry({header:g.Ry({date:g.hT().required(),siteId:g.Rx().required(),plantId:g.Rx().required(),workCenterId:g.Rx().required(),metalId:g.Rx().required()}),items:g.IX().of(g.Ry().shape({type:g.Rx().required(),metalId:g.Rx().test(function(e){return 1!=this.parent.type||!!e}),sku:g.Z_().required(),itemName:g.Z_().required()})).required(),scraps:g.IX().of(e6)}),onSubmit:async e=>{var l,a;if((null===(l=e.header)||void 0===l?void 0:l.smeltingMaxAllowedVariation)&&ld-lr>(null===(a=e.header)||void 0===a?void 0:a.smeltingMaxAllowedVariation)){e$({message:eO.smeltingMaxAllowedVariation});return}let t=e9(e),n=await eD({extension:x.B.FoundaryTransaction.set2,record:JSON.stringify(t)});r.ZP.success(e.recordId?eE.Edited:eE.Added),lI(null==n?void 0:n.recordId),e0()}}),e9=e=>{var l;return{header:{...e.header,date:(0,N.ku)(e.header.date),qtyDiff:ln,sumRMQty:lo,avgPurity:lu},items:null===(l=e.items)||void 0===l?void 0:l.map((l,a)=>({...l,trxId:(null==e?void 0:e.recordId)||0,seqNo:a+1,purity:l.purity/1e3})),scraps:((null==e?void 0:e.scraps)||[]).filter(e=>{var l;return null===(l=Object.values(e8))||void 0===l?void 0:l.every(l=>l(e))}).map((l,a)=>({...l,trxId:(null==e?void 0:e.recordId)||0,seqNo:a+1}))}},e5=!!(null===(T=e4.values)||void 0===T?void 0:T.header.recordId),e7=3===e4.values.header.status,le=function(e){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e4.values.items.reduce((a,t)=>l&&t.type!=l?a:a+(parseFloat(t[e])||0),0)},ll=null==e4?void 0:null===(E=e4.values)||void 0===E?void 0:null===(D=E.scraps)||void 0===D?void 0:D.reduce((e,l)=>e+(parseFloat(l.qty)||0),0),la=parseFloat((null===(Q=e4.values)||void 0===Q?void 0:null===(L=Q.header)||void 0===L?void 0:L.qty)||0)+parseFloat(ll||0),lt=le("qty"),ln=eU?parseFloat(lt||0)-parseFloat(la||0):(null===(B=e4.values)||void 0===B?void 0:null===($=B.header)||void 0===$?void 0:$.qtyDiff)||0,lr=le("qty",2),ld=le("expectedAlloyQty"),li=parseFloat(null===(U=e4.values)||void 0===U?void 0:null===(J=U.header)||void 0===J?void 0:J.purity),lo=eU?le("rmQty"):null===(W=e4.values)||void 0===W?void 0:null===(G=W.header)||void 0===G?void 0:G.sumRMQty,lu=eU?((lo||0)*((null===(K=e4.values)||void 0===K?void 0:null===(z=K.header)||void 0===z?void 0:z.baseSalesMetalPurity)||0)/(lt||0)).toFixed(2):(null===(H=e4.values)||void 0===H?void 0:null===(X=H.header)||void 0===X?void 0:X.avgPurity)||0,ls=li?e4.values.items.reduce((e,l)=>1!=l.type?e:e+(parseFloat(l.qty)||0)*(parseFloat(l.purity)||0)/li,0):0,lc=(e,l)=>parseFloat(e)-parseFloat(l),lv=(e,l,a)=>a?Math.abs(parseFloat(e)*parseFloat(l)/parseFloat(a)):0,lm=e=>{var l,a;let t=null===(a=e4.values)||void 0===a?void 0:null===(l=a.items)||void 0===l?void 0:l.map(l=>{let a=(null==l?void 0:l.type)==1?lv((null==l?void 0:l.qty)||0,(null==l?void 0:l.purity)||0,e||0):null==l?void 0:l.qtyAtPurity;return{...l,expectedAlloyQty:(null==l?void 0:l.type)==1?lc(a||0,(null==l?void 0:l.qty)||0):null==l?void 0:l.expectedAlloyQty,qtyAtPurity:a}});e4.setFieldValue("items",t)},ly=async()=>{var e;await eD({extension:x.B.FoundaryTransaction.post,record:JSON.stringify({...null===(e=e4.values)||void 0===e?void 0:e.header,date:(0,N.ku)(e4.values.header.date)})}),r.ZP.success(eE.Posted),e0(),eR.close()},lp=async()=>{var e;let l=await eD({extension:x.B.FoundaryTransaction.unpost,record:JSON.stringify({...null===(e=e4.values)||void 0===e?void 0:e.header,date:(0,N.ku)(e4.values.header.date)})});r.ZP.success(eE.Unposted),lI(null==l?void 0:l.recordId),e0()};async function lh(e,l){"metal"==l?eW.current=e?eB.filter(l=>l.metalId===e):[]:eW.current=ez.current||[]}async function lf(){let e=await eT({extension:C.$.Scrap.qry,parameters:"_metalId=0"});eJ(null==e?void 0:e.list)}async function lx(e){var l;if(!e)return;let a=await eT({extension:C.$.CurrentCost.get,parameters:"_itemId=".concat(e)});return null==a?void 0:null===(l=a.record)||void 0===l?void 0:l.currentCost}async function lI(e){var l,a,t,n;let{record:r}=await eT({extension:x.B.FoundaryTransaction.get2,parameters:"_recordId=".concat(e)});if(!r){e4.setValues({...e4.initialValues});return}let d=await lk((null==r?void 0:null===(l=r.header)||void 0===l?void 0:l.dtId)||null),i=((null==r?void 0:r.items)||[]).map((e,l)=>({...e,id:l+1,purity:1e3*e.purity,metalId:e.metalId||""})),o=((null==r?void 0:r.scraps)||[]).map((e,l)=>({...e,id:l+1})),u=await lS();e4.setValues({recordId:null==r?void 0:null===(a=r.header)||void 0===a?void 0:a.recordId,header:{...(null==r?void 0:r.header)||{},date:(0,N.a1)(null==r?void 0:null===(t=r.header)||void 0===t?void 0:t.date),smeltingMaxAllowedVariation:(null==d?void 0:d.smeltingMaxAllowedVariation)||null,baseSalesMetalPurity:(null==u?void 0:u.purity)*1e3||0,baseSalesMetalRef:(null==u?void 0:u.reference)||0},items:(null==i?void 0:i.length)?i:e4.initialValues.items,scraps:(null==o?void 0:o.length)?o:null===(n=e4.initialValues)||void 0===n?void 0:n.scraps}),eG(!1)}let lg=[{component:"numberfield",name:"id",label:eO.count,props:{readOnly:!0}},{component:"resourcecombobox",label:eO.type,name:"type",props:{datasetId:A.v.SMELTING_METAL_TYPE,displayField:"value",valueField:"key",displayFieldWidth:2,mapping:[{from:"key",to:"type"},{from:"value",to:"typeName"}]},onChange:async e=>{let{row:{update:l,newRow:a}}=e;(null==a?void 0:a.type)==2&&lh(),l({itemId:null,sku:"",itemName:"",metalId:"",metalRef:"",purity:(null==a?void 0:a.type)==1?0:""})}},{component:"resourcecombobox",label:eO.metal,name:"metalId",props:{endpointId:C.$.Metals.qry,valueField:"recordId",displayField:"reference",displayFieldWidth:1.5,mapping:[{from:"reference",to:"metalRef"},{from:"recordId",to:"metalId"},{from:"purity",to:"purity"}]},propsReducer(e){let{row:l,props:a}=e;return{...a,readOnly:!!l.itemId||2==l.type}},onChange:async e=>{let{row:{update:l,newRow:a}}=e;lh(null==a?void 0:a.metalId,"metal"),(null==a?void 0:a.purity)&&l({purity:1e3*a.purity})}},{component:"resourcecombobox",label:eO.sku,name:"sku",props:{store:null==eW?void 0:eW.current,valueField:"itemId",displayField:"sku",mapping:[{from:"itemName",to:"itemName"},{from:"itemId",to:"itemId"},{from:"sku",to:"sku"}],columnsInDropDown:[{key:"sku",value:"SKU"},{key:"itemName",value:"Item Name"}],displayFieldWidth:3.5},propsReducer(e){let{row:l,props:a}=e;return{...a,store:null==eW?void 0:eW.current}},onChange:async e=>{let{row:{update:l,newRow:a}}=e;(null==a?void 0:a.itemId)&&l({currentCost:await lx(null==a?void 0:a.itemId)})},flex:1.5},{component:"textfield",label:eO.itemName,name:"itemName",props:{readOnly:!0},flex:2},{component:"numberfield",name:"qty",label:eO.qty,updateOn:"blur",props:{allowNegative:!1,maxLength:12,decimalScale:2},onChange:e=>{let{row:{update:l,newRow:a}}=e;if(eG(!0),(null==a?void 0:a.type)==1){var t,n,r,d,i,o;let e=lv((null==a?void 0:a.qty)||0,(null==a?void 0:a.purity)||0,(null===(n=e4.values)||void 0===n?void 0:null===(t=n.header)||void 0===t?void 0:t.purity)||0);l({expectedAlloyQty:lc(e||0,(null==a?void 0:a.qty)||0),qtyAtPurity:e,rmQty:(null===(d=e4.values)||void 0===d?void 0:null===(r=d.header)||void 0===r?void 0:r.baseSalesMetalPurity)?(((null==a?void 0:a.qty)||0)*((null==a?void 0:a.purity)||0)/(null===(o=e4.values)||void 0===o?void 0:null===(i=o.header)||void 0===i?void 0:i.baseSalesMetalPurity)).toFixed(2):0,qty:(null==a?void 0:a.qty)||0})}else l({qty:(null==a?void 0:a.qty)||0})}},{component:"numberfield",name:"purity",label:eO.purity,props:{allowNegative:!1,maxLength:12,decimalScale:2},onChange:e=>{let{row:{update:l,newRow:a}}=e;if(eG(!0),(null==a?void 0:a.type)==1){var t,n,r,d,i,o;let e=lv((null==a?void 0:a.qty)||0,(null==a?void 0:a.purity)||0,(null===(n=e4.values)||void 0===n?void 0:null===(t=n.header)||void 0===t?void 0:t.purity)||0);l({expectedAlloyQty:lc(e||0,(null==a?void 0:a.qty)||0),qtyAtPurity:e,rmQty:(null===(d=e4.values)||void 0===d?void 0:null===(r=d.header)||void 0===r?void 0:r.baseSalesMetalPurity)?(((null==a?void 0:a.qty)||0)*((null==a?void 0:a.purity)||0)/(null===(o=e4.values)||void 0===o?void 0:null===(i=o.header)||void 0===i?void 0:i.baseSalesMetalPurity)).toFixed(2):0})}},propsReducer(e){let{row:l,props:a}=e;return{...a,readOnly:2==l.type}}},{component:"numberfield",name:"rmQty",label:"".concat(eO.qty," ").concat((null===(ee=e4.values)||void 0===ee?void 0:null===(Y=ee.header)||void 0===Y?void 0:Y.baseSalesMetalRef)||""),props:{decimalScale:2,readOnly:!0}},{component:"numberfield",name:"qtyAtPurity",label:eO.purityQty,props:{readOnly:!0,decimalScale:2}},{component:"numberfield",name:"expectedAlloyQty",label:eO.expectedAlloyQty,props:{readOnly:!0,decimalScale:2}},{component:"numberfield",name:"currentCost",label:eO.unitCost,props:{readOnly:!0}}],lb=[{component:"resourcecombobox",label:eO.sku,name:"sku",props:{endpointId:x.B.SmeltingScrapItem.qry,parameters:"_metalId=".concat(null===(ea=e4.values)||void 0===ea?void 0:null===(el=ea.header)||void 0===el?void 0:el.metalId),valueField:"itemId",displayField:"sku",displayFieldWidth:3,mapping:[{from:"itemName",to:"itemName"},{from:"itemId",to:"itemId"},{from:"sku",to:"sku"}],columnsInDropDown:[{key:"sku",value:"SKU"},{key:"itemName",value:"Item Name"}]},propsReducer(e){var l,a;let{row:t,props:n}=e;return{...n,readOnly:!(null===(a=e4.values)||void 0===a?void 0:null===(l=a.header)||void 0===l?void 0:l.metalId)}}},{component:"textfield",label:eO.itemName,name:"itemName",props:{readOnly:!0},flex:2},{component:"numberfield",name:"qty",label:eO.qty,props:{allowNegative:!1,maxLength:12,decimalScale:2},onChange:()=>{eG(!0)}}],lF=[{key:"Locked",condition:e7,onClick:"onUnpostConfirmation",onSuccess:lp,disabled:!e5},{key:"Unlocked",condition:!e7,onClick:ly,disabled:!e5||0!=e4.values.header.qtyDiff},{key:"IV",condition:!0,onClick:"onInventoryTransaction",disabled:!e5||!e7},{key:"GL",condition:!0,onClick:"onClickGL",datasetId:u.i.GLTransactionItem,valuesPath:e4.values.header,disabled:!e5}];async function lw(e){var l;if(!e)return;let a=await eT({extension:C.$.Physical.get,parameters:"_itemId=".concat(e)});return(null==a?void 0:null===(l=a.record)||void 0===l?void 0:l.metalId)||null}async function lk(e){if(!e){e4.setFieldValue("header.smeltingMaxAllowedVariation",null);return}let l=await eT({extension:x.B.DocumentTypeDefault.get,parameters:"_dtId=".concat(e)});return(null==l?void 0:l.record)||{}}function lq(){e4.setFieldValue("header.itemName",""),e4.setFieldValue("header.sku",""),e4.setFieldValue("header.itemId",null)}async function lS(){if(!e3)return;let e=await eT({extension:C.$.Metals.get,parameters:"_recordId=".concat(e3)});return(null==e?void 0:e.record)||{}}return(0,n.useEffect)(()=>{!async function(){if(!eM){var e,l;let a=await lk(null==e4?void 0:null===(l=e4.values)||void 0===l?void 0:null===(e=l.header)||void 0===e?void 0:e.dtId);e4.setFieldValue("header.siteId",(null==a?void 0:a.siteId)||null),e4.setFieldValue("header.workCenterId",(null==a?void 0:a.workCenterId)||null),e4.setFieldValue("header.smeltingMaxAllowedVariation",(null==a?void 0:a.smeltingMaxAllowedVariation)||null)}}()},[null===(en=e4.values)||void 0===en?void 0:null===(et=en.header)||void 0===et?void 0:et.dtId]),(0,n.useEffect)(()=>{!async function(){await lf();let{list:e}=await eT({extension:x.B.AlloyMetals.qry,parameters:"_filter="}),l=(e||[]).map(e=>({...e,itemName:e.name}));ez.current=l||[],eM&&lI(eM)}()},[]),(0,n.useEffect)(()=>{!async function(){if(e3&&!eM){let e=await lS();e4.setFieldValue("header.baseSalesMetalPurity",(null==e?void 0:e.purity)*1e3||0),e4.setFieldValue("header.baseSalesMetalRef",(null==e?void 0:e.reference)||"")}}()},[e3]),(0,t.jsx)(b.Z,{resourceId:u.i.MetalSmelting,form:e4,maxAccess:eH,actions:lF,previewReport:e5,editMode:e5,functionId:eK,disabledSubmit:e7,children:(0,t.jsxs)(s.R,{children:[(0,t.jsx)(c.g,{children:(0,t.jsxs)(I.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(I.ZP,{item:!0,xs:4,children:(0,t.jsxs)(I.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(q.Z,{endpointId:k.r.DocumentType.qry,parameters:"_startAt=0&_pageSize=1000&_dgId=".concat(eK),filter:e5?void 0:e=>1===e.activeStatus,name:"header.dtId",label:eO.docType,readOnly:e5,valueField:"recordId",displayField:"name",values:e4.values.header,onChange:(e,l)=>{eY(l),e4.setFieldValue("header.dtId",(null==l?void 0:l.recordId)||null)},error:(null===(er=e4.touched.header)||void 0===er?void 0:er.dtId)&&!!(null===(ed=e4.errors.header)||void 0===ed?void 0:ed.dtId),maxAccess:eH})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(F.Z,{name:"header.reference",label:eO.reference,value:e4.values.header.reference,readOnly:e5,maxAccess:!e5&&eH,maxLength:"15",onChange:e4.handleChange,onClear:()=>e4.setFieldValue("header.reference",""),error:(null===(ei=e4.touched.header)||void 0===ei?void 0:ei.reference)&&!!(null===(eo=e4.errors.header)||void 0===eo?void 0:eo.reference)})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(S.Z,{name:"header.date",required:!0,readOnly:e7,label:eO.date,value:e4.values.header.date,onChange:e4.setFieldValue,maxAccess:eH,onClear:()=>e4.setFieldValue("header.date",null),error:(null===(eu=e4.touched.header)||void 0===eu?void 0:eu.date)&&!!(null===(es=e4.errors.header)||void 0===es?void 0:es.date)})})]})}),(0,t.jsx)(I.ZP,{item:!0,xs:4,children:(0,t.jsxs)(I.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(q.Z,{endpointId:k.r.Plant.qry,name:"header.plantId",readOnly:e5,required:!0,label:eO.plant,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:e4.values.header,maxAccess:eH,onChange:(e,l)=>{e4.setFieldValue("header.plantId",(null==l?void 0:l.recordId)||null)},error:(null===(ec=e4.touched.header)||void 0===ec?void 0:ec.plantId)&&!!(null===(ev=e4.errors.header)||void 0===ev?void 0:ev.plantId)})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(q.Z,{endpointId:C.$.Site.qry,name:"header.siteId",label:eO.site,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],valueField:"recordId",displayField:["reference","name"],values:e4.values.header,maxAccess:eH,readOnly:e7,onChange:(e,l)=>e4.setFieldValue("header.siteId",(null==l?void 0:l.recordId)||null),required:!0,error:(null===(em=e4.touched.header)||void 0===em?void 0:em.siteId)&&!!(null===(ey=e4.errors.header)||void 0===ey?void 0:ey.siteId)})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(q.Z,{endpointId:Z.u.WorkCenter.qry,name:"header.workCenterId",label:eO.workCenter,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:e4.values.header,required:!0,readOnly:e7,maxAccess:eH,onChange:(e,l)=>e4.setFieldValue("header.workCenterId",(null==l?void 0:l.recordId)||null),error:(null===(ep=e4.touched.header)||void 0===ep?void 0:ep.workCenterId)&&(null===(eh=e4.errors.header)||void 0===eh?void 0:eh.workCenterId)})})]})}),(0,t.jsx)(I.ZP,{item:!0,xs:4,children:(0,t.jsxs)(I.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(q.Z,{endpointId:C.$.Metals.qry,name:"header.metalId",label:eO.metal,valueField:"recordId",displayField:"reference",values:e4.values.header,required:!0,onChange:(e,l)=>{lq(),e4.setFieldValue("header.metalId",(null==l?void 0:l.recordId)||null)},error:(null===(ef=e4.touched.header)||void 0===ef?void 0:ef.metalId)&&!!(null===(ex=e4.errors.header)||void 0===ex?void 0:ex.metalId),maxAccess:eH})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(V.U,{endpointId:C.$.Item.snapshot,name:"header.itemId",label:eO.sku,valueField:"sku",displayField:"name",valueShow:"sku",secondValueShow:"itemName",form:e4,formObject:e4.values.header,columnsInDropDown:[{key:"sku",value:"SKU"},{key:"name",value:"Name"}],onChange:async(e,l)=>{e4.setFieldValue("header.sku",null);let a=await lw(null==l?void 0:l.recordId);if((null==l?void 0:l.recordId)&&a!=e4.values.header.metalId){e$({message:eO.metalMismatch}),lq();return}e4.setFieldValue("header.itemName",(null==l?void 0:l.name)||""),e4.setFieldValue("header.sku",(null==l?void 0:l.sku)||""),e4.setFieldValue("header.itemId",(null==l?void 0:l.recordId)||null)},readOnly:e7,displayFieldWidth:2,maxAccess:e_,errorCheck:"header.itemId"})}),(0,t.jsx)(I.ZP,{item:!0,xs:6,children:(0,t.jsx)(j.Z,{name:"header.purity",label:eO.purity,readOnly:e7,onBlur:e=>{let l=Number(e.target.value.replace(/,/g,""));lm(l),e4.setFieldValue("header.purity",l)},value:e4.values.header.purity,maxLength:12,decimalScale:3,allowNegative:!1,align:"right",onClear:()=>{lm(0),e4.setFieldValue("header.purity","")},error:(null===(eI=e4.touched.header)||void 0===eI?void 0:eI.purity)&&!!(null===(eg=e4.errors.header)||void 0===eg?void 0:eg.purity)})}),(0,t.jsx)(I.ZP,{item:!0,xs:6,children:(0,t.jsx)(j.Z,{name:"header.qty",label:eO.qty,onBlur:e=>{eG(!0);let l=Number(e.target.value.replace(/,/g,""));e4.setFieldValue("header.qty",l)},value:null===(eb=e4.values.header)||void 0===eb?void 0:eb.qty,maxLength:12,decimalScale:3,allowNegative:!1,align:"right",readOnly:e7,onClear:()=>e4.setFieldValue("header.qty",""),error:(null===(eF=e4.touched.header)||void 0===eF?void 0:eF.qty)&&!!(null===(ew=e4.errors.header)||void 0===ew?void 0:ew.qty)})})]})})]})}),(0,t.jsx)(v.Q,{children:(0,t.jsx)(P._,{onChange:e=>e4.setFieldValue("items",e),value:null===(ek=e4.values)||void 0===ek?void 0:ek.items,error:null===(eq=e4.errors)||void 0===eq?void 0:eq.items,name:"items",columns:lg,initialValues:null==e4?void 0:null===(eN=e4.initialValues)||void 0===eN?void 0:null===(eS=eN.items)||void 0===eS?void 0:eS[0],maxAccess:eH,disabled:e7,allowDelete:!e7,onSelectionChange:(e,l,a)=>{let t=2!=e.type?"metal":"";"sku"==a&&lh(null==e?void 0:e.metalId,t)}})}),(0,t.jsx)(c.g,{children:(0,t.jsxs)(I.ZP,{container:!0,xs:12,children:[(0,t.jsx)(I.ZP,{container:!0,xs:6,children:(0,t.jsx)(P._,{onChange:e=>e4.setFieldValue("scraps",e),value:null===(ej=e4.values)||void 0===ej?void 0:ej.scraps,error:null===(eC=e4.errors)||void 0===eC?void 0:eC.scraps,name:"ScrapItems",columns:lb,initialValues:null==e4?void 0:null===(eP=e4.initialValues)||void 0===eP?void 0:eP.scraps,maxAccess:eH,disabled:e7,allowDelete:!e7,height:"26vh"})}),(0,t.jsx)(I.ZP,{item:!0,xs:4,sx:{pl:2,pt:3},children:(0,t.jsx)(M.Z,{name:"header.notes",label:eO.notes,value:null===(eZ=e4.values.header)||void 0===eZ?void 0:eZ.notes,rows:4,maxLength:"200",readOnly:e7,maxAccess:eH,onChange:e=>e4.setFieldValue("header.notes",e.target.value),onClear:()=>e4.setFieldValue("header.notes",""),error:(null===(eV=e4.touched.header)||void 0===eV?void 0:eV.notes)&&!!(null===(eA=e4.errors.header)||void 0===eA?void 0:eA.notes)})}),(0,t.jsx)(I.ZP,{container:!0,xs:2,justifyContent:"flex-end",sx:{pl:2,pt:3},children:(0,t.jsxs)(I.ZP,{container:!0,spacing:2,children:[(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.totalMetal,value:ls,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.totalAlloy,value:lr,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.expectedAlloy,value:ld,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.qtyIn,value:la,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.qtyOut,value:lt,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.qtyDiff,value:ln,decimalScale:3,readOnly:!0,align:"right"})}),(0,t.jsx)(I.ZP,{item:!0,xs:12,children:(0,t.jsx)(j.Z,{label:eO.avgPurity,value:lu,decimalScale:3,readOnly:!0,align:"right"})})]})})]})})]})})}function T(){let{getRequest:e,postRequest:l}=(0,n.useContext)(i.$),{platformLabels:a}=(0,n.useContext)(h.l),{stack:I}=(0,m.zY)();async function g(){let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{_startAt:a=0,_pageSize:t=50,params:n=[]}=l;return{...await e({extension:x.B.FoundaryTransaction.page,parameters:"_startAt=".concat(a,"&_params=").concat(n,"&_pageSize=").concat(t,"&_functionId=").concat(p.J.MetalSmelting)}),_startAt:a}}let{query:{data:b},refetch:F,labels:w,filterBy:k,paginationParameters:q,access:S,invalidate:N}=(0,o.J)({queryFn:g,endpointId:x.B.FoundaryTransaction.page,datasetId:u.i.MetalSmelting,filter:{filterFn:j}});async function j(l){let{filters:a,pagination:t}=l;return(null==a?void 0:a.qry)?await e({extension:x.B.FoundaryTransaction.snapshot,parameters:"_filter=".concat(a.qry,"&_functionId=").concat(p.J.MetalSmelting)}):g({_startAt:t._startAt||0,params:null==a?void 0:a.params})}let C=[{field:"reference",headerName:w.reference,flex:1},{field:"dtName",headerName:w.docType,flex:1},{field:"date",headerName:w.date,flex:1,type:"date"},{field:"plantName",headerName:w.plant,flex:1},{field:"siteRef",headerName:w.siteRef,flex:1},{field:"siteName",headerName:w.siteName,flex:1},{field:"statusName",headerName:w.status,flex:1}];function P(e){I({Component:R,props:{labels:w,recordId:e,access:S},width:1100,height:730,title:w.metalSmelting})}let{proxyAction:Z}=(0,y.G)({functionId:p.J.MetalSmelting,action:P}),V=async()=>{await Z()},A=async e=>{await l({extension:x.B.FoundaryTransaction.del,record:JSON.stringify(e)}),N(),r.ZP.success(a.Deleted)};return(0,t.jsxs)(s.R,{children:[(0,t.jsx)(c.g,{children:(0,t.jsx)(f.Z,{onAdd:V,maxAccess:S,reportName:"FOTRX",filterBy:k})}),(0,t.jsx)(v.Q,{children:(0,t.jsx)(d.Z,{name:"table",columns:C,gridData:b,rowId:["recordId"],onEdit:e=>{P(null==e?void 0:e.recordId)},onDelete:A,deleteConfirmationType:"strict",pageSize:50,paginationParameters:q,refetch:F,paginationType:"api",maxAccess:S})})]})}},67920:function(e,l,a){"use strict";a.d(l,{m:function(){return n}});var t=a(48601);function n(e,l,a){var n;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"items",d={...e};return null==a||null===(n=a.record)||void 0===n||n.controls.forEach(e=>{let{controlId:l,accessLevel:a}=e,[t,n]=null==l?void 0:l.split(".");t!==r||2!==a||n in d||(d[n]=e=>(null==e?void 0:e[n])!=null),(1===a||4===a)&&n in d&&delete d[n]}),{schema:t.Ry().shape({...Object.keys(d).reduce((e,a)=>(e[a]=t.nK().nullable().test(function(e){var t;let n=this.parent,[,r]=this.path.match(/^(\w+)\[(\d+)\]/)||[],i=(null===(t=this.options.context)||void 0===t?void 0:t[r])||[];if(l||!l&&i.length>1){if(null!==n[a]&&void 0!==n[a]&&0!==n[a]&&""!==d[a]&&!d[a](n))return!1;if(!Object.entries(d).some(e=>{let[,l]=e;return!!l(n)}))return!0}return!!d[a](n)&&void 0!==e}),e),{})}),requiredFields:d}}},1685:function(e,l,a){"use strict";a.d(l,{m:function(){return t}});let t=e=>{let l=window.sessionStorage.getItem(e);return l?JSON.parse(l):null}},98345:function(e,l,a){"use strict";a.d(l,{H:function(){return p},G:function(){return y}});var t=a(45300),n=a(2784),r=a(96026),d=a(38449);a(26612);var i=a(65947),o=a(1685);let u=async(e,l,a)=>{try{let t=await e({extension:l,parameters:a});return l.includes("qry")?t:t.record}catch(e){return null}},s=(e,l,a,t)=>{let n=(e=JSON.parse(JSON.stringify(e))).record.controls,r=n.find(e=>"reference"===e.controlId);return r?r.accessLevel=(null==l?void 0:l.mandatory)?i.$7:i.rr:(null==l?void 0:l.mandatory)?n.push({sgId:0,resourceId:"",controlId:"".concat(t?t+".":"","reference"),accessLevel:(null==l?void 0:l.mandatory)?i.$7:i.rr}):(null==l?void 0:l.readOnly)?n.push({sgId:0,resourceId:"",controlId:"".concat(t?t+".":"","reference"),accessLevel:(null==l?void 0:l.readOnly)?i.rr:i.$7}):n=e.record.controls.filter(e=>"reference"!=e.controlId),a&&n.push({sgId:0,resourceId:"",controlId:"".concat(t?t+".":"","dtId"),accessLevel:i.$7}),{...e,record:{...e.record,controls:n}}},c=async(e,l,a)=>{let t,n;switch(a){case"dtId":let r=(0,o.m)("userData"),i=null==r?void 0:r.userId;n="_userId=".concat(i,"&_functionId=").concat(l),t=d.r.UserFunction.get;break;case"glbSysNumberRange":n="_recordId=".concat(l),t=d.r.SystemFunction.get;break;case"DocumentType":n="_dgId=".concat(l,"&_startAt=",0,"&_pageSize=",50),t=d.r.DocumentType.qry;break;case"DcTypNumberRange":n="_recordId=".concat(l),t=d.r.DocumentType.get;break;case"isExternal":n="_recordId=".concat(l),t=d.r.NumberRange.get;break;default:return null}return await u(e,t,n)},v=async function(e){let l,a,t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,d=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,o=!(arguments.length>4)||void 0===arguments[4]||arguments[4],u=arguments.length>5?arguments[5]:void 0,v=void 0===i&&r&&await c(e,r,"dtId"),m=null==v?void 0:v.dtId,y="",p=!0;if(v&&void 0===i||"nraId"===i){if(m){let a=await c(e,m,"DcTypNumberRange");l=null==a?void 0:a.nraId,p=!((null==a?void 0:a.activeStatus)<0),l||(y="Assign the document type to a number range")}if((!m||!p)&&o&&r){var h;let l=await c(e,r,"DocumentType");n=(null==l?void 0:null===(h=l.list)||void 0===h?void 0:h.filter(e=>(null==e?void 0:e.activeStatus)===1).length)>0}}if(("nraId"===i||void 0===i)&&r){if((!m||m)&&!l||l&&!p){let a=await c(e,r,"glbSysNumberRange");(l=null==a?void 0:a.nraId)&&n&&(n=!1),p=!0}y=l||n?"":"Assign the system Function to a number range"}i>0&&!l&&(l=i),l&&p?(a={readOnly:null==(t=await c(e,l,"isExternal"))||!t.external,mandatory:null!=t&&!!t.external},d&&(d=await s(d,a,n,u))):!l&&d&&(d=await s(d,a,n,u));let f=u?"".concat(u,".reference"):"reference";return{dtId:m,resetReference:null==a?void 0:a.readOnly,dcTypeRequired:n,reference:{fieldName:f,isEmpty:(null==t?void 0:t.external)!==void 0&&(null==t||!t.external)},errorMessage:y,maxAccess:d,selectNraId:i}};var m=a(65950);function y(e){let{functionId:l,action:a,hasDT:t}=e,{getRequest:d}=(0,n.useContext)(m.$),{stack:i}=(0,r.V)();return{proxyAction:async()=>{let e=await v(d,l,"",void 0,t);(null==e?void 0:e.errorMessage)?i({message:null==e?void 0:e.errorMessage}):await a()}}}function p(e){var l;let{functionId:a,access:d,hasDT:i,enabled:o=!0,objectName:u=""}=e,{getRequest:s}=(0,n.useContext)(m.$),{stack:c}=(0,r.V)(),[y,p]=(0,n.useState)(),h=async e=>{let l=await v(s,a,d,e,i,u);if(!l.errorMessage)return l;c({message:null==l?void 0:l.errorMessage})},f=(0,t.a)({retry:!1,staleTime:0,enabled:o,queryKey:[a,y,!!d,o],queryFn:y||"nraId"===y?()=>h(y):()=>h()});return{documentType:f.data,maxAccess:(null==f?void 0:null===(l=f.data)||void 0===l?void 0:l.maxAccess)||d,changeDT(e){p((null==e?void 0:e.nraId)||"nraId")}}}}},function(e){e.O(0,[92515,2494,36908,49774,92888,40179],function(){return e(e.s=45686)}),_N_E=e.O()}]);