(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[20035],{50316:function(e,l,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/return-on-invoice",function(){return t(21750)}])},64581:function(e,l){"use strict";l.Z={src:"/_next/static/media/imgSerials.d1ee59bb.png",height:17,width:23,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAGCAMAAADJ2y/JAAAAIVBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABt0UjBAAAAC3RSTlMCZzsmQ6RbWbaSTwNdgTwAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAArSURBVHicY2BiZ2BgYOBiZmBmYmRjZGRhYGBg4eBkZWVDYjAzMbKDpWCKARB/AJwjPQgCAAAAAElFTkSuQmCC",blurWidth:8,blurHeight:6}},21750:function(e,l,t){"use strict";t.r(l),t.d(l,{default:function(){return X}});var i=t(52322),n=t(2784),a=t(71987),d=t(65950),o=t(69387),r=t(62202),s=t(61802),u=t(26612),c=t(31389),v=t(33625),m=t(62362),p=t(19473),y=t(98345),x=t(7121),I=t(22341),h=t(36908),f=t(89330),F=t(39812),b=t(60218),P=t(48601),A=t(82737),g=t(5088),w=t(21581),N=t(8661),V=t(38449),k=t(65215),C=t(27423),j=t(76399),T=t(91406),Z=t(25870),R=t(80983),O=t(39704),D=t(86626),S=t(18996),_=t(16096),q=t(75163),Q=t(96026),M=t(19689),B=t(19568),L=t(253),E=t(69627),W=t(1251),G=t(26553),U=t(72747),z=t(54074);function J(e){var l,t,a;let{form:o,maxAccess:r,labels:s,setReCal:u,window:p}=e,{getRequest:y}=(0,n.useContext)(d.$),{formik:x}=(0,R.c)({maxAccess:r,initialValues:{items:[{id:1,sku:"",itemName:"",qty:0,returnedQty:0,balanceQty:0,returnNow:0}]}});async function h(e){if(!e)return;let l=await y({extension:Z.H.TaxDetailPack.qry,parameters:"_taxId=".concat(e)});return null==l?void 0:l.list}async function F(e){var l;let t=((null==x?void 0:null===(l=x.values)||void 0===l?void 0:l.items)||[]).filter(l=>!!e||!0===l.checked&&l.balanceQty>0).map((l,t)=>{let i=e?l.balanceQty:l.returnNow;return{...l,item:{...l.item,id:t+1,returnedQty:l.returnedQty,returnNowQty:l.returnNow,returnNow:i,invoiceSeqNo:l.item.seqNo,extendedPrice:0!=l.item.extendedPrice?i*l.item.extendedPrice/l.item.qty:l.item.extendedPrice}}});if(0===t.length)return;let i=await Promise.all(t.map(async(e,l)=>{var t;let{item:i,qty:n,balanceQty:a,returnedQty:d}=e,{taxId:r}=i,s=(0,D.Ch)({priceType:(null==i?void 0:i.priceType)||0,basePrice:parseFloat(null==i?void 0:i.basePrice)||0,volume:parseFloat(null==i?void 0:i.volume),weight:parseFloat(null==i?void 0:i.weight),unitPrice:parseFloat((null==i?void 0:i.unitPrice)||0),upo:null==i?void 0:i.upo,qty:(null==i?void 0:i.returnNow)==0?parseFloat(a):parseFloat(null==i?void 0:i.returnNow),extendedPrice:parseFloat(null==i?void 0:i.extendedPrice),mdAmount:parseFloat(null==i?void 0:i.mdAmount),mdType:parseInt(null==i?void 0:i.mdType),baseLaborPrice:0,totalWeightPerG:0,mdValue:parseFloat(null==i?void 0:i.mdValue),tdPct:(null==i?void 0:null===(t=i.values)||void 0===t?void 0:t.tdPct)||0,dirtyField:D.bT}),u=await h(r),c=null==u?void 0:u.map(e=>({taxId:r,taxCodeId:e.taxCodeId,taxBase:e.taxBase,amount:e.amount})),v=(0,S.VW)({priceType:null==s?void 0:s.priceType,basePrice:(o.values.metalPrice||0)*(o.values.metalPurity||0),qty:n,weight:null==s?void 0:s.weight,extendedPrice:parseFloat(s.extendedPrice)||0,baseLaborPrice:s.baseLaborPrice||0,vatAmount:0,tdPct:o.values.tdPct,taxDetails:o.values.isVattable?c:null}),{muId:m,...p}=i;return{...p,id:l+1,basePrice:s.basePrice,unitPrice:s.unitPrice,extendedPrice:s.extendedPrice,mdValue:s.mdValue,mdType:s.mdType,baseLaborPrice:s.baseLaborPrice,mdAmountPct:s.mdType,vatAmount:v.vatAmount,returnedQty:d,balanceQty:a,returnNowQty:((null==s?void 0:s.qty)||0).toFixed((null==p?void 0:p.decimals)||0),totalWeight:(s.weight||0)*(s.qty||0),taxDetails:o.values.isVattable?c:null}}));o.setFieldValue("items",i),u(!0),p.close()}let P=[{component:"checkbox",label:" ",name:"checked",async onChange(e){let{row:{update:l,newRow:t}}=e;l({returnNow:(null==t?void 0:t.checked)?null==t?void 0:t.balanceQty:0})}},{component:"textfield",label:s.sku,name:"sku",flex:2,props:{readOnly:!0}},{component:"textfield",label:s.itemName,name:"itemName",flex:3,props:{readOnly:!0}},{component:"numberfield",label:s.qty,name:"qty",flex:2,props:{readOnly:!0}},{component:"numberfield",label:s.returnQty,name:"returnedQty",flex:2,props:{readOnly:!0}},{component:"numberfield",label:s.balanceQty,name:"balanceQty",flex:2,props:{readOnly:!0}},{component:"numberfield",label:s.returnNow,flex:2,name:"returnNow",updateOn:"blur",onChange(e){let{row:{update:l,newRow:t}}=e;if(!t.returnNow){l({returnNow:0});return}l({returnNow:t.returnNow>t.balanceQty?0:t.returnNow,isEditMode:!1})}}],A=[{key:"Import",condition:!0,onClick:()=>{F(!1)},disabled:x.values.items.every(e=>!e.checked)},{key:"ImportAll",condition:!0,onClick:()=>{F(!0)}}];async function g(){var e,l;let t=[];if(null==o?void 0:null===(e=o.values)||void 0===e?void 0:e.recordId){let e=await y({extension:I.P.ReturnItem.qry,parameters:"_returnId=".concat(o.values.recordId)});t=null==e?void 0:null===(l=e.list)||void 0===l?void 0:l.map(e=>({...e,returnNowQty:e.qty,componentSeqNo:e.componentSeqNo||0,isEditMode:!0}))}let i=t.length>0?[...t,...o.values.items]:o.values.items,n=(t.length>0?Array.from(i.reduce((e,l)=>{let t="".concat(l.itemId,"_").concat(l.seqNo);return e.has(t)||e.set(t,l),e},new Map).values()):o.values.items).map(e=>(e.isEditMode||(e.isEditMode=!1),e)),a=await y({extension:I.P.ReturnItem.balance,parameters:"_invoiceId=".concat(o.values.invoiceId)}),d=null==a?void 0:a.list.map((e,l)=>{let{seqNo:t,componentSeqNo:i,qty:a=0,itemId:d}=e.item,r=n.findIndex(e=>e.seqNo==t&&e.componentSeqNo==i),s=o.values.items.some(e=>e.seqNo==t&&e.itemId==d),u={...e,id:l+1,itemId:e.item.itemId,sku:e.item.sku,itemName:e.item.itemName,qty:e.item.qty||0},c=-1!=r?n[r]:null;if(c)u.checked=s,u.returnNow=c.returnNow||c.returnNowQty,c.isEditMode?(u.returnedQty=(u.returnedQty||0)-u.returnNow||0,u.balanceQty=(u.balanceQty||0)+u.returnNow||0,c.isEditMode||(u.returnNow=0)):u.returnedQty=c.returnedQty||0;else{var v,m;u.returnNow=0,u.item.invoiceId=(null==o?void 0:null===(v=o.values)||void 0===v?void 0:v.invoiceId)?parseInt(o.values.invoiceId):0,u.item.invoiceRef=(null==o?void 0:null===(m=o.values)||void 0===m?void 0:m.invoiceRef)||null}return u.balanceQty=a-(u.returnedQty||0),u});x.setFieldValue("items",null==d?void 0:d.filter(e=>e.item.qty!=e.returnedQty))}return(0,n.useEffect)(()=>{g()},[]),(0,i.jsx)(z.Z,{isSaved:!1,actions:A,maxAccess:r,editMode:!0,children:(0,i.jsxs)(c.R,{children:[(0,i.jsx)(v.g,{children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:6,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(C.U,{endpointId:I.P.Client.snapshot,valueField:"reference",displayField:"name",secondFieldLabel:s.name,name:"clientId",label:s.client,form:o,readOnly:!0,valueShow:"clientRef",secondValueShow:"clientName"})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:I.P.ReturnOnInvoice.balance,parameters:"_clientId=".concat(o.values.clientId,"&_returnDate=").concat((null==o?void 0:null===(t=o.values)||void 0===t?void 0:null===(l=t.date)||void 0===l?void 0:l.toISOString().split("T")[0])+"T00:00:00"),name:"invoiceId",label:s.invoice,valueField:"recordId",displayField:"reference",readOnly:!0,values:o.values})})]})}),(0,i.jsx)(b.ZP,{item:!0,xs:6,children:(0,i.jsx)(f.Z,{name:"date",label:s.date,value:null==o?void 0:null===(a=o.values)||void 0===a?void 0:a.date,readOnly:!0})})]})}),(0,i.jsx)(m.Q,{children:(0,i.jsx)(j._,{onChange:e=>x.setFieldValue("items",e),value:x.values.items,error:x.errors.items,columns:P,name:"items",maxAccess:r,allowDelete:!1,allowAddNewLine:!1})})]})})}var K=t(85572);function $(e){var l,o,h,z,$,X,Y,H,ee,el,et,ei,en,ea,ed,eo,er,es,eu,ec,ev,em,ep,ey,ex,eI,eh,ef;let{labels:eF,access:eb,recordId:eP,currency:eA}=e,{getRequest:eg,postRequest:ew}=(0,n.useContext)(d.$),{stack:eN}=(0,s.zY)(),{stack:eV}=(0,Q.V)(),{platformLabels:ek,defaultsData:eC}=(0,n.useContext)(p.l),[ej,eT]=(0,n.useState)({text:"%",value:2}),[eZ,eR]=(0,n.useState)(!1),{documentType:eO,maxAccess:eD,changeDT:eS}=(0,y.H)({functionId:x.J.ReturnOnInvoice,access:eb,enabled:!eP}),e_=(0,a.E)({endpointId:I.P.ReturnOnInvoice.page}),eq=null==eC?void 0:null===(o=eC.list)||void 0===o?void 0:null===(l=o.find(e=>{let{key:l}=e;return"salesTD"===l}))||void 0===l?void 0:l.value,eQ=null==eC?void 0:null===(z=eC.list)||void 0===z?void 0:null===(h=z.find(e=>{let{key:l}=e;return"plId"===l}))||void 0===h?void 0:h.value;async function eM(e){if(!e)return null;let l=await eg({extension:I.P.SalesPerson.get,parameters:"_recordId=".concat(e)}),t=null==l?void 0:l.record;return!t||t.isInactive?null:e}let eB={dtId:null,commitItems:!1,isDefaultDtPresent:!1,reference:"",status:1,date:new Date,currencyId:parseInt(eA),plantId:null,spId:null,szId:null,siteId:null,invoiceId:null,invoiceRef:"",clientId:null,clientRef:"",clientName:"",exRate:1,description:"",amount:0,baseAmount:0,rateCalcMethod:1,subtotal:0,miscAmount:0,isVattable:!1,vatAmount:0,tdType:2,tdPct:0,tdAmount:0,billAddressId:null,billAddress:"",returnReasonId:null,contactId:null,plId:null,qty:0,pcs:0,isVerified:!1,metalPrice:0,KGmetalPrice:0,hiddenkgMetalPrice:0,clientDiscount:0,currentDiscount:0,items:[{id:1,returnId:eP||0,seqNo:1,componentSeqNo:null,lotCategoryId:null,invoiceId:null,invoiceRef:null,invoiceSeqNo:1,itemName:"",muId:null,baseQty:0,applyVat:!1,unitCost:0,isMetal:!1,metalId:0,metalPurity:0,taxId:0,totalWeight:0,balanceQty:0,pieces:0,itemId:null,sku:null,priceType:1,basePrice:0,baseLaborPrice:0,volume:0,weight:0,unitPrice:0,msId:null,upo:0,qty:0,mdAmount:0,mdType:1,mdValue:0,vatPct:0,vatAmount:0,extendedPrice:0,notes:null,returnNowQty:0,returnedQty:0,trackBy:null,isEditMode:!1,serials:[]}]},{formik:eL}=(0,R.c)({maxAccess:eD,documentType:{key:"dtId",value:null==eO?void 0:eO.dtId},initialValues:eB,validateOnChange:!0,validationSchema:P.Ry({currencyId:P.Rx().required(),date:P.Z_().required(),clientId:P.Rx().required(),siteId:P.Rx().nullable().test(function(e){let{dtId:l,commitItems:t,isDefaultDtPresent:i}=this.parent;return!!l&&!!i&&(!l||!t)||!!e}),items:P.IX().of(P.Ry().shape({returnNowQty:P.Rx().required().min(1),sku:P.Z_().required(),itemName:P.Z_().required()}))}),onSubmit:async e=>{let l={...e};delete l.items;let t={...l,date:(0,F.ku)(l.date),miscAmount:l.miscAmount||0};delete t.serials;let i=[];1==t.rateCalcMethod?t.baseAmount=Number(t.amount)*t.exRate:2==t.rateCalcMethod&&(t.baseAmount=Number(t.amount)/t.exRate);let n=eL.values.items.map((l,n)=>{let a=n+1;return(l.serials||[]).forEach(e=>{i.push({...e,seqNo:a,returnId:t.recordId})}),{...l,seqNo:a,qty:l.sku&&l.returnNowQty||l.qty,applyVat:e.isVattable||!1}}),a=await ew({extension:I.P.ReturnOnInvoice.set2,record:JSON.stringify({header:t,items:n,serials:i||[],lots:[]})});r.ZP.success(eE?ek.Edited:ek.Added),await lu(a.recordId),e_()}}),eE=!!eL.values.recordId,eW=3==eL.values.status,eG=(0,n.useRef)(null==eL?void 0:null===($=eL.values)||void 0===$?void 0:$.items);async function eU(e){if(!e)return;let l=await eg({extension:k.$.Measurement.get,parameters:"_recordId=".concat(e)});return null==l?void 0:l.record}let ez=[!eL.values.invoiceId&&{component:"resourcecombobox",label:eF.invoice,name:"invoiceRef",flex:2,props:{endpointId:I.P.ReturnOnInvoice.balance,parameters:"_clientId=".concat(eL.values.clientId,"&_returnDate=").concat((null==eL?void 0:null===(Y=eL.values)||void 0===Y?void 0:null===(X=Y.date)||void 0===X?void 0:X.toISOString().split("T")[0])+"T00:00:00"),displayField:"reference",valueField:"recordId",mapping:[{from:"recordId",to:"invoiceId"},{from:"reference",to:"invoiceRef"}]},async onChange(e){let{row:{update:l}}=e;if(!eL.values.currencyId){l({invoiceId:null,invoiceRef:null,invoiceName:null}),eV({message:eF.noCurrency});return}},propsReducer(e){let{row:l,props:t}=e;return{...t,readOnly:l.invoiceId}}},{component:"resourcelookup",label:eF.sku,name:"sku",flex:2,props:{endpointId:k.$.Item.snapshot,parameters:{_categoryId:0,_msId:0,_startAt:0,_size:1e3},displayField:"sku",valueField:"sku",mapping:[{from:"recordId",to:"itemId"},{from:"sku",to:"sku"},{from:"name",to:"itemName"},{from:"trackBy",to:"trackBy"}],columnsInDropDown:[{key:"sku",value:"SKU"},{key:"name",value:"Item Name"},{key:"flName",value:"FL Name"}],displayFieldWidth:5,filter:{salesItem:!0}},async onChange(e){var l,t,i,n,a,d,o,r,s,u,c,v,m,p,y,x,h,f,F,b,P,A,g;let w,N,{row:{update:V,newRow:k}}=e;if(!eL.values.currencyId){V({itemId:null,sku:null,itemName:null}),eV({message:eF.noCurrency});return}if(!k.itemId)return;let C={};if(!eQ&&!eL.values.plId){eV({message:eF.noPriceLevel});return}if(k.invoiceId){if(!(C=((await eg({extension:I.P.ReturnItem.balance,parameters:"_invoiceId=".concat(k.invoiceId)})).list||[]).find(e=>e.item.itemId==k.itemId))){V({itemId:null,itemName:null,sku:null}),eV({message:eF.itemNotInReturn});return}let e={id:null==k?void 0:k.id,itemId:null==C?void 0:null===(i=C.item)||void 0===i?void 0:i.itemId,sku:null==C?void 0:null===(n=C.item)||void 0===n?void 0:n.sku,itemName:null==C?void 0:null===(a=C.item)||void 0===a?void 0:a.itemName,balanceQty:null==C?void 0:C.balanceQty,taxId:null==C?void 0:null===(d=C.item)||void 0===d?void 0:d.taxId,vatPct:parseFloat((null==C?void 0:null===(o=C.item)||void 0===o?void 0:o.vatPct)||0).toFixed(2),vatAmount:parseFloat((null==C?void 0:null===(r=C.item)||void 0===r?void 0:r.vatAmount)||0).toFixed(2),unitPrice:parseFloat((null==C?void 0:null===(s=C.item)||void 0===s?void 0:s.unitPrice)||0).toFixed(3),unitCost:parseFloat((null==C?void 0:null===(u=C.item)||void 0===u?void 0:u.unitCost)||0).toFixed(2),pieces:null==C?void 0:null===(c=C.item)||void 0===c?void 0:c.pieces,mdType:null==C?void 0:null===(v=C.item)||void 0===v?void 0:v.mdType,mdAmount:null==C?void 0:null===(m=C.item)||void 0===m?void 0:m.mdAmount,mdValue:null==C?void 0:null===(p=C.item)||void 0===p?void 0:p.mdValue,pieces:null==C?void 0:null===(y=C.item)||void 0===y?void 0:y.pieces,priceType:null==C?void 0:null===(x=C.item)||void 0===x?void 0:x.priceType,basePrice:null==C?void 0:null===(h=C.item)||void 0===h?void 0:h.basePrice,baseLaborPrice:null==C?void 0:null===(f=C.item)||void 0===f?void 0:f.baseLaborPrice,weight:null==C?void 0:null===(F=C.item)||void 0===F?void 0:F.weight,volume:null==C?void 0:null===(b=C.item)||void 0===b?void 0:b.volume,isMetal:(null==C?void 0:null===(P=C.item)||void 0===P?void 0:P.isMetal)||!1,metalid:null==C?void 0:null===(A=C.item)||void 0===A?void 0:A.metalId,metalPurity:null==C?void 0:null===(g=C.item)||void 0===g?void 0:g.metalPurity};V(e),e4(V,e,D.bT);return}let[j,T,Z]=await Promise.all([e5(k.itemId),e9(k.itemId),e7(k.itemId,V)]),R=await eU(null==T?void 0:T.msId),O=eL.values.taxId||T.taxId;if(O){let e=await e8(O);w=O,N=e.map(e=>({taxId:O,taxCodeId:e.taxCodeId,taxBase:e.taxBase,amount:e.amount}))}V({itemId:null==k?void 0:k.itemId,sku:null==k?void 0:k.sku,itemName:null==k?void 0:k.itemName,balanceQty:0,taxId:0,vatPct:0,vatAmount:0,volume:parseFloat(null==j?void 0:j.volume)||0,weight:parseFloat((null==j?void 0:j.weight)||0).toFixed(2),basePrice:(null==j?void 0:j.isMetal)?((null==j?void 0:j.metalPurity)||0)>0?eL.values.postMetalToFinancials?0:(eL.values.KGMetalPrice||0*((null==j?void 0:j.metalPurity)||0))/1e3:0:null==Z?void 0:Z.basePrice,unitPrice:parseFloat((null==Z?void 0:Z.unitPrice)||0).toFixed(3),unitCost:0,upo:parseFloat((null==Z?void 0:Z.upo)||0).toFixed(2),priceType:(null==Z?void 0:Z.priceType)||1,baseLaborPrice:0,TotPricePerG:eL.values.postMetalToFinancials?0:(eL.values.KGMetalPrice||0)*((null==j?void 0:j.metalPurity)||0)/1e3,isMetal:(null==j?void 0:j.isMetal)||!1,metalId:(null==j?void 0:j.metalId)||null,metalPurity:(null==j?void 0:j.metalPurity)||0,mdAmount:eL.values.clientDiscount||0,qty:0,pieces:0,msId:null==T?void 0:T.msId,extendedPrice:parseFloat("0").toFixed(2),mdValue:0,taxId:w,taxDetails:N||null,mdType:1,siteId:null==eL?void 0:null===(l=eL.values)||void 0===l?void 0:l.siteId,siteRef:await lm(null==eL?void 0:null===(t=eL.values)||void 0===t?void 0:t.siteId),trackBy:null==k?void 0:k.trackBy,decimals:(null==R?void 0:R.decimals)||0})},propsReducer(e){let{row:l,props:t}=e;return{...t,readOnly:l.itemId&&l.invoiceId}}},{component:"textfield",label:eF.itemName,name:"itemName",flex:3,props:{readOnly:!0}},{component:"numberfield",label:eF.qty,name:"returnNowQty",updateOn:"blur",props:{onCondition:e=>({decimalScale:null==e?void 0:e.decimals})},onChange(e){let{row:{update:l,newRow:t}}=e,{returnNowQty:i,balanceQty:n,invoiceId:a}=t,d=a&&Number(i)>Number(n)?n:i;l({returnNowQty:d}),e4(l,{...t,returnNowQty:d},D.bT),a&&Number(i)>Number(n)&&eV({message:eF.invalidQty})}},{component:"button",name:"serialLotButton",label:eF.serialsLots,props:{onCondition:e=>1==e.trackBy?{imgSrc:t(64581).Z.src,hidden:!1}:2==e.trackBy?{imgSrc:t(91970).default.src,hidden:!1}:{imgSrc:"",hidden:!0}},onClick:(e,l,t,i)=>{(null==l?void 0:l.trackBy)==1&&eN({Component:K.u,props:{labels:eF,disabled:eW,row:{...l,qty:l.returnNowQty},siteId:null,maxAccess:eD,checkForSiteId:l.qty<0,updateRow:i}})}},{component:"numberfield",label:eF.weight,name:"weight",props:{readOnly:!0}},{component:"numberfield",label:eF.totalWeight,name:"totalWeight",props:{readOnly:!0}},{component:"numberfield",label:eF.volume,name:"volume",props:{readOnly:!0}},{component:"numberfield",label:eF.unitPrice,name:"unitPrice",props:{decimalScale:5},updateOn:"blur",async onChange(e){let{row:{update:l,newRow:t}}=e;e4(l,t,D.Xf)}},{component:"numberfield",label:eF.basePrice,name:"basePrice",props:{decimalScale:5},updateOn:"blur",async onChange(e){let{row:{update:l,newRow:t}}=e;e4(l,t,D.yO)}},{component:"numberfield",label:eF.baseLaborPrice,name:"baseLaborPrice",updateOn:"blur",async onChange(e){let{row:{update:l,newRow:t}}=e;e4(l,t,D.tV)}},{component:"numberfield",label:eF.vat,name:"vatAmount",props:{readOnly:!0}},{component:"button",name:"taxDetailsButton",props:{onCondition:e=>e.itemId&&e.taxId?{imgSrc:t(54022).default.src,hidden:!1}:{imgSrc:"",hidden:!0}},label:eF.tax,onClick:(e,l)=>{let t=Number(eL.values.metalPrice)||0,i=Number(l.metalPurity)||0;eN({Component:B.Z,props:{taxId:null==l?void 0:l.taxId,obj:{...l,basePrice:0!==t?t*i:0}}})}},{component:"numberfield",label:eF.markdown,name:"mdAmount",updateOn:"blur",flex:2,props:{ShowDiscountIcons:!0,iconsClicked:eJ,type:"numeric",iconKey:e=>{let{value:l,data:t}=e;return((null==l?void 0:l.mdType)||(null==t?void 0:t.mdType))===D.Xo?"%":"123"}},async onChange(e){let{row:{update:l,newRow:t}}=e;e4(l,t,D.On),function(e,l){let t=e.unitPrice*(eL.values.maxDiscount/100);if(eL.values.maxDiscount){var i;1==e.mdType?e.mdAmount>eL.values.maxDiscount&&(i=eL.values.maxDiscount,parseFloat(e.mdAmount)>i&&(eL.setFieldValue("mdAmount",i),e.mdAmount=i,e4(l,e,D.On),eV({message:eF.clientMaxPctDiscount+" "+i+"%"}))):e.mdAmount>t&&e.mdAmount>t&&(eL.setFieldValue("mdType",2),eL.setFieldValue("mdAmount",t),e.mdType=2,e.mdAmount=t,e4(l,e,D.On),eV({message:eF.clientMaxDiscount+" "+t}))}}(t,l)}},{component:"numberfield",label:eF.extendedPrice,name:"extendedPrice",async onChange(e){let{row:{update:l,newRow:t}}=e;e4(l,t,D.bh)}}].filter(Boolean);async function eJ(e){let l,{updateRow:t,value:i,data:n}=e,a=((null==i?void 0:i.mdType)||(null==n?void 0:n.mdType))===D.Xo?D.RD:D.Xo,d=(l=parseFloat(null==i?void 0:i.mdAmount)||0,a===D.Xo?(l<0||l>100)&&(l=0):l<0&&(l=0),l);t({id:n.id,changes:{mdAmount:d,mdAmountPct:a,mdType:a},commitOnBlur:!0})}async function eK(){eN({Component:O.Z,props:{functionId:x.J.ReturnOnInvoice,recordId:eL.values.recordId}})}let e$=async()=>{var e;return(null==eG?void 0:null===(e=eG.current)||void 0===e?void 0:e.filter(e=>e.metalId).map(e=>({qty:e.qty,metalRef:"",metalId:e.metalId,metalPurity:e.metalPurity,weight:e.weight,priceType:e.priceType})))||[]};async function eX(){let e={...eL.values};delete e.items,await ew({extension:I.P.ReturnOnInvoice.post,record:JSON.stringify(e)}),r.ZP.success(ek.Posted),lu(eL.values.recordId),e_()}async function eY(){await ew({extension:I.P.ReturnOnInvoice.unpost,record:JSON.stringify({recordId:eL.values.recordId})}),lu(eL.values.recordId),r.ZP.success(ek.Unposted),e_()}async function eH(){let e={...eL.values,isVerified:!eL.values.isVerified};delete e.items,await ew({extension:I.P.ReturnOnInvoice.verify,record:JSON.stringify(e)}),r.ZP.success(eL.values.isVerified?ek.Unverfied:ek.Verified),lu(eL.values.recordId),e_()}let e0=[{key:"Verify",condition:!eL.values.isVerified,onClick:eH,disabled:eL.values.isVerified||!eE||!eW},{key:"Unverify",condition:eL.values.isVerified,onClick:eH,disabled:!eL.values.isVerified},{key:"Metals",condition:!0,onClick:"onClickMetal",handleMetalClick:e$},{key:"Aging",condition:!0,onClick:"onClickAging",disabled:!eE},{key:"IV",condition:!0,onClick:"onInventoryTransaction",disabled:!eE||!eW},{key:"SA Trx",condition:!0,onClick:"onClickSATRX",disabled:!eE},{key:"FI Trx",condition:!0,onClick:"onClickIT",disabled:!eE},{key:"RecordRemarks",condition:!0,onClick:"onRecordRemarks",disabled:!eE},{key:"GL",condition:!0,onClick:"onClickGL",valuesPath:{...eL.values,notes:eL.values.description},datasetId:u.i.GLReturnOnInvoice,disabled:!eE},{key:"WorkFlow",condition:!0,onClick:eK,disabled:!eE},{key:"Locked",condition:eW,onClick:"onUnpostConfirmation",onSuccess:eY,disabled:!eE||eL.values.isVerified},{key:"Unlocked",condition:!eW,onClick:eX,disabled:!eE}];async function e1(e,l,t,i,n){var a,d,o,r,s,u,c,v,m;let p=await e6(null==e?void 0:null===(a=e.record)||void 0===a?void 0:a.billAddressId),y=(n||[]).map((e,l)=>({...e,id:l+1}));(null==e?void 0:null===(d=e.record)||void 0===d?void 0:d.tdType)==1||(null==e?void 0:null===(o=e.record)||void 0===o?void 0:o.tdType)==null?eT({text:"123",value:1}):eT({text:"%",value:2});let x=(null==l?void 0:l.list.length)!=0?await Promise.all(null===(r=l.list)||void 0===r?void 0:r.map(async(l,t)=>{var i;let n=(null==e?void 0:null===(i=e.record)||void 0===i?void 0:i.isVattable)?await e8(l.taxId):null;return{...l,id:t+1,basePrice:parseFloat(l.basePrice).toFixed(5),unitPrice:parseFloat(l.unitPrice).toFixed(3),upo:parseFloat(l.upo).toFixed(2),vatAmount:parseFloat(l.vatAmount).toFixed(2),extendedPrice:parseFloat(l.extendedPrice).toFixed(2),returnNowQty:parseFloat(l.qty).toFixed(2),taxDetails:n,serials:null==y?void 0:y.filter(e=>e.seqNo==l.seqNo),totalWeight:(parseFloat(l.weight||0)*parseFloat(l.qty||0)).toFixed(2),isEditMode:!0}})):eL.values.items;eG.current=x,eL.setValues({...e.record,currentDiscount:(null==e?void 0:null===(s=e.record)||void 0===s?void 0:s.tdType)==1||(null==e?void 0:null===(u=e.record)||void 0===u?void 0:u.tdType)==null?null==e?void 0:null===(c=e.record)||void 0===c?void 0:c.tdAmount:null==e?void 0:null===(v=e.record)||void 0===v?void 0:v.tdPct,amount:parseFloat(null==e?void 0:null===(m=e.record)||void 0===m?void 0:m.amount).toFixed(2),billAddress:p||"",commitItems:null==t?void 0:t.commitItems,isDefaultDtPresent:null==t?void 0:t.dtId,clientDiscount:i.tdPct||0,maxDiscount:i.tdPct||0,items:x})}async function e2(e){var l;let t=await eg({extension:I.P.ReturnOnInvoice.get,parameters:"_recordId=".concat(e)});return t.record.date=(0,F.a1)(null==t?void 0:null===(l=t.record)||void 0===l?void 0:l.date),t}async function e3(e){return await eg({extension:I.P.ReturnItem.qry,parameters:"_returnId=".concat(e)})}async function e6(e){var l;if(!e)return;let t=await eg({extension:V.r.Address.format,parameters:"_addressId=".concat(e)});return null==t?void 0:null===(l=t.record)||void 0===l?void 0:l.formattedAddress.replace(/(\r\n|\r|\n)+/g,"\r\n")}async function e5(e){let l=await eg({extension:k.$.ItemPhysProp.get,parameters:"_itemId=".concat(e)});return null==l?void 0:l.record}async function e9(e){let l=await eg({extension:k.$.Item.get,parameters:"_recordId=".concat(e)});return null==l?void 0:l.record}async function e8(e){if(!e)return;let l=await eg({extension:Z.H.TaxDetailPack.qry,parameters:"_taxId=".concat(e)});return null==l?void 0:l.list}async function e7(e){if(!e)return;let l=await eg({extension:I.P.ItemConvertPrice.get,parameters:"_itemId=".concat(e,"&_clientId=").concat(eL.values.clientId,"&_currencyId=").concat(eL.values.currencyId,"&_plId=").concat(eL.values.plId||eQ,"&_muId=0")});return null==l?void 0:l.record}function e4(e,l,t,i){var n,a;eZ||eR(!0);let d=(0,D.Ch)({priceType:(null==l?void 0:l.priceType)||0,basePrice:parseFloat(null==l?void 0:l.basePrice)||0,volume:parseFloat(null==l?void 0:l.volume),weight:parseFloat(null==l?void 0:l.weight),unitPrice:parseFloat((null==l?void 0:l.unitPrice)||0),upo:parseFloat(null==l?void 0:l.upo)?parseFloat(null==l?void 0:l.upo):0,qty:parseFloat(null==l?void 0:l.returnNowQty),extendedPrice:parseFloat(null==l?void 0:l.extendedPrice),mdAmount:parseFloat(null==l?void 0:l.mdAmount)||0,mdType:null==l?void 0:l.mdType,baseLaborPrice:parseFloat(l.baseLaborPrice||0),totalWeightPerG:0,mdValue:parseFloat(null==l?void 0:l.mdValue),tdPct:(null==eL?void 0:null===(n=eL.values)||void 0===n?void 0:n.tdPct)||0,dirtyField:t}),o=(0,S.VW)({priceType:null==d?void 0:d.priceType,basePrice:null==d?void 0:d.basePrice,qty:null==d?void 0:d.qty,weight:null==d?void 0:d.weight,extendedPrice:parseFloat(null==d?void 0:d.extendedPrice),baseLaborPrice:null==d?void 0:d.baseLaborPrice,vatAmount:parseFloat(null==d?void 0:d.vatAmount),tdPct:null==eL?void 0:null===(a=eL.values)||void 0===a?void 0:a.tdPct,taxDetails:eL.values.isVattable?l.taxDetails:null}),r={id:null==l?void 0:l.id,qty:parseFloat(null==d?void 0:d.qty).toFixed(2),volume:parseFloat(null==d?void 0:d.volume).toFixed(2),weight:parseFloat(null==d?void 0:d.weight).toFixed(2),basePrice:parseFloat(null==d?void 0:d.basePrice).toFixed(5),unitPrice:parseFloat(null==d?void 0:d.unitPrice).toFixed(3),extendedPrice:parseFloat(null==d?void 0:d.extendedPrice).toFixed(2),upo:parseFloat(null==d?void 0:d.upo).toFixed(2),mdValue:null==d?void 0:d.mdValue,mdType:null==d?void 0:d.mdType,mdAmount:parseFloat(null==d?void 0:d.mdAmount).toFixed(2),vatAmount:parseFloat(null==o?void 0:o.vatAmount).toFixed(2)};e({...i?{changes:r}:r,totalWeight:parseFloat(null==l?void 0:l.weight).toFixed(2)*parseFloat(null==l?void 0:l.returnNowQty).toFixed(2)})}let le=null===(H=eL.values.items)||void 0===H?void 0:H.filter(e=>void 0!==e.itemId).map(e=>({...e,qty:parseFloat(e.returnNowQty)||0,basePrice:parseFloat(e.basePrice)||0,unitPrice:parseFloat(e.unitPrice)||0,upo:parseFloat(e.upo)||0,vatAmount:parseFloat(e.vatAmount)||0,weight:parseFloat(e.weight)||0,volume:parseFloat(e.volume)||0,extendedPrice:parseFloat(e.extendedPrice)||0})),ll=(0,_.Ww)(le),lt=0==eL.values.miscAmount?0:parseFloat(eL.values.miscAmount),li=(0,_.Ot)(le,{totalQty:0,totalWeight:0,totalVolume:0,totalUpo:0,sumVat:0,sumExtended:parseFloat(ll),tdAmount:parseFloat(eL.values.tdAmount),net:0,miscAmount:lt}),ln=eZ?null==li?void 0:li.totalQty.toFixed(2):(null===(ee=eL.values)||void 0===ee?void 0:ee.qty)||0,la=eZ?null==li?void 0:li.net.toFixed(2):(null===(el=eL.values)||void 0===el?void 0:el.amount)||0,ld=eZ?ll.toFixed(2):(null===(et=eL.values)||void 0===et?void 0:et.subtotal)||0,lo=eZ?null==li?void 0:li.sumVat.toFixed(2):(null===(ei=eL.values)||void 0===ei?void 0:ei.vatAmount)||0;function lr(e,l,t,i){!function(e,l,t,i){var n;let a=(0,_.Yi)({tdAmount:parseFloat(i),tdPlain:1==e,tdPct:2==e,tdType:e,subtotal:parseFloat(ld),currentDiscount:i,hiddenTdPct:l,hiddenTdAmount:parseFloat(t),typeChange:e});eL.setFieldValue("tdAmount",(null==a?void 0:a.hiddenTdAmount)?null==a?void 0:null===(n=a.hiddenTdAmount)||void 0===n?void 0:n.toFixed(2):0),eL.setFieldValue("tdType",null==a?void 0:a.tdType),eL.setFieldValue("currentDiscount",(null==a?void 0:a.currentDiscount)||0),eL.setFieldValue("tdPct",null==a?void 0:a.hiddenTdPct)}(e,l,t,i),eL.values.items.map((e,t)=>{let i=(0,S.VW)({priceType:null==e?void 0:e.priceType,basePrice:parseFloat(null==e?void 0:e.basePrice),qty:null==e?void 0:e.qty,weight:null==e?void 0:e.weight,extendedPrice:parseFloat(null==e?void 0:e.extendedPrice),baseLaborPrice:parseFloat(null==e?void 0:e.baseLaborPrice),vatAmount:parseFloat(null==e?void 0:e.vatAmount),tdPct:l,taxDetails:eL.values.isVattable?e.taxDetails:null});eL.setFieldValue("items[".concat(t,"].vatAmount"),parseFloat(null==i?void 0:i.vatAmount).toFixed(2))})}async function ls(e){if(e)return(await eg({extension:I.P.Client.get,parameters:"_recordId=".concat(e)})).record}async function lu(e){let l=await e2(e),t=await e3(e),i=await lp(l.record.dtId),n=await ls(l.record.clientId),a=await lc(e);await e1(l,t,i,n,null==a?void 0:a.list)}async function lc(e){return await eg({extension:I.P.ReturnSerial.qry,parameters:"_returnId=".concat(e,"&_seqNo=0")})}function lv(e){Object.entries(e).forEach(e=>{let[l,t]=e;eL.setFieldValue(l,t)})}async function lm(e){var l;if(!e)return;let t=await eg({extension:k.$.Site.get,parameters:"_recordId=".concat(e)});return null==t?void 0:null===(l=t.record)||void 0===l?void 0:l.reference}async function lp(e){var l,t,i,n,a,d,o;if(!e)return;eL.setFieldValue("KGmetalPrice",eL.values.hiddenkgMetalPrice),eL.setFieldValue("defaultBaseMC",eL.values.hiddenkgMetalPrice),eL.setFieldValue("metalPrice",eL.values.hiddenkgMetalPrice?eL.values.hiddenkgMetalPrice/1e3:0);let r=await eg({extension:I.P.DocumentTypeDefault.get,parameters:"_dtId=".concat(e)});eL.setFieldValue("plantId",(null==r?void 0:null===(l=r.record)||void 0===l?void 0:l.plantId)||null);let s=await eM(null==r?void 0:null===(t=r.record)||void 0===t?void 0:t.spId);return eL.setFieldValue("spId",s),eL.setFieldValue("postMetalToFinancials",null==r?void 0:null===(i=r.record)||void 0===i?void 0:i.postMetalToFinancials),eL.setFieldValue("commitItems",null==r?void 0:null===(n=r.record)||void 0===n?void 0:n.commitItems),eL.setFieldValue("isDefaultDtPresent",null==r?void 0:null===(a=r.record)||void 0===a?void 0:a.dtId),eL.setFieldValue("siteId",(null==r?void 0:null===(d=r.record)||void 0===d?void 0:d.siteId)||null),(null==r?void 0:null===(o=r.record)||void 0===o?void 0:o.commitItems)||eL.setFieldValue("siteId",null),null==r?void 0:r.record}async function ly(){var e,l;let t=null==eC?void 0:null===(e=eC.list)||void 0===e?void 0:e.find(e=>{let{key:l}=e;return"baseMetalCuId"===l}),i=null==eC?void 0:null===(l=eC.list)||void 0===l?void 0:l.find(e=>{let{key:l}=e;return"mc_defaultRTSA"===l});if(eL.setFieldValue("baseMetalCuId",parseInt(null==t?void 0:t.value)),!i.value){eV({message:eF.RTSANoteDefined});return}let n=await lx(null==t?void 0:t.value);eL.setFieldValue("hiddenkgMetalPrice",n||0)}async function lx(e){var l;if(!e)return;let t=await eg({extension:W.q.Currency.get,parameters:"_currencyId=".concat(e,"&_date=").concat((0,F.Uf)(eL.values.date),"&_rateDivision=").concat(G.B.SALES)});return(null==t?void 0:null===(l=t.record)||void 0===l?void 0:l.exRate)*1e3}async function lI(){if(Object.keys(await eL.validateForm()).length){let e=Object.keys(await eL.validateForm()).reduce((e,l)=>(eL.touched[l]||(e[l]=!0),e),{});Object.keys(e).length&&eL.setTouched(e,!0)}}async function lh(e){Object.entries(e).forEach(e=>{let[l,t]=e;eL.setFieldValue(l,t)})}return(0,n.useEffect)(()=>{eL.setFieldValue("qty",parseFloat(ln).toFixed(2)),eL.setFieldValue("amount",parseFloat(la).toFixed(2)),eL.setFieldValue("subtotal",parseFloat(ld).toFixed(2)),eL.setFieldValue("vatAmount",parseFloat(lo).toFixed(2))},[ln,la,ld,lo]),(0,n.useEffect)(()=>{if(eZ){let e=parseFloat(eL.values.tdPct)*parseFloat(ld)/100;lr(eL.values.tdType,eL.values.tdPct,e,eL.values.currentDiscount)}},[ld]),(0,n.useEffect)(()=>{var e,l;(null===(e=eL.values)||void 0===e?void 0:e.dtId)&&!eP&&lp(null===(l=eL.values)||void 0===l?void 0:l.dtId)},[null===(en=eL.values)||void 0===en?void 0:en.dtId]),(0,n.useEffect)(()=>{!async function(){eP?await lu(eP):(await ly(),eq?(eT({text:"%",value:2}),eL.setFieldValue("tdType",2)):(eT({text:"123",value:1}),eL.setFieldValue("tdType",1)),eL.setFieldValue("plId",parseInt(eQ)))}()},[]),(0,i.jsx)(A.Z,{resourceId:u.i.ReturnOnInvoice,functionId:x.J.SalesReturn,form:eL,isSavedClear:!1,maxAccess:eD,previewReport:eE,actions:e0,editMode:eE,disabledSubmit:eW,children:(0,i.jsxs)(c.R,{children:[(0,i.jsx)(v.g,{children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:V.r.DocumentType.qry,parameters:"_startAt=0&_pageSize=1000&_dgId=".concat(x.J.SalesReturn),name:"dtId",label:eF.docType,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:eE,valueField:"recordId",displayField:["reference","name"],values:eL.values,maxAccess:eD,onChange:(e,l)=>{eL.setFieldValue("dtId",(null==l?void 0:l.recordId)||null),eS(l)},error:eL.touched.dtId&&!!eL.errors.dtId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(g.Z,{name:"reference",label:eF.reference,value:null==eL?void 0:null===(ea=eL.values)||void 0===ea?void 0:ea.reference,maxAccess:!eE&&eD,readOnly:eE,onChange:eL.handleChange,onClear:()=>eL.setFieldValue("reference",""),error:eL.touched.reference&&!!eL.errors.reference})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(C.U,{endpointId:I.P.Client.snapshot,valueField:"reference",displayField:"name",secondFieldLabel:eF.name,name:"clientId",label:eF.client,form:eL,readOnly:eW||(null==eL?void 0:null===(eo=eL.values)||void 0===eo?void 0:null===(ed=eo.items)||void 0===ed?void 0:ed.some(e=>e.itemId)),displayFieldWidth:4,valueShow:"clientRef",secondValueShow:"clientName",maxAccess:eD,required:!eL.values.dpId,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"},{key:"flName",value:"FlName"},{key:"keywords",value:"Keywords"},{key:"cgName",value:"Client Group"}],onChange:async(e,l)=>{eL.setFieldValue("clientId",(null==l?void 0:l.recordId)||null),eL.setFieldValue("clientName",null==l?void 0:l.name),eL.setFieldValue("clientRef",null==l?void 0:l.reference),eL.setFieldValue("isVattable",(null==l?void 0:l.isSubjectToVAT)||!1),eL.setFieldValue("taxId",null==l?void 0:l.taxId),eL.setFieldValue("maxDiscount",null==l?void 0:l.maxDiscount),eL.setFieldValue("clientDiscount",null==l?void 0:l.tdPct),eL.setFieldValue("plId",null==l?void 0:l.plId),eL.setFieldValue("currencyId",null==l?void 0:l.currencyId),eL.setFieldValue("billAddId",(null==l?void 0:l.billAddressId)||"");let t=await e6((null==l?void 0:l.billAddressId)||"");eL.setFieldValue("billAddress",t||""),(null==l?void 0:l.recordId)||eL.setFieldValue("invoiceId",null)},errorCheck:"clientId"})}),!eE&&(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:eL.values.clientId&&eL.values.date&&I.P.ReturnOnInvoice.balance,parameters:"_clientId=".concat(eL.values.clientId,"&_returnDate=").concat(null==eL?void 0:null===(es=eL.values)||void 0===es?void 0:null===(er=es.date)||void 0===er?void 0:er.toISOString().split("T")[0],"T00:00:00"),name:"invoiceId",label:eF.invoice,valueField:"recordId",displayField:"reference",maxAccess:eD,readOnly:eE||eL.values.items.some(e=>e.itemId),values:eL.values,onChange:async(e,l)=>{eL.setFieldValue("invoiceId",(null==l?void 0:l.recordId)||null),eL.setFieldValue("invoiceRef",(null==l?void 0:l.reference)||""),eL.setFieldValue("contactId",(null==l?void 0:l.contactId)||null),eL.setFieldValue("currencyId",(null==l?void 0:l.currencyId)||null),eL.setFieldValue("exRate",null==l?void 0:l.exRate),eL.setFieldValue("rateCalcMethod",null==l?void 0:l.rateCalcMethod),eL.setFieldValue("plantId",(null==l?void 0:l.plantId)||null);let t=await eM(null==l?void 0:l.spId);eL.setFieldValue("spId",t),eL.setFieldValue("szId",(null==l?void 0:l.szId)||null),eL.setFieldValue("isVattable",null==l?void 0:l.isVattable),eL.setFieldValue("tdType",(null==l?void 0:l.tdType)||1),eL.setFieldValue("tdAmount",null==l?void 0:l.tdAmount)},error:eL.touched.invoiceId&&!!eL.errors.invoiceId})}),eE&&(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(g.Z,{name:"invoiceRef",label:eF.invoice,value:null==eL?void 0:null===(eu=eL.values)||void 0===eu?void 0:eu.invoiceRef,readOnly:!0})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"KGmetalPrice",maxAccess:eD,label:eF.metalPrice,value:eL.values.KGmetalPrice,onChange:e=>{let l=Number(e.target.value.replace(/,/g,""));eL.setFieldValue("KGmetalPrice",l),eL.setFieldValue("metalPrice",l/1e3)},readOnly:!eL.values.baseMetalCuId||eW,hidden:eW||!eE&&!eL.values.baseMetalCuId||!eE&&!eL.values.dtId,onClear:()=>eL.setFieldValue("KGmetalPrice",""),error:(null===(ec=eL.touched)||void 0===ec?void 0:ec.KGmetalPrice)&&!!(null===(ev=eL.errors)||void 0===ev?void 0:ev.KGmetalPrice)})})]})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:V.r.Plant.qry,name:"plantId",label:eF.plant,readOnly:eW,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:eL.values,valueField:"recordId",displayField:["reference","name"],maxAccess:eD,onChange:(e,l)=>{eL.setFieldValue("plantId",(null==l?void 0:l.recordId)||null)},error:eL.touched.plantId&&!!eL.errors.plantId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:V.r.Currency.qry,name:"currencyId",label:eF.currency,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],required:!0,readOnly:eW,values:eL.values,maxAccess:eD,onChange:(e,l)=>{eL.setFieldValue("items",[{id:1}]),eL.setFieldValue("currencyId",(null==l?void 0:l.recordId)||null)},error:eL.touched.currencyId&&!!eL.errors.currencyId})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsx)(E.Z,{onClick:()=>{eN({Component:U.Z,props:{formValues:eL.values,onSubmit:e=>lh(e)}})},image:"popup.png",disabled:!(eE&&!eW&&eL.values.clientId),tooltipText:ek.editClient})}),(0,i.jsx)(b.ZP,{item:!0,xs:9,children:(0,i.jsx)(M.Z,{name:"isVattable",value:null===(em=eL.values)||void 0===em?void 0:em.isVattable,onChange:e=>eL.setFieldValue("isVattable",e.target.checked),label:eF.vat,disabled:!0,maxAccess:eD})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(E.Z,{onClick:()=>{eN({Component:J,props:{form:eL,maxAccess:eD,labels:eF,setReCal:eR},width:900,height:550,title:eF.invoice})},tooltipText:ek.import,image:"import.png",disabled:!eL.values.clientId||!eL.values.invoiceId})})]})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:I.P.SalesPerson.qry,name:"spId",label:eF.salesPerson,columnsInDropDown:[{key:"spRef",value:"Reference"},{key:"name",value:"Name"}],filter:eE?void 0:e=>!e.isInactive,readOnly:eW,valueField:"recordId",displayField:"name",maxAccess:eD,values:eL.values,displayFieldWidth:1.5,onChange:(e,l)=>{eL.setFieldValue("spId",(null==l?void 0:l.recordId)||null)},error:eL.touched.spId&&!!eL.errors.spId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(f.Z,{name:"date",required:!0,label:eF.date,value:null==eL?void 0:null===(ep=eL.values)||void 0===ep?void 0:ep.date,onChange:eL.setFieldValue,readOnly:eW,maxAccess:eD,onClear:()=>eL.setFieldValue("date",null),error:eL.touched.date&&!!eL.errors.date})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:Z.H.TaxSchedules.qry,name:"taxId",label:eF.tax,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:!0,values:eL.values,onChange:(e,l)=>{eL.setFieldValue("taxId",(null==l?void 0:l.recordId)||null)},error:eL.touched.taxId&&!!eL.errors.taxId,maxAccess:eD})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:I.P.ReturnReasons.qry,name:"returnReasonId",label:eF.reason,valueField:"recordId",displayField:"name",readOnly:eW,values:eL.values,maxAccess:eD,onChange:(e,l)=>{eL.setFieldValue("returnReasonId",(null==l?void 0:l.recordId)||null)},error:eL.touched.returnReasonId&&!!eL.errors.returnReasonId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:eL.values.clientId&&L.F.MasterData.qry,parameters:"_clientId=".concat(eL.values.clientId,"&_params=&_startAt=0&_pageSize=1000&_sortBy=recordId"),name:"contactId",label:eF.contact,valueField:"recordId",displayField:["reference","name"],columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],readOnly:!0,values:eL.values,maxAccess:eD,onChange:(e,l)=>{eL.setFieldValue("contactId",(null==l?void 0:l.recordId)||null)},error:eL.touched.contactId&&!!eL.errors.contactId})})]})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:I.P.SalesZone.qry,parameters:'_startAt=0&_pageSize=1000&_sortField="recordId"&_filter=',name:"szId",label:eF.salesZone,valueField:"recordId",maxAccess:eD,displayField:"name",readOnly:eW,values:eL.values,onChange:(e,l)=>{eL.setFieldValue("szId",(null==l?void 0:l.recordId)||null)},error:eL.touched.szId&&!!eL.errors.szId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(N.Z,{endpointId:k.$.Site.qry,name:"siteId",readOnly:(!!eW||!!eL.values.isDefaultDtPresent)&&(null==eL?void 0:null===(ey=eL.values)||void 0===ey?void 0:ey.dtId)&&!(null==eL?void 0:null===(ex=eL.values)||void 0===ex?void 0:ex.commitItems),label:eF.sites,columnsInDropDown:[{key:"reference",value:"Reference"},{key:"name",value:"Name"}],values:eL.values,valueField:"recordId",displayField:["reference","name"],maxAccess:eD,required:!eL.values.isDefaultDtPresent||!(null==eL?void 0:null===(eI=eL.values)||void 0===eI?void 0:eI.dtId)||(null==eL?void 0:null===(eh=eL.values)||void 0===eh?void 0:eh.dtId)&&(null==eL?void 0:null===(ef=eL.values)||void 0===ef?void 0:ef.commitItems),onChange:(e,l)=>{eL.setFieldValue("siteRef",(null==l?void 0:l.reference)||""),eL.setFieldValue("siteName",(null==l?void 0:l.name)||""),eL.setFieldValue("siteId",(null==l?void 0:l.recordId)||null)},error:eL.touched.siteId&&!!eL.errors.siteId})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(w.Z,{name:"billAddress",label:eF.billTo,value:eL.values.billAddress,rows:3,maxLength:"100",readOnly:!eL.values.clientId||eW,maxAccess:eD,viewDropDown:eL.values.clientId&&!eW,onChange:e=>eL.setFieldValue("billAddress",e.target.value),onClear:()=>{eL.setFieldValue("billAddressId",null),eL.setFieldValue("billAddress","")},onDropDown:()=>{var e;eN({Component:q.Z,props:{maxAccess:eD,labels:eF,bill:!0,checkedAddressId:null===(e=eL.values)||void 0===e?void 0:e.billAddId,form:eL.values,handleAddressValues:lv}})},error:(null==eL?void 0:eL.touched.billAddress)&&!!(null==eL?void 0:eL.errors.billAddress)})})]})})]})}),(0,i.jsx)(m.Q,{children:(0,i.jsx)(j._,{onChange:(e,l)=>{eL.setFieldValue("items",e),eG.current=e,"delete"===l&&eR(!0)},value:eL.values.items,error:eL.errors.items,columns:ez,name:"items",maxAccess:eD,disabled:!eL.values.clientId||eL.values.invoiceId||eW,allowDelete:!eW&&!eL.values.invoiceId,onValidationRequired:lI})}),(0,i.jsx)(v.g,{children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,sx:{pt:2},children:[(0,i.jsx)(b.ZP,{item:!0,xs:6,children:(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(w.Z,{name:"description",label:eF.description,value:eL.values.description,rows:3,readOnly:eW,maxAccess:eD,onChange:e=>eL.setFieldValue("description",e.target.value),onClear:()=>eL.setFieldValue("description",""),error:eL.touched.description&&!!eL.errors.description})})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsx)(b.ZP,{container:!0,spacing:2,children:(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"totalQTY",label:eF.totalQty,value:ln,readOnly:!0})})})}),(0,i.jsx)(b.ZP,{item:!0,xs:3,children:(0,i.jsxs)(b.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"subTotal",maxAccess:eD,label:eF.subtotal,value:ld,readOnly:!0})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"discount",maxAccess:eD,label:eF.discount,value:eL.values.currentDiscount,displayCycleButton:!0,readOnly:eW,isPercentIcon:"%"===ej.text,cycleButtonLabel:ej.text,decimalScale:2,handleButtonClick:()=>{let e,l,t;eR(!0),1==ej.value?(e=parseFloat(l=eL.values.currentDiscount<0||eL.values.currentDiscount>100?0:eL.values.currentDiscount)*parseFloat(ld)/100,t=l,eL.setFieldValue("tdAmount",e),eL.setFieldValue("tdPct",l),eL.setFieldValue("currentDiscount",l)):(l=parseFloat(e=eL.values.currentDiscount<0||ld<eL.values.currentDiscount?0:eL.values.currentDiscount)/parseFloat(ld)*100,t=e,eL.setFieldValue("tdPct",l),eL.setFieldValue("tdAmount",e),eL.setFieldValue("currentDiscount",e)),eT(i=>{let n="%"===i.text?{text:"123",value:1}:{text:"%",value:2};return eL.setFieldValue("tdType",n.value),lr(n.value,l,e,t),n})},ShowDiscountIcons:!0,iconKey:ej.text,onChange:e=>{let l=Number(e.target.value.replace(/,/g,""));1==eL.values.tdType?((l<0||parseInt(ld)<l)&&(l=0),eL.setFieldValue("tdAmount",l)):((l<0||l>100)&&(l=0),eL.setFieldValue("tdPct",l)),eL.setFieldValue("currentDiscount",l)},onBlur:async e=>{eR(!0);let l=Number(e.target.value.replace(/,/g,"")),t=Number(e.target.value.replace(/,/g,"")),i=Number(e.target.value.replace(/,/g,""));1==eL.values.tdType&&(t=parseFloat(l)/parseFloat(ld)*100,eL.setFieldValue("tdPct",t)),2==eL.values.tdType&&(i=parseFloat(l)*parseFloat(ld)/100,eL.setFieldValue("tdAmount",i)),lr(eL.values.tdType,t,i,l)},onClear:()=>{eL.setFieldValue("tdAmount",0),eL.setFieldValue("tdPct",0),lr(eL.values.tdType,0,0,0)}})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"vatAmount",maxAccess:eD,label:eF.vat,value:lo,readOnly:!0})}),(0,i.jsx)(b.ZP,{item:!0,xs:12,children:(0,i.jsx)(T.Z,{name:"amount",maxAccess:eD,label:eF.amount,value:la,readOnly:!0})})]})})]})})]})})}var X=()=>{let{postRequest:e,getRequest:l}=(0,n.useContext)(d.$),{platformLabels:t}=(0,n.useContext)(p.l),{stack:f}=(0,s.zY)(),{query:{data:F},filterBy:b,refetch:P,labels:A,access:g,paginationParameters:w,invalidate:N}=(0,a.J)({queryFn:k,endpointId:I.P.ReturnOnInvoice.page,datasetId:u.i.ReturnOnInvoice,filter:{filterFn:C}}),V=[{field:"reference",headerName:A.reference,flex:1},{field:"dtName",headerName:A.docType,flex:1},{field:"date",headerName:A.date,flex:1,type:"date"},{field:"invoiceRef",headerName:A.invoice,flex:1},{field:"clientRef",headerName:A.client,flex:1},{field:"clientName",headerName:A.clientName,flex:1},{field:"currencyRef",headerName:A.currency,flex:1},{field:"amount",headerName:A.amount,flex:1,type:"number"},{field:"pcs",headerName:A.pcs,flex:1,type:"number"},{field:"qty",headerName:A.totalQty,flex:1,type:"number"},{field:"statusName",headerName:A.status,flex:1},{field:"isVerified",headerName:A.isVerified,type:"checkbox"}];async function k(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{_startAt:t=0,_pageSize:i=50,params:n=[]}=e;return{...await l({extension:I.P.ReturnOnInvoice.page,parameters:"_startAt=".concat(t,"&_pageSize=").concat(i,"&_sortBy=recordId desc&_params=").concat(n,"&filter=")}),_startAt:t}}async function C(e){let{filters:t,pagination:i}=e;return t.qry?await l({extension:I.P.ReturnOnInvoice.snapshot,parameters:"_filter=".concat(t.qry)}):k({_startAt:i._startAt||0,params:null==t?void 0:t.params})}let{proxyAction:j}=(0,y.G)({functionId:x.J.ReturnOnInvoice,action:Z}),T=async()=>{j()};async function Z(e){f({Component:$,props:{labels:A,access:g,recordId:e},width:1300,height:730,title:A.returnOnInvoice})}let R=async l=>{await e({extension:I.P.ReturnOnInvoice.del,record:JSON.stringify(l)}),N(),r.ZP.success(t.Deleted)};return(0,i.jsxs)(c.R,{children:[(0,i.jsx)(v.g,{children:(0,i.jsx)(h.Z,{onAdd:T,maxAccess:g,filterBy:b,reportName:"SARET"})}),(0,i.jsx)(m.Q,{children:(0,i.jsx)(o.Z,{name:"table",columns:V,gridData:F,rowId:["recordId"],onEdit:e=>{Z(null==e?void 0:e.recordId)},refetch:P,onDelete:R,deleteConfirmationType:"strict",isLoading:!1,pageSize:50,maxAccess:g,paginationParameters:w,paginationType:"api"})})]})}},85572:function(e,l,t){"use strict";t.d(l,{u:function(){return g}});var i=t(52322),n=t(31389),a=t(62362),d=t(26612),o=t(60218),r=t(8661),s=t(80983),u=t(48601),c=t(71987),v=t(2784),m=t(65950),p=t(91406),y=t(27423),x=t(65215),I=t(76399),h=t(33625),f=t(96026),F=t(19473),b=t(51235),P=t(21326),A=t(54074);let g=e=>{var l,t,g,w,N,V;let{row:k,siteId:C,checkForSiteId:j,window:T,updateRow:Z,disabled:R}=e,{getRequest:O}=(0,v.useContext)(m.$),{stack:D}=(0,f.V)(),{platformLabels:S,systemChecks:_}=(0,v.useContext)(F.l),q=_.some(e=>e.checkId===b.F.ALLOW_INVENTORY_NEGATIVE_QTY),Q=(null==_?void 0:null===(l=_.find(e=>e.checkId===b.F.POS_JUMP_TO_NEXT_LINE))||void 0===l?void 0:l.value)||!1,{labels:M,maxAccess:B}=(0,c.J)({datasetId:d.i.Serial});(0,P.Z)({title:S.serials,window:T});let{formik:L}=(0,s.c)({maxAccess:B,initialValues:{sku:null==k?void 0:k.sku,itemName:null==k?void 0:k.itemName,itemId:null==k?void 0:k.itemId,siteId:C,totalWeight:(null==k?void 0:k.qty)||0,pieces:null,items:(null==k?void 0:k.serials)||[]},validateOnChange:!0,validationSchema:u.Ry({items:u.IX().of(u.Ry({srlNo:u.Z_().test(function(e){var l,t,i;return(null===(i=this.options.from[1])||void 0===i?void 0:null===(t=i.value)||void 0===t?void 0:null===(l=t.items)||void 0===l?void 0:l.length)===1||!!e})}))}),onSubmit:async e=>{let l=e.items.filter(e=>null==e?void 0:e.srlNo).map((e,l)=>({...e,id:l+1,srlSeqNo:l+1,srlNo:e.srlNo,seqNo:k.id}));Z({changes:{serials:l,...(null==k?void 0:k.hasOwnProperty("serialCount"))&&{serialCount:(null==l?void 0:l.length)||0}}}),T.close()}}),E=L.values.items.reduce((e,l)=>e+(parseFloat(l.weight)||0),0),W=L.values.totalWeight-E||0,G=[{component:"textfield",name:"srlNo",label:M.serialNo,jumpToNextLine:Q,updateOn:"blur",onChange:async e=>{let{row:{update:l,newRow:t,oldRow:i,addRow:n}}=e;t.srlNo!==(null==i?void 0:i.srlNo)&&await J(t,l,n)}},{component:"numberfield",name:"weight",label:M.weight,props:{readOnly:!0}}],U=e=>{let l=L.values.items.map(l=>l.id===e?{...l,srlNo:"",weight:""}:l);L.setFieldValue("items",l)},z=e=>{let l=L.values.items.filter(l=>l.id!==e);0===l.length&&(l=[{id:0,srlNo:"",weight:""}]),L.setFieldValue("items",l)},J=async(e,l,t)=>{let{srlNo:i,id:n}=e;if(i){var a;let d=await O({extension:x.$.Serial.get,parameters:"_srlNo=".concat(i)});d.record?(null==d?void 0:null===(a=d.record)||void 0===a?void 0:a.itemId)!==(null==k?void 0:k.itemId)?(D({message:S.serialDoesNotBelongItem}),U(n)):j&&!q&&L.values.siteId?(await O({extension:x.$.AvailabilitySerial.get,parameters:"_srlNo=".concat(i,"&_siteId=").concat(L.values.siteId)})).record?(l({weight:d.record.weight}),t({fieldName:"srlNo",changes:{id:e.id,srlNo:e.srlNo,weight:d.record.weight}})):(D({message:M.invalidSerial}),U(n)):(l({weight:d.record.weight}),t({fieldName:"srlNo",changes:{id:e.id,srlNo:e.srlNo,weight:d.record.weight}})):(D({message:S.unknownSerial}),z(n))}},K=[{key:"Ok",condition:!0,onClick:()=>L.handleSubmit(),disabled:R}];return(0,i.jsx)(A.Z,{onSave:L.handleSubmit,isSaved:!1,actions:K,maxAccess:B,children:(0,i.jsxs)(n.R,{children:[(0,i.jsx)(h.g,{children:(0,i.jsxs)(o.ZP,{container:!0,spacing:2,children:[(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(y.U,{endpointId:x.$.Item.snapshot,name:"itemId",label:null==M?void 0:M.sku,valueField:"recordId",displayField:"sku",valueShow:"sku",secondValueShow:"itemName",form:L,readOnly:!0})}),(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(r.Z,{endpointId:x.$.Site.qry,name:"siteId",label:M.site,values:L.values,valueField:"recordId",displayField:["reference","name"],maxAccess:B,readOnly:!0})}),(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(p.Z,{name:"totalWeight",label:M.totalWeight,maxAccess:B,value:L.values.totalWeight,readOnly:!0})}),(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(p.Z,{name:"weightAssigned",label:M.weightAssigned,maxAccess:B,value:E,readOnly:!0})}),(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(p.Z,{name:"balanceWeight",label:M.balanceWeight,maxAccess:B,value:W,readOnly:!0})}),(0,i.jsx)(o.ZP,{item:!0,xs:12,children:(0,i.jsx)(p.Z,{name:"pieces",label:M.pieces,maxAccess:B,value:null==L?void 0:null===(w=L.values)||void 0===w?void 0:null===(g=w.items)||void 0===g?void 0:null===(t=g.filter(e=>void 0!==e.srlNo))||void 0===t?void 0:t.length,readOnly:!0})})]})}),(0,i.jsx)(a.Q,{children:(0,i.jsx)(I._,{onChange:e=>L.setFieldValue("items",e),value:null===(N=L.values)||void 0===N?void 0:N.items,error:null===(V=L.errors)||void 0===V?void 0:V.items,name:"items",columns:G,maxAccess:B,disabled:R,allowDelete:!R,allowAddNewLine:!R})})]})})};g.width=500,g.height=700}},function(e){e.O(0,[92515,2494,36908,23352,53491,49774,92888,40179],function(){return e(e.s=50316)}),_N_E=e.O()}]);